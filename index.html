<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Informe Audio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #ef4444;
      --primary-dark: #991b1b;
      --bg-main: #f3f4f6;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      display: flex;
      min-height: 100vh;
    }

    /* SIDEBAR -------------------------------------------------------- */
    .sidebar {
      width: 220px;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 12px 14px;
      border-bottom: 1px solid #111827;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-circle {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: var(--primary);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:14px;
      color:#020617;
    }
    .sidebar-title { display:flex; flex-direction:column; }
    .sidebar-title span:first-child {
      font-size:14px;
      font-weight:600;
    }
    .sidebar-title span:last-child {
      font-size:11px;
      color:#9ca3af;
      text-transform:uppercase;
      letter-spacing:0.04em;
    }
    .sidebar-nav { padding:8px 6px; flex:1; }
    .nav-section-title {
      font-size:11px;
      text-transform:uppercase;
      color:#6b7280;
      padding:4px 10px;
    }
    .nav-item {
      display:flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      margin:2px 2px;
      color:#e5e7eb;
      border:1px solid transparent;
    }
    .nav-item span.icon { font-size:15px; }
    .nav-item.active {
      background:var(--primary);
      border-color:var(--primary-dark);
      color:#111827;
    }
    .nav-item.active span.icon { filter:brightness(0.1); }
    .nav-item:hover:not(.active) {
      background:#020617;
      border-color:#1e293b;
    }
    .sidebar-footer {
      padding:8px 12px;
      border-top:1px solid #111827;
      font-size:11px;
      color:#6b7280;
    }

    /* MAIN ----------------------------------------------------------- */
    .main {
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .main-header {
      padding:8px 16px;
      border-bottom:1px solid var(--border);
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .main-header-left { display:flex; flex-direction:column; gap:2px; }
    .main-title { font-size:18px; font-weight:600; }
    .main-subtitle { font-size:12px; color:var(--text-muted); }
    .main-header-actions {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn {
      border-radius:999px;
      border:1px solid #d1d5db;
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
      background:#ffffff;
      color:#111827;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .btn-sm{ padding:3px 9px; }
    .btn-primary {
      background:var(--primary);
      border-color:var(--primary);
      color:#f9fafb;
    }
    .btn-primary:hover{ filter:brightness(1.05); }
    .btn-outline{
      background:#f9fafb;
    }
    .btn-outline:hover{ background:#e5e7eb; }
    .btn-icon{
      width:26px;
      height:26px;
      padding:0;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
    }
    .main-content{
      padding:10px 14px 16px;
      overflow:auto;
      flex:1;
    }

    .card{
      background:var(--bg-card);
      border-radius:12px;
      border:1px solid var(--border);
      box-shadow:0 1px 2px rgba(15,23,42,0.04);
      padding:8px 10px 10px;
      margin-bottom:10px;
    }

    /* FALD√ìN SOLO EN INFORME ---------------------------------------- */
    .faldon {
      display:flex;
      align-items:center;
      border-radius:10px;
      overflow:hidden;
      margin-bottom:6px;
    }
    .faldon-left{
      background:var(--primary);
      color:#111827;
      padding:6px 10px;
      font-weight:700;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      min-width:130px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .faldon-right{
      flex:1;
      background:#020617;
      color:#e5e7eb;
      padding:5px 10px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:2px;
    }
    .faldon-title{
      font-size:13px;
      font-weight:600;
    }
    .faldon-subtitle{
      font-size:11px;
      color:#9ca3af;
    }

    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
      gap:4px;
      flex-wrap:wrap;
    }
    .card-title{ font-size:13px; font-weight:600; }
    .card-subtitle{ font-size:11px; color:var(--text-muted); }
    .badge{
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      color:var(--text-muted);
    }
    .text-muted{ color:var(--text-muted); font-size:11px; }

    input[type="file"]{ display:none; }

    /* M√ìDULO CENTROS ------------------------------------------------ */
    .dashboard-top{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.1fr);
      gap:8px;
    }
    .mini-kpi, .mini-calendar{
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px 8px;
      background:#ffffff;
    }
    .mini-kpi-title{
      font-size:12px;
      font-weight:600;
      margin-bottom:4px;
    }
    .mini-kpi-sub{
      font-size:11px;
      color:var(--text-muted);
      margin-bottom:4px;
    }
    #kpiCentrosCanvas{
      width:100%;
      height:120px;
      display:block;
    }

    .calendar-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:#e5e7eb;
      margin-bottom:4px;
      background:#020617;
      border-radius:6px 6px 0 0;
      padding:4px 6px;
    }
    .calendar-header button{
      border:none;
      background:transparent;
      color:#e5e7eb;
      cursor:pointer;
      font-size:13px;
      padding:2px 4px;
      border-radius:4px;
    }
    .calendar-header button:hover{
      background:#111827;
    }
    .calendar-month-label{
      font-weight:600;
      text-transform:capitalize;
    }
    .calendar-shell{
      border-radius:6px;
      overflow:hidden;
      border:1px solid #020617;
      background:#020617;
    }
    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7,minmax(0,1fr));
      gap:1px;
      background:#020617;
      padding:2px;
    }
    .calendar-day-header{
      text-align:center;
      font-size:9px;
      color:#9ca3af;
      padding-bottom:2px;
    }
    .calendar-cell{
      min-height:22px;
      border-radius:3px;
      border:1px solid #111827;
      padding:1px 2px;
      font-size:9px;
      background:#020617;
      color:#e5e7eb;
      display:flex;
      flex-direction:column;
    }
    .calendar-cell-pend{
      background:linear-gradient(135deg,rgba(248,153,57,0.35),#020617);
      border-color:#f97316;
    }
    .calendar-cell-real{
      background:linear-gradient(135deg,rgba(34,197,94,0.3),#020617);
      border-color:#22c55e;
    }
    .calendar-cell-anulada{
      background:linear-gradient(135deg,rgba(239,68,68,0.4),#020617);
      border-color:#ef4444;
    }
    .calendar-day-number{
      font-size:9px;
      font-weight:600;
    }
    .calendar-visits{
      margin-top:1px;
      display:flex;
      flex-direction:column;
      gap:1px;
    }
    .calendar-visit-row{
      display:flex;
      align-items:center;
      gap:3px;
      font-size:8px;
    }
    .calendar-visit-init{ font-weight:600; }
    .calendar-dot-status{
      width:6px;
      height:6px;
      border-radius:999px;
    }
    .calendar-dot-pendiente{ background:#f97316; }
    .calendar-dot-realizada{ background:#22c55e; }
    .calendar-dot-anulada{ background:#ef4444; }
    .calendar-legend{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      font-size:9px;
      color:var(--text-muted);
    }
    .calendar-legend-item{
      display:flex;
      align-items:center;
      gap:3px;
    }
    .calendar-dot{
      width:8px;
      height:8px;
      border-radius:999px;
    }

    .filter-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-bottom:4px;
      flex-wrap:wrap;
    }
    .input-text{
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      flex:1;
      box-shadow:0 0 0 1px #e5e7eb inset;
    }
    .input-text:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 1px var(--primary) inset;
      background:#ffffff;
    }

    .table-wrapper{ overflow-x:auto; }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:10px;
      table-layout:fixed;
      min-width:900px;
    }
    th,td{
      padding:4px 6px;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    thead th{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:var(--text-muted);
      background:#f9fafb;
    }
    tbody tr:hover{ background:#f3f4f6; }

    .col-codigo{ min-width:60px; color:var(--primary); font-weight:700; }
    .col-prop{ min-width:140px; }
    .col-centro{ min-width:180px; font-weight:600; }
    .col-prov{ min-width:100px; }
    .col-del{ min-width:150px; }
    .col-tip{ min-width:90px; }
    .col-aar{ min-width:120px; }
    .col-visita{ min-width:150px; }
    .col-inf{ min-width:80px; text-align:center; }
    .col-aud{ min-width:110px; }
    .col-hor{ min-width:60px; }
    .col-resp{ min-width:130px; }

    .pill-tip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--primary-dark);
      background:#020617;
      color:#fee2e2;
      font-size:9px;
    }

    .visita-cell{
      display:flex;
      align-items:center;
      gap:3px;
    }
    .btn-visita{
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#ffffff;
      font-size:9px;
      padding:2px 6px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-visita span.icon-cal{ font-size:11px; }
    .btn-visita:hover{ background:#f3f4f6; }
    .visita-guardada{ background:#fffbeb; }
    .visita-anulada{ background:#fee2e2; }

    .cell-input{
      width:100%;
      border-radius:6px;
      border:1px solid transparent;
      font-size:10px;
      padding:2px 4px;
      background:transparent;
    }
    .cell-input:focus{
      outline:none;
      border-color:var(--primary);
      background:#f9fafb;
    }

    .select-mini{
      width:100%;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:9px;
      padding:1px 4px;
      background:#ffffff;
    }

    .btn-crear{
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background:var(--primary);
      color:#f9fafb;
    }

    /* M√ìDULO INFORME ----------------------------------------------- */

    #modInforme{ display:none; }

    .informe-encabezado-grid{
      display:grid;
      grid-template-columns:repeat(5,minmax(0,1fr));
      gap:4px 6px;
      margin-bottom:6px;
      font-size:11px;
    }
    .meta-label{
      font-size:9px;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:0.05em;
      margin-bottom:1px;
    }
    .meta-input,.meta-select{
      width:100%;
      font-size:11px;
      border-radius:999px;
      border:1px solid #d1d5db;
      padding:3px 7px;
      background:#f9fafb;
    }
    .meta-input[readonly]{ background:#f3f4f6; }
    .meta-input:focus,.meta-select:focus{
      outline:none;
      border-color:var(--primary);
      background:#ffffff;
    }

    .tipo-visita-row{
      display:flex;
      align-items:center;
      gap:4px;
      margin-bottom:4px;
      font-size:11px;
    }
    .pill-toggle{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      font-size:10px;
      cursor:pointer;
      color:var(--text-muted);
    }
    .pill-toggle.active{
      background:var(--primary);
      border-color:var(--primary);
      color:#f9fafb;
    }

    .informe-centro-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:4px 6px;
      margin-bottom:6px;
    }
    .informe-centro-item-label{
      font-size:9px;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    .informe-centro-item-value{
      font-size:11px;
      font-weight:500;
    }

    .informe-section{
      margin-top:4px;
      padding-top:5px;
      border-top:1px dashed #d1d5db;
    }
    .informe-section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      margin-bottom:4px;
    }
    .informe-section-title{
      font-size:12px;
      font-weight:600;
    }

    .chart-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:6px;
    }
    .chart-card-inner{
      border-radius:10px;
      border:1px solid var(--border);
      background:#ffffff;
      padding:4px 6px 4px;
      height:150px;
      display:flex;
      flex-direction:column;
    }
    .chart-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:11px;
      margin-bottom:2px;
    }
    .chart-tag{
      font-size:9px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid #d1d5db;
      color:var(--text-muted);
      background:#f9fafb;
    }
    .chart-wrapper{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .chart-wrapper canvas{
      max-width:100%;
      max-height:120px;
    }

    .img-row{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:6px;
      margin-bottom:4px;
    }
    .img-card{
      border-radius:10px;
      border:1px solid var(--border);
      background:#ffffff;
      padding:4px 4px 6px;
      font-size:11px;
      display:flex;
      flex-direction:column;
      gap:3px;
      height:150px;
    }
    .img-title{
      font-size:11px;
      font-weight:600;
    }
    .img-subtitle{
      font-size:10px;
      color:var(--text-muted);
    }
    .img-zone{
      flex:1;
      border-radius:8px;
      border:1px dashed #d1d5db;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#f9fafb;
    }
    .img-zone img{
      width:100%;
      height:100%;
      object-fit:cover;
      cursor:zoom-in;
    }
    .img-actions{
      display:flex;
      justify-content:flex-end;
    }

    .textarea-base{
      width:100%;
      min-height:60px;
      border-radius:8px;
      border:1px solid #d1d5db;
      padding:4px 6px;
      font-size:11px;
      resize:vertical;
      font-family:inherit;
      background:#f9fafb;
    }
    .textarea-base:focus{
      outline:none;
      border-color:var(--primary);
      background:#ffffff;
    }

    .obs-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
    }
    .obs-card{
      border-radius:10px;
      border:1px solid var(--border);
      background:#ffffff;
      padding:4px 6px;
    }
    .obs-title{ font-size:11px; font-weight:600; margin-bottom:2px; }

    .informe-actions{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:6px;
    }

    #informeEmpty{
      font-size:11px;
      color:var(--text-muted);
      padding:4px 2px;
    }

    /* MODAL HIST√ìRICO / VISITA -------------------------------------- */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.85);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal-card{
      background:#020617;
      border-radius:10px;
      padding:8px 9px;
      max-width:720px;
      width:90%;
      max-height:80vh;
      overflow:auto;
      border:1px solid #1e293b;
      color:#e5e7eb;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:5px;
    }
    .modal-title{ font-size:14px; font-weight:600; }
    .modal-body{ font-size:11px; }
    .historico-item{
      border-radius:8px;
      border:1px solid #1e293b;
      padding:5px 6px;
      margin-bottom:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .historico-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .historico-tag{
      font-size:10px;
      color:#9ca3af;
    }

    .visita-modal-card{
      background:#ffffff;
      color:#111827;
      border-radius:10px;
      padding:8px 10px;
      max-width:360px;
      width:90%;
      border:1px solid #d1d5db;
    }
    .visita-modal-header{
      font-size:13px;
      font-weight:600;
      margin-bottom:4px;
    }
    .visita-modal-sub{
      font-size:11px;
      color:#6b7280;
      margin-bottom:4px;
    }
    .visita-modal-row{
      margin-bottom:6px;
      font-size:11px;
    }
    .visita-modal-row input[type="date"]{
      width:100%;
      border-radius:999px;
      border:1px solid #d1d5db;
      padding:3px 7px;
      font-size:11px;
    }
    .visita-modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:4px;
    }
    .btn-danger{
      background:#ef4444;
      border-color:#ef4444;
      color:#f9fafb;
    }
    .btn-amber{
      background:#f97316;
      border-color:#f97316;
      color:#111827;
    }

    /* ZOOM IMAGEN --------------------------------------------------- */
    .img-zoom-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.9);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .img-zoom-overlay img{
      max-width:90%;
      max-height:90%;
      border-radius:10px;
    }

    /* TEMA OSCURO (pantalla) ---------------------------------------- */
    body.dark {
      --bg-main:#020617;
      --bg-card:#020617;
      --border:#1f2937;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;
    }
    body.dark .card,
    body.dark .mini-kpi,
    body.dark .mini-calendar{
      background:#020617;
      border-color:#1f2937;
      box-shadow:none;
    }
    body.dark .main-header{
      background:#020617;
      border-color:#111827;
    }
    body.dark .input-text,
    body.dark .meta-input,
    body.dark .meta-select,
    body.dark .textarea-base,
    body.dark .cell-input,
    body.dark .select-mini{
      background:#020617;
      border-color:#1f2937;
      color:#e5e7eb;
    }
    body.dark thead th{
      background:#020617;
      border-color:#1f2937;
    }
    body.dark tbody tr:hover{ background:#020617; }
    body.dark .btn-outline{
      background:#020617;
      border-color:#1f2937;
      color:#e5e7eb;
    }
    body.dark .btn-primary{ color:#020617; }
    body.dark .mini-calendar{ border-color:#111827; }

    /* IMPRESI√ìN: SOLO INFORME -------------------------------------- */
    @media print {
      body { background:#ffffff; color:#000; }
      .sidebar,
      .main-header,
      #modCentros,
      #historicoModal,
      #visitaModal,
      #imgZoomOverlay { display:none !important; }
      .main{ flex:none; width:100%; }
      .main-content{ padding:0; }
      .card{
        background:#ffffff;
        border-color:#d1d5db;
        box-shadow:none;
      }
    }

    @media (max-width:900px){
      .sidebar{ display:none; }
      .dashboard-top{ grid-template-columns:minmax(0,1fr); }
      .chart-grid{ grid-template-columns:minmax(0,1fr); }
      .img-row{ grid-template-columns:repeat(2,minmax(0,1fr)); }
      .obs-grid{ grid-template-columns:minmax(0,1fr); }
      .informe-encabezado-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
      .informe-centro-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle">IA</div>
      <div class="sidebar-title">
        <span>Informe Audio</span>
        <span>Gesti√≥n de visitas</span>
      </div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-title">M√≥dulos</div>
      <div class="nav-item active" id="navCentros">
        <span class="icon">üè¨</span><span>Centros y delegados</span>
      </div>
      <div class="nav-item" id="navInforme">
        <span class="icon">üìù</span><span>Informe de visita</span>
      </div>
      <div class="nav-item" id="navHistorico">
        <span class="icon">üìÜ</span><span>Hist√≥rico visitas</span>
      </div>
    </div>
    <div class="sidebar-footer">
      Informe Audio ¬∑ Demo<br/>
      Datos guardados en este navegador.
    </div>
  </aside>

  <main class="main">
    <header class="main-header">
      <div class="main-header-left">
        <div class="main-title" id="mainTitle">Centros y delegados</div>
        <div class="main-subtitle" id="mainSubtitle">
          Visi√≥n general, calendario y tabla tipo Excel. Alimenta todos los informes.
        </div>
      </div>
      <div class="main-header-actions">
        <label class="btn btn-outline btn-sm" for="excelInput">üì• Cargar Excel centros</label>
        <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" />
        <button class="btn btn-primary btn-sm" id="btnExport">‚¨áÔ∏è Exportar estado</button>
        <button class="btn btn-icon btn-outline" id="btnTheme" title="Modo claro / oscuro">üåô</button>
        <button class="btn btn-icon btn-outline" id="btnReset" title="Borrar estado">üóëÔ∏è</button>
      </div>
    </header>

    <section class="main-content">

      <!-- M√ìDULO CENTROS --------------------------------------------- -->
      <section id="modCentros">
        <section class="card" id="cardVisionGeneral">
          <div class="card-header">
            <div>
              <div class="card-title">Centros y delegados</div>
              <div class="card-subtitle">Visi√≥n general y calendario de visitas.</div>
            </div>
          </div>

          <div class="dashboard-top">
            <div class="mini-kpi">
              <div class="mini-kpi-title">Resumen de centros</div>
              <div class="mini-kpi-sub">
                Total de centros, visitas pendientes y visitas anuladas.
              </div>
              <canvas id="kpiCentrosCanvas"></canvas>
            </div>
            <div class="mini-calendar">
              <div class="calendar-shell">
                <div class="calendar-header">
                  <button id="calPrevMonth" title="Mes anterior">‚óÄ</button>
                  <span class="calendar-month-label" id="calendarMonthLabel">Mes actual</span>
                  <button id="calNextMonth" title="Mes siguiente">‚ñ∂</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
              </div>
              <div class="calendar-legend">
                <div class="calendar-legend-item">
                  <span class="calendar-dot" style="background:#f97316;"></span><span>Pendiente</span>
                </div>
                <div class="calendar-legend-item">
                  <span class="calendar-dot" style="background:#22c55e;"></span><span>Realizada</span>
                </div>
                <div class="calendar-legend-item">
                  <span class="calendar-dot" style="background:#ef4444;"></span><span>Anulada</span>
                </div>
                <div class="calendar-legend-item">
                  <span>A / S = Ariannys / Sonia</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="card" id="cardCentros">
          <div class="card-header">
            <div>
              <div class="card-title">Listado de centros y delegados</div>
              <div class="card-subtitle">
                Programa la visita, marca el estado y crea el informe. Vista compacta tipo Excel.
              </div>
            </div>
            <div class="text-muted">El m√≥dulo de informe se alimenta √∫nicamente de este listado y sus visitas.</div>
          </div>

          <div class="filter-row">
            <input id="searchInput" class="input-text" placeholder="Buscar por c√≥digo, centro, provincia..." />
          </div>

          <div class="table-wrapper">
            <table id="tablaCentros">
              <thead>
              <tr>
                <th class="col-codigo">C√≥digo</th>
                <th class="col-prop">Propietario</th>
                <th class="col-centro">Centro</th>
                <th class="col-prov">Provincia</th>
                <th class="col-del">Delegado</th>
                <th class="col-tip">Tipolog√≠a</th>
                <th class="col-aar">Centro AAR</th>
                <th class="col-visita">Visita</th>
                <th class="col-inf">Informe</th>
                <th class="col-aud">Audiol√≥g@</th>
                <th class="col-hor">Horas</th>
                <th class="col-resp">Resp. Audio</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- M√ìDULO INFORME --------------------------------------------- -->
      <section id="modInforme">
        <section class="card" id="cardInformeVisita">
          <div class="faldon">
            <div class="faldon-left">Informe Audio</div>
            <div class="faldon-right">
              <div class="faldon-title" id="faldonTituloVisita">Informe de visita</div>
              <div class="faldon-subtitle" id="faldonSubVisita">
                Visita: ‚Äî ¬∑ Realizada por: ‚Äî
              </div>
            </div>
          </div>

          <div class="card-header">
            <div>
              <div class="card-title">Informe de visita</div>
              <div class="card-subtitle">
                Se crea desde una visita programada en el m√≥dulo de centros. Dise√±o ejecutivo y compacto.
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
              <span class="badge" id="informeEstadoBadge">Sin centro seleccionado</span>
              <button class="btn btn-outline btn-sm" id="btnImprimirInforme">üñ®Ô∏è Imprimir</button>
            </div>
          </div>

          <div id="informeEmpty">
            Selecciona un centro con el bot√≥n <strong>‚ÄúCrear‚Äù</strong> en el listado o abre un informe desde el hist√≥rico.
          </div>

          <div id="informeContenido" style="display:none;">
            <!-- Encabezado datos -->
            <div class="informe-encabezado-grid">
              <div>
                <div class="meta-label">Centro</div>
                <input id="metaCentro" class="meta-input" readonly />
              </div>
              <div>
                <div class="meta-label">Provincia</div>
                <input id="metaProvincia" class="meta-input" readonly />
              </div>
              <div>
                <div class="meta-label">Delegado</div>
                <input id="metaDelegado" class="meta-input" readonly />
              </div>
              <div>
                <div class="meta-label">Tipolog√≠a</div>
                <input id="metaTipologia" class="meta-input" readonly />
              </div>
              <div>
                <div class="meta-label">Centro AAR</div>
                <input id="metaCentroAAR" class="meta-input" readonly />
              </div>

              <div>
                <div class="meta-label">Fecha visita</div>
                <input id="metaFechaVisita" class="meta-input" readonly />
              </div>
              <div>
                <div class="meta-label">Audiol√≥g@</div>
                <input id="infAudiologo" class="meta-input" />
              </div>
              <div>
                <div class="meta-label">Horas servicio</div>
                <input id="infHorasServicio" class="meta-input" />
              </div>
              <div>
                <div class="meta-label">Delegado formaci√≥n</div>
                <input id="infDelFormacion" class="meta-input" placeholder="Nombre del delegado de formaci√≥n" />
              </div>
              <div>
                <div class="meta-label">Tipo centro checklist</div>
                <select id="metaTipoCentro" class="meta-select">
                  <option value="">Corner o Exclusivo...</option>
                  <option value="CORNER">Corner</option>
                  <option value="EXCLUSIVO">Exclusivo</option>
                </select>
              </div>
            </div>

            <div class="tipo-visita-row">
              <span class="meta-label" style="margin-bottom:0;">Tipo de visita</span>
              <button type="button" id="btnApertura" class="pill-toggle">Apertura</button>
              <button type="button" id="btnSeguimiento" class="pill-toggle">Seguimiento</button>
              <span style="flex:1;"></span>
              <span class="meta-label" style="margin-bottom:0;">Checklist</span>
              <label class="btn btn-outline btn-sm" for="checklistInput">üìé Adjuntar checklist</label>
              <input type="file" id="checklistInput" accept=".xlsx,.xls,.csv" />
            </div>

            <div class="informe-centro-grid">
              <div>
                <div class="informe-centro-item-label">C√≥digo</div>
                <div class="informe-centro-item-value" id="infCodigo"></div>
              </div>
              <div>
                <div class="informe-centro-item-label">Propietario</div>
                <div class="informe-centro-item-value" id="infPropietario"></div>
              </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="informe-section">
              <div class="informe-section-header">
                <div class="informe-section-title">Resultados de la visita</div>
              </div>
              <div class="chart-grid">
                <div class="chart-card-inner">
                  <div class="chart-title-row">
                    <span>Radar de resultados</span>
                    <span class="chart-tag">% visita</span>
                  </div>
                  <div class="chart-wrapper"><canvas id="radarChart"></canvas></div>
                </div>
                <div class="chart-card-inner">
                  <div class="chart-title-row">
                    <span>√Åreas de mejora de procesos</span>
                    <span class="chart-tag">% no aplicados</span>
                  </div>
                  <div class="chart-wrapper"><canvas id="mejoraChart"></canvas></div>
                </div>
                <div class="chart-card-inner">
                  <div class="chart-title-row">
                    <span>KPIs de negocio visita</span>
                    <span class="chart-tag">% visita</span>
                  </div>
                  <div class="chart-wrapper"><canvas id="kpiChart"></canvas></div>
                </div>
              </div>
              <div id="checklistResumen" class="text-muted" style="margin-top:3px;">
                Checklist no adjuntado todav√≠a.
              </div>
            </div>

            <!-- Im√°genes -->
            <div class="informe-section">
              <div class="informe-section-header">
                <div class="informe-section-title">Im√°genes de la visita</div>
              </div>
              <div class="img-row">
                <div class="img-card">
                  <div class="img-title">Exterior</div>
                  <div class="img-subtitle">Escaparate, fachada, visibilidad desde el exterior.</div>
                  <div class="img-zone" id="imgZone1"></div>
                  <div class="img-actions">
                    <label class="btn btn-outline btn-sm" for="imgInput1">üñºÔ∏è Seleccionar</label>
                    <input type="file" id="imgInput1" accept="image/*" />
                  </div>
                </div>
                <div class="img-card">
                  <div class="img-title">Interior</div>
                  <div class="img-subtitle">Recepci√≥n, sala de espera, visibilidad del servicio de audio.</div>
                  <div class="img-zone" id="imgZone2"></div>
                  <div class="img-actions">
                    <label class="btn btn-outline btn-sm" for="imgInput2">üñºÔ∏è Seleccionar</label>
                    <input type="file" id="imgInput2" accept="image/*" />
                  </div>
                </div>
                <div class="img-card">
                  <div class="img-title">Gabinete</div>
                  <div class="img-subtitle">Zona t√©cnica: equipamiento, ergonom√≠a y confort.</div>
                  <div class="img-zone" id="imgZone3"></div>
                  <div class="img-actions">
                    <label class="btn btn-outline btn-sm" for="imgInput3">üñºÔ∏è Seleccionar</label>
                    <input type="file" id="imgInput3" accept="image/*" />
                  </div>
                </div>
                <div class="img-card">
                  <div class="img-title">T√©cnico</div>
                  <div class="img-subtitle">Detalle t√©cnico adicional o segundo √°ngulo de gabinete.</div>
                  <div class="img-zone" id="imgZone4"></div>
                  <div class="img-actions">
                    <label class="btn btn-outline btn-sm" for="imgInput4">üñºÔ∏è Seleccionar</label>
                    <input type="file" id="imgInput4" accept="image/*" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Recomendaciones / Compromisos -->
            <div class="informe-section">
              <div class="obs-grid">
                <div class="obs-card">
                  <div class="obs-title">Recomendaciones</div>
                  <textarea id="informeRecomendaciones" class="textarea-base"
                            placeholder="Recomendaciones de mejora, acciones sugeridas..."></textarea>
                </div>
                <div class="obs-card">
                  <div class="obs-title">Compromisos</div>
                  <textarea id="informeCompromisos" class="textarea-base"
                            placeholder="Compromisos acordados con el centro, plazos y responsables..."></textarea>
                </div>
              </div>
              <div class="informe-actions">
                <button class="btn btn-outline btn-sm" id="btnGuardarBorrador">üíæ Guardar borrador</button>
                <button class="btn btn-primary btn-sm" id="btnGuardarFinal">‚úÖ Guardar y finalizar</button>
              </div>
            </div>
          </div>
        </section>
      </section>

    </section>
  </main>

  <!-- MODAL HIST√ìRICO -->
  <div class="modal-overlay" id="historicoModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="historicoTitulo">Hist√≥rico de visitas e informes</div>
        <button class="btn btn-icon btn-outline" id="historicoCerrar">‚úñÔ∏è</button>
      </div>
      <div class="modal-body" id="historicoLista"></div>
    </div>
  </div>

  <!-- MODAL VISITA -->
  <div class="modal-overlay" id="visitaModal">
    <div class="visita-modal-card">
      <div class="visita-modal-header">Programar / anular visita</div>
      <div class="visita-modal-sub" id="visitaModalCentro">Centro: ‚Äî</div>
      <div class="visita-modal-row">
        <label for="visitaModalFecha" style="font-size:11px;">Fecha de visita</label>
        <input type="date" id="visitaModalFecha" />
      </div>
      <div class="visita-modal-row" style="font-size:10px;color:#6b7280;">
        Elige una fecha y selecciona <strong>Guardar</strong> (pendiente, color √°mbar) o
        <strong>Anular</strong> (rojo, requiere motivo).
      </div>
      <div class="visita-modal-actions">
        <button class="btn btn-outline btn-sm" id="visitaModalCancelar">Cancelar</button>
        <button class="btn btn-danger btn-sm" id="visitaModalAnular">Anular</button>
        <button class="btn btn-amber btn-sm" id="visitaModalGuardar">Guardar</button>
      </div>
    </div>
  </div>

  <!-- ZOOM IMAGEN -->
  <div class="img-zoom-overlay" id="imgZoomOverlay">
    <img id="imgZoomImage" src="" alt="Zoom" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    /* ------------------- UTIL ESTADO --------------------- */
    const STORAGE_KEY = "InformeAudio_v7";

    const demoData = [
      {
        CODIGO:"4DIA",
        PROPIETARIO:"AAO",
        CENTRO:"AVENIDA DIAGONAL",
        PROVINCIA:"BARCELONA",
        DELEGADOS:"ENERITZ ARANGUREN",
        TIPOLOGIA:"C√≥rner",
        CENTRO_AAR:"",
        VISITA:"",
        AUDIOLOGO:"",
        HORAS_SERVICIO:"",
        RESP_AUDIO:"Sonia Guasque",
      },
      {
        CODIGO:"4AXA",
        PROPIETARIO:"VADILLO Pedro",
        CENTRO:"CERDANYOLA",
        PROVINCIA:"BARCELONA",
        DELEGADOS:"LAURA PLAZAS",
        TIPOLOGIA:"C√≥rner",
        CENTRO_AAR:"",
        VISITA:"",
        AUDIOLOGO:"",
        HORAS_SERVICIO:"",
        RESP_AUDIO:"Sonia Guasque",
      },
      {
        CODIGO:"4AES",
        PROPIETARIO:"FRAGUELA Jacobo",
        CENTRO:"AAA NAR√ìN",
        PROVINCIA:"Galicia",
        DELEGADOS:"Daniel Chazo",
        TIPOLOGIA:"C√≥rner",
        CENTRO_AAR:"",
        VISITA:"",
        AUDIOLOGO:"",
        HORAS_SERVICIO:"",
        RESP_AUDIO:"Ariannys Rojas",
      },
      {
        CODIGO:"4ADX",
        PROPIETARIO:"LOPEZ Jose",
        CENTRO:"AGUILAS",
        PROVINCIA:"MURCIA",
        DELEGADOS:"Manuel C√°novas",
        TIPOLOGIA:"C√≥rner",
        CENTRO_AAR:"",
        VISITA:"",
        AUDIOLOGO:"",
        HORAS_SERVICIO:"",
        RESP_AUDIO:"Sonia Guasque",
      },
      {
        CODIGO:"4ARK",
        PROPIETARIO:"BELLOT Sonia",
        CENTRO:"ALAIN AFFLELOU OPTICO CARLET",
        PROVINCIA:"VALENCIA",
        DELEGADOS:"Cecilia P√©rez",
        TIPOLOGIA:"C√≥rner",
        CENTRO_AAR:"",
        VISITA:"",
        AUDIOLOGO:"",
        HORAS_SERVICIO:"",
        RESP_AUDIO:"Sonia Guasque",
      },
    ];

    let centros = [];
    let estado = {};
    let centroSeleccionadoCodigo = null;
    let currentInformeId = null;

    let radarChart = null;
    let mejoraChart = null;
    let kpiChart = null;

    let calendarYear;
    let calendarMonth;
    let visitaModalCodigo = null;

    function cargarEstado(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : {};
      }catch(e){ return {}; }
    }
    function guardarEstado(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(estado));
      }catch(e){}
    }

    function estadoCentroDesdeInformes(informes){
      if(!informes || !informes.length) return "";
      if(informes.some(i=>i.estado==="finalizado")) return "finalizado";
      if(informes.some(i=>i.estado==="borrador")) return "borrador";
      return "";
    }

    function aplicarEstadoALosCentros(){
      centros.forEach(c=>{
        const e = estado[c.CODIGO];
        if(e){
          c.VISITA = e.visita||"";
          c.CENTRO_AAR = e.centroAAR||c.CENTRO_AAR||"";
          c.RESP_AUDIO = e.respAudio||c.RESP_AUDIO||"";
          c.AUDIOLOGO = e.audiologoCentro||c.AUDIOLOGO||"";
          c.HORAS_SERVICIO = e.horasCentro||c.HORAS_SERVICIO||"";
          c.VISITA_ESTADO = e.visitaEstado||"pendiente";
          const infs = e.informes||[];
          c.NUM_INFORMES = infs.length;
          c.INFORME_ESTADO = estadoCentroDesdeInformes(infs);
          const finalizados = infs.filter(i=>i.estado==="finalizado");
          const ultimo = finalizados[finalizados.length-1];
          c.ULTIMO_INFORME_FECHA = ultimo ? (ultimo.fechaVisita||ultimo.fechaFinalizacion) : "";
        }else{
          c.VISITA_ESTADO="pendiente";
          c.NUM_INFORMES=0;
          c.INFORME_ESTADO="";
          c.ULTIMO_INFORME_FECHA="";
        }
      });
    }

    function formatearFechaCorta(iso){
      if(!iso) return "";
      const d = new Date(iso);
      if(isNaN(d.getTime())) return iso;
      return d.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"2-digit"});
    }

    function leerNumeroCelda(sheet, addr){
      const cell = sheet[addr];
      if(!cell) return null;
      let v = cell.v;
      if(v===undefined || v===null) return null;
      v = String(v).replace("%","").replace(",",".");
      const n = parseFloat(v);
      return isNaN(n) ? null : n;
    }
    function boolDesdeCelda(cell){
      if(!cell) return null;
      const v = String(cell.v).trim().toUpperCase();
      if(["1","SI","S√ç","YES"].includes(v)) return true;
      if(["0","NO"].includes(v)) return false;
      return null;
    }

    /* ------------------- TABLA CENTROS --------------------- */

    function renderTabla(filtro=""){
      const tbody = document.querySelector("#tablaCentros tbody");
      tbody.innerHTML="";
      const term = filtro.trim().toLowerCase();

      const filtrados = centros.filter(c=>{
        if(!term) return true;
        const s = `${c.CODIGO} ${c.PROPIETARIO} ${c.CENTRO} ${c.PROVINCIA} ${c.DELEGADOS}`;
        return s.toLowerCase().includes(term);
      });

      if(!filtrados.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan=12;
        td.className="text-muted";
        td.textContent="No hay centros que coincidan con el filtro.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtrados.forEach(c=>{
        const tr = document.createElement("tr");
        tr.dataset.codigo=c.CODIGO;

        const tdCodigo=document.createElement("td");
        tdCodigo.className="col-codigo";
        tdCodigo.textContent=c.CODIGO||"";
        tr.appendChild(tdCodigo);

        const tdProp=document.createElement("td");
        tdProp.className="col-prop";
        tdProp.textContent=c.PROPIETARIO||"";
        tr.appendChild(tdProp);

        const tdCentro=document.createElement("td");
        tdCentro.className="col-centro";
        tdCentro.textContent=c.CENTRO||"";
        tr.appendChild(tdCentro);

        const tdProv=document.createElement("td");
        tdProv.className="col-prov";
        tdProv.textContent=c.PROVINCIA||"";
        tr.appendChild(tdProv);

        const tdDel=document.createElement("td");
        tdDel.className="col-del";
        tdDel.textContent=c.DELEGADOS||"";
        tr.appendChild(tdDel);

        const tdTip=document.createElement("td");
        tdTip.className="col-tip";
        const spanTip=document.createElement("span");
        spanTip.className="pill-tip";
        spanTip.textContent=c.TIPOLOGIA||"";
        tdTip.appendChild(spanTip);
        tr.appendChild(tdTip);

        const tdAar=document.createElement("td");
        tdAar.className="col-aar";
        const selAar=document.createElement("select");
        selAar.className="select-mini";
        selAar.innerHTML='<option value="">‚Äî</option><option value="S√≠">S√≠</option><option value="No">No</option>';
        selAar.value=c.CENTRO_AAR||"";
        selAar.addEventListener("change",()=>{
          const code=c.CODIGO;
          if(!estado[code]) estado[code]={informes:[]};
          estado[code].centroAAR=selAar.value;
          c.CENTRO_AAR=selAar.value;
          guardarEstado();
          if(centroSeleccionadoCodigo===code){
            document.getElementById("metaCentroAAR").value=selAar.value||"";
          }
        });
        tdAar.appendChild(selAar);
        tr.appendChild(tdAar);

        const tdVis=document.createElement("td");
        tdVis.className="col-visita";
        const vDiv=document.createElement("div");
        vDiv.className="visita-cell";
        const btnFecha=document.createElement("button");
        btnFecha.className="btn-visita";
        const fechaTexto=c.VISITA ? formatearFechaCorta(c.VISITA) : "dd/mm/aaaa";
        btnFecha.innerHTML=`<span>${fechaTexto}</span><span class="icon-cal">üìÖ</span>`;
        btnFecha.addEventListener("click",()=>abrirVisitaModal(c.CODIGO));
        vDiv.appendChild(btnFecha);
        tdVis.appendChild(vDiv);
        if(c.VISITA_ESTADO==="anulada") tdVis.classList.add("visita-anulada");
        else if(c.VISITA) tdVis.classList.add("visita-guardada");
        tr.appendChild(tdVis);

        const tdInf=document.createElement("td");
        tdInf.className="col-inf";
        const btnCrear=document.createElement("button");
        btnCrear.className="btn-crear";
        btnCrear.textContent="Crear";
        btnCrear.addEventListener("click",()=>{
          if(!c.VISITA){
            alert("Guarda una fecha de visita antes de crear el informe.");
            return;
          }
          crearInformeParaCentro(c);
        });
        tdInf.appendChild(btnCrear);
        tr.appendChild(tdInf);

        const tdAud=document.createElement("td");
        tdAud.className="col-aud";
        const inputAud=document.createElement("input");
        inputAud.className="cell-input";
        inputAud.value=c.AUDIOLOGO||"";
        inputAud.addEventListener("change",()=>{
          const val=inputAud.value.trim();
          c.AUDIOLOGO=val;
          const code=c.CODIGO;
          if(!estado[code]) estado[code]={informes:[]};
          estado[code].audiologoCentro=val;
          if(estado[code].informes){
            estado[code].informes.forEach(i=>i.audiologo=val);
          }
          guardarEstado();
          if(centroSeleccionadoCodigo===code){
            document.getElementById("infAudiologo").value=val;
          }
        });
        tdAud.appendChild(inputAud);
        tr.appendChild(tdAud);

        const tdHor=document.createElement("td");
        tdHor.className="col-hor";
        const inputHor=document.createElement("input");
        inputHor.className="cell-input";
        inputHor.value=c.HORAS_SERVICIO||"";
        inputHor.addEventListener("change",()=>{
          const val=inputHor.value.trim();
          c.HORAS_SERVICIO=val;
          const code=c.CODIGO;
          if(!estado[code]) estado[code]={informes:[]};
          estado[code].horasCentro=val;
          if(estado[code].informes){
            estado[code].informes.forEach(i=>i.horasServicio=val);
          }
          guardarEstado();
          if(centroSeleccionadoCodigo===c.CODIGO){
            document.getElementById("infHorasServicio").value=val;
          }
        });
        tdHor.appendChild(inputHor);
        tr.appendChild(tdHor);

        const tdResp=document.createElement("td");
        tdResp.className="col-resp";
        const selResp=document.createElement("select");
        selResp.className="select-mini";
        selResp.innerHTML='<option value="">‚Äî</option><option value="Ariannys Rojas">Ariannys Rojas</option><option value="Sonia Guasque">Sonia Guasque</option>';
        selResp.value=c.RESP_AUDIO||"";
        selResp.addEventListener("change",()=>{
          const code=c.CODIGO;
          if(!estado[code]) estado[code]={informes:[]};
          estado[code].respAudio=selResp.value;
          c.RESP_AUDIO=selResp.value;
          guardarEstado();
          if(centroSeleccionadoCodigo===code){
            actualizarFaldonVisita();
          }
          actualizarResumen();
        });
        tdResp.appendChild(selResp);
        tr.appendChild(tdResp);

        tbody.appendChild(tr);
      });
    }

    /* ------------- GR√ÅFICO KPI CENTROS (tipo reloj) --------------- */

    function renderKpiCentros(total, pendientes, anuladas){
      const canvas=document.getElementById("kpiCentrosCanvas");
      if(!canvas) return;
      const ctx=canvas.getContext("2d");
      const w=canvas.width=canvas.clientWidth;
      const h=canvas.height=120;

      ctx.clearRect(0,0,w,h);
      ctx.font="10px system-ui";
      ctx.textAlign="center";
      ctx.textBaseline="middle";

      const gauges=[
        {label:"Centros", value: total, max: total||1, color:"#3b82f6"},
        {label:"Pendientes", value: pendientes, max: total||1, color:"#f97316"},
        {label:"Anuladas", value: anuladas, max: total||1, color:"#ef4444"},
      ];
      const radius=32;
      const cxStart=w/2 - 90;
      const cy=h/2+10;
      const gap=90;

      gauges.forEach((g,idx)=>{
        const cx=cxStart+idx*gap;
        const cyLocal=cy;
        const pct=g.max? g.value/g.max : 0;

        ctx.beginPath();
        ctx.strokeStyle="#e5e7eb";
        ctx.lineWidth=8;
        ctx.arc(cx,cyLocal,radius,Math.PI,0);
        ctx.stroke();

        ctx.beginPath();
        ctx.strokeStyle=g.color;
        ctx.lineWidth=8;
        ctx.arc(cx,cyLocal,radius,Math.PI,Math.PI + Math.PI*pct,false);
        ctx.stroke();

        ctx.fillStyle="#374151";
        ctx.fillText(g.label,cx,cyLocal-radius-10);
        ctx.fillStyle="#111827";
        ctx.fillText(g.value + "/" + g.max,cx,cyLocal+22);
      });
    }

    function obtenerMapaVisitasCalendario(){
      const map={};
      centros.forEach(c=>{
        if(!c.VISITA) return;
        const code=c.CODIGO;
        const e=estado[code]||{};
        let status=e.visitaEstado||"pendiente";
        if(c.INFORME_ESTADO==="finalizado") status="realizada";
        const resp=(estado[code] && estado[code].respAudio)||c.RESP_AUDIO||"";
        const initial=resp ? resp.trim().charAt(0).toUpperCase() : "?";
        const dateStr=c.VISITA;
        if(!map[dateStr]) map[dateStr]=[];
        map[dateStr].push({initial,status});
      });
      return map;
    }

    function actualizarCalendarioVisitas(){
      const grid=document.getElementById("calendarGrid");
      const label=document.getElementById("calendarMonthLabel");
      if(!grid || calendarYear==null || calendarMonth==null) return;
      grid.innerHTML="";

      const visitasMap=obtenerMapaVisitasCalendario();
      const dateForLabel=new Date(calendarYear,calendarMonth,1);
      label.textContent=dateForLabel.toLocaleDateString("es-ES",{month:"long",year:"numeric"});

      const weekdayNames=["L","M","X","J","V","S","D"];

      weekdayNames.forEach(d=>{
        const div=document.createElement("div");
        div.className="calendar-day-header";
        div.textContent=d;
        grid.appendChild(div);
      });

      const firstDay=(new Date(calendarYear,calendarMonth,1).getDay()+6)%7;
      const daysInMonth=new Date(calendarYear,calendarMonth+1,0).getDate();

      for(let i=0;i<firstDay;i++){
        const div=document.createElement("div");
        grid.appendChild(div);
      }

      for(let d=1; d<=daysInMonth; d++){
        const div=document.createElement("div");
        div.className="calendar-cell";
        const dayNum=document.createElement("div");
        dayNum.className="calendar-day-number";
        dayNum.textContent=d;
        div.appendChild(dayNum);

        const visitsDiv=document.createElement("div");
        visitsDiv.className="calendar-visits";
        const dateStr=calendarYear+"-"+String(calendarMonth+1).padStart(2,"0")+"-"+String(d).padStart(2,"0");
        const visits=visitasMap[dateStr]||[];

        let hasPend=false,hasReal=false,hasAnul=false;
        visits.slice(0,3).forEach(v=>{
          if(v.status==="pendiente") hasPend=true;
          else if(v.status==="realizada") hasReal=true;
          else if(v.status==="anulada") hasAnul=true;

          const row=document.createElement("div");
          row.className="calendar-visit-row";
          const initSpan=document.createElement("span");
          initSpan.className="calendar-visit-init";
          initSpan.textContent=v.initial;
          const dot=document.createElement("span");
          dot.className="calendar-dot-status";
          if(v.status==="pendiente") dot.classList.add("calendar-dot-pendiente");
          else if(v.status==="realizada") dot.classList.add("calendar-dot-realizada");
          else if(v.status==="anulada") dot.classList.add("calendar-dot-anulada");
          row.appendChild(initSpan);
          row.appendChild(dot);
          visitsDiv.appendChild(row);
        });

        if(hasAnul) div.classList.add("calendar-cell-anulada");
        else if(hasPend) div.classList.add("calendar-cell-pend");
        else if(hasReal) div.classList.add("calendar-cell-real");

        div.appendChild(visitsDiv);
        grid.appendChild(div);
      }
    }

    function actualizarResumen(){
      const total=centros.length;
      let visitasPendientes=0;
      let visitasAnuladas=0;

      centros.forEach(c=>{
        if(!c.VISITA) return;
        const e=estado[c.CODIGO]||{};
        const visitaEstado=e.visitaEstado||"pendiente";
        const anulada=visitaEstado==="anulada";
        const realizada=c.INFORME_ESTADO==="finalizado";
        if(anulada) visitasAnuladas++;
        else if(!realizada) visitasPendientes++;
      });

      renderKpiCentros(total,visitasPendientes,visitasAnuladas);
      actualizarCalendarioVisitas();
    }

    /* ----------------- CARGA EXCEL CENTROS ----------------- */

    function manejarExcel(file){
      const reader=new FileReader();
      reader.onload=e=>{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:"array"});
        const sheet=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(sheet,{defval:""});
        centros=json.map(row=>({
          CODIGO:row["CODIGO"]||"",
          PROPIETARIO:row["PROPIETARIO"]||"",
          CENTRO:row["CENTRO"]||"",
          PROVINCIA:row["PROVINCIA"]||"",
          DELEGADOS:row["DELEGADOS"]||"",
          TIPOLOGIA:row["Tpolog√≠a"]||row["Tipolog√≠a"]||row["TIPOLOGIA"]||"",
          CENTRO_AAR:row["Centro AAR"]||"",
          VISITA:"",
          AUDIOLOGO:row["Audi√≥logo"]||"",
          HORAS_SERVICIO:row["Horas de servicio"]||"",
          RESP_AUDIO:row["Resp. Audio"]||"",
        }));
        aplicarEstadoALosCentros();
        renderTabla(document.getElementById("searchInput").value);
        actualizarResumen();
      };
      reader.readAsArrayBuffer(file);
    }

    /* ----------------------- INFORME ------------------------ */

    function actualizarTipoVisitaUI(tv){
      const btnA=document.getElementById("btnApertura");
      const btnS=document.getElementById("btnSeguimiento");
      btnA.classList.toggle("active",!!(tv && tv.apertura));
      btnS.classList.toggle("active",!!(tv && tv.seguimiento));
    }
    function leerTipoVisitaDesdeUI(){
      return {
        apertura:document.getElementById("btnApertura").classList.contains("active"),
        seguimiento:document.getElementById("btnSeguimiento").classList.contains("active"),
      };
    }

    function limpiarImagenesYChecklist(){
      ["imgZone1","imgZone2","imgZone3","imgZone4"].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.innerHTML="";
      });
      ["imgInput1","imgInput2","imgInput3","imgInput4","checklistInput"].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.value="";
      });
      document.getElementById("checklistResumen").textContent="Checklist no adjuntado todav√≠a.";
      if(radarChart) radarChart.destroy();
      if(mejoraChart) mejoraChart.destroy();
      if(kpiChart) kpiChart.destroy();
      radarChart=mejoraChart=kpiChart=null;
    }

    function setInformeEditable(editable){
      const ids=[
        "infAudiologo","infHorasServicio","infDelFormacion",
        "metaTipoCentro","checklistInput",
        "imgInput1","imgInput2","imgInput3","imgInput4",
        "informeRecomendaciones","informeCompromisos"
      ];
      ids.forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.disabled=!editable;
      });
      const tvRow=document.querySelector(".tipo-visita-row");
      if(tvRow){
        tvRow.style.pointerEvents=editable?"auto":"none";
        tvRow.style.opacity=editable?"1":"0.6";
      }
      document.getElementById("btnGuardarBorrador").style.display=editable?"inline-flex":"none";
      document.getElementById("btnGuardarFinal").style.display=editable?"inline-flex":"none";
    }

    function actualizarFaldonVisita(){
      const centro=centros.find(c=>c.CODIGO===centroSeleccionadoCodigo);
      const resp=(estado[centroSeleccionadoCodigo] && estado[centroSeleccionadoCodigo].respAudio) || centro?.RESP_AUDIO || "‚Äî";
      const nomCentro=centro? centro.CENTRO : "‚Äî";
      document.getElementById("faldonTituloVisita").textContent="Informe de visita";
      document.getElementById("faldonSubVisita").textContent=`Visita: ${nomCentro||"‚Äî"} ¬∑ Realizada por: ${resp||"‚Äî"}`;
    }

    function cargarCentroEnInforme(codigo,informeId,soloLectura=false){
      const centro=centros.find(c=>c.CODIGO===codigo);
      const badge=document.getElementById("informeEstadoBadge");
      const empty=document.getElementById("informeEmpty");
      const cont=document.getElementById("informeContenido");

      if(!centro){
        badge.textContent="Centro no encontrado";
        empty.style.display="block";
        cont.style.display="none";
        return;
      }

      const e=estado[codigo]||{informes:[]};
      e.informes=e.informes||[];
      let inf=e.informes.find(i=>i.id===informeId);
      if(!inf) inf=e.informes[e.informes.length-1];
      if(!inf){
        badge.textContent="No hay informe para mostrar";
        empty.style.display="block";
        cont.style.display="none";
        return;
      }

      centroSeleccionadoCodigo=codigo;
      currentInformeId=inf.id;
      setActiveModule("informe");

      empty.style.display="none";
      cont.style.display="block";

      document.getElementById("metaCentro").value=centro.CENTRO||"";
      document.getElementById("metaProvincia").value=centro.PROVINCIA||"";
      document.getElementById("metaDelegado").value=centro.DELEGADOS||"";
      document.getElementById("metaTipologia").value=centro.TIPOLOGIA||"";
      document.getElementById("metaCentroAAR").value=centro.CENTRO_AAR||"";
      document.getElementById("metaFechaVisita").value=centro.VISITA||"";
      document.getElementById("metaTipoCentro").value=inf.checklistTipo||"";
      document.getElementById("infCodigo").textContent=centro.CODIGO||"";
      document.getElementById("infPropietario").textContent=centro.PROPIETARIO||"";

      document.getElementById("infAudiologo").value=inf.audiologo || centro.AUDIOLOGO || "";
      document.getElementById("infHorasServicio").value=inf.horasServicio || centro.HORAS_SERVICIO || "";
      document.getElementById("infDelFormacion").value=inf.delegadoFormacion || "";
      document.getElementById("informeRecomendaciones").value=inf.recomendaciones||"";
      document.getElementById("informeCompromisos").value=inf.compromisos||"";
      document.getElementById("checklistResumen").textContent=inf.checklistResumen||"Checklist no adjuntado todav√≠a.";
      actualizarTipoVisitaUI(inf.tipoVisita||{});

      limpiarImagenesYChecklist();
      if(inf.checklistMetrics && inf.checklistDetalles){
        renderChecklistCharts(inf.checklistMetrics,inf.checklistDetalles);
        document.getElementById("checklistResumen").textContent=inf.checklistResumen||"";
      }

      const onlyRead=soloLectura || inf.estado==="finalizado";
      setInformeEditable(!onlyRead);
      badge.textContent=inf.estado==="finalizado" ? "Informe finalizado" : "Informe en edici√≥n";
      actualizarFaldonVisita();
    }

    function crearInformeParaCentro(c){
      if(!c.VISITA){
        alert("Guarda una fecha de visita antes de crear el informe.");
        return;
      }
      const code=c.CODIGO;
      if(!estado[code]) estado[code]={informes:[]};
      const e=estado[code];
      e.informes=e.informes||[];

      const id="INF-"+Date.now().toString();
      const nuevo={
        id,
        fechaCreacion:new Date().toISOString(),
        fechaVisita:c.VISITA||"",
        estado:"borrador",
        audiologo:c.AUDIOLOGO||"",
        horasServicio:c.HORAS_SERVICIO||"",
        delegadoFormacion:"",
        tipoVisita:{apertura:false,seguimiento:false},
        recomendaciones:"",
        compromisos:"",
        checklistResumen:"",
        checklistTipo:null,
        checklistMetrics:null,
        checklistDetalles:null,
      };
      e.informes.push(nuevo);
      guardarEstado();
      aplicarEstadoALosCentros();
      renderTabla(document.getElementById("searchInput").value);
      actualizarResumen();
      cargarCentroEnInforme(code,id,false);
      document.getElementById("infAudiologo").focus();
    }

    /* ---------------- CHECKLIST + GR√ÅFICOS ---------------- */

    function seleccionarHojaProcesos(workbook){
      const names=workbook.SheetNames||[];
      if(!names.length) return null;
      const norm = s => s.toUpperCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      let chosen=null;
      for(const n of names){
        const nn=norm(n);
        if(nn.includes("PROCESOS") && nn.includes("BASICOS")){
          chosen=n; break;
        }
      }
      if(!chosen) chosen=names[0];
      return workbook.Sheets[chosen];
    }

    function renderChecklistCharts(metrics,detalles){
      const radarCtx=document.getElementById("radarChart").getContext("2d");
      const mejoraCtx=document.getElementById("mejoraChart").getContext("2d");
      const kpiCtx=document.getElementById("kpiChart").getContext("2d");

      if(radarChart) radarChart.destroy();
      if(mejoraChart) mejoraChart.destroy();
      if(kpiChart) kpiChart.destroy();

      const aplic=metrics && metrics.aplicProc!=null ? metrics.aplicProc : 0;
      const convP=metrics && metrics.convPrueba!=null ? metrics.convPrueba : 0;
      const convV=metrics && metrics.convVenta!=null ? metrics.convVenta : 0;
      const formaciones=aplic;

      radarChart=new Chart(radarCtx,{
        type:"radar",
        data:{
          labels:["Aplicaci√≥n procesos","Formaciones","Conv. prueba","Conv. venta"],
          datasets:[{
            data:[aplic,formaciones,convP,convV],
            borderColor:"rgba(59,130,246,1)",
            backgroundColor:"rgba(59,130,246,0.2)",
            pointBackgroundColor:"rgba(59,130,246,1)"
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{
            r:{
              beginAtZero:true,
              angleLines:{color:"#e5e7eb"},
              grid:{color:"#e5e7eb"},
              pointLabels:{color:"#6b7280",font:{size:9}},
              ticks:{display:false}
            }
          }
        }
      });

      let mejoras=[];
      if(detalles && detalles.length){
        mejoras=detalles.filter(d=>d.aplica===0 || d.aplica==="0").slice(0,5);
      }
      if(!mejoras.length) mejoras=[{criterio:"Sin procesos pendientes",aplica:0}];

      mejoraChart=new Chart(mejoraCtx,{
        type:"bar",
        data:{
          labels:mejoras.map(d=>d.criterio),
          datasets:[{
            data:mejoras.map(()=>100),
            backgroundColor:"rgba(239,68,68,0.9)"
          }]
        },
        options:{
          indexAxis:"y",
          plugins:{legend:{display:false}},
          scales:{
            x:{
              beginAtZero:true,
              max:100,
              ticks:{color:"#6b7280",font:{size:9}},
              grid:{color:"#e5e7eb"}
            },
            y:{
              ticks:{color:"#6b7280",font:{size:9}},
              grid:{display:false}
            }
          }
        }
      });

      const hit=metrics && metrics.aplicaHIT!=null ? (metrics.aplicaHIT ? 100 : 0) : 0;
      kpiChart=new Chart(kpiCtx,{
        type:"bar",
        data:{
          labels:["HIT","Aplic. procesos","Conv. prueba","Conv. venta"],
          datasets:[{
            data:[hit,aplic,convP,convV],
            backgroundColor:[
              "rgba(239,68,68,0.9)",
              "rgba(37,99,235,0.9)",
              "rgba(34,197,94,0.9)",
              "rgba(249,115,22,0.9)"
            ]
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{
            y:{
              beginAtZero:true,
              ticks:{color:"#6b7280",font:{size:9}},
              grid:{color:"#e5e7eb"}
            },
            x:{
              ticks:{color:"#6b7280",font:{size:9}},
              grid:{display:false}
            }
          }
        }
      });
    }

    function manejarChecklist(file){
      if(!centroSeleccionadoCodigo || !currentInformeId){
        alert("Selecciona primero un centro e informe (bot√≥n 'Crear').");
        const inp=document.getElementById("checklistInput");
        if(inp) inp.value="";
        return;
      }
      const reader=new FileReader();
      reader.onload=e=>{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:"array"});
        const sheet=seleccionarHojaProcesos(wb);
        if(!sheet){
          alert("No se ha encontrado la hoja de PROCESOS en el checklist.");
          return;
        }

        let tipo=document.getElementById("metaTipoCentro").value || null;
        const nameUpper=file.name.toUpperCase();
        if(!tipo){
          if(nameUpper.includes("CORNER")) tipo="CORNER";
          else if(nameUpper.includes("EXCLUSIVO")) tipo="EXCLUSIVO";
        }
        if(!tipo){
          const centro=centros.find(c=>c.CODIGO===centroSeleccionadoCodigo);
          const t=(centro?.TIPOLOGIA||"").toUpperCase();
          if(t.includes("CORNER") || t.includes("C√ìRNER")) tipo="CORNER";
          else if(t.includes("EXCLUSIVO")) tipo="EXCLUSIVO";
        }
        if(!tipo) tipo="CORNER";
        document.getElementById("metaTipoCentro").value=tipo;

        let metrics={};
        let detalles=[];

        if(tipo==="CORNER"){
          for(let row=7; row<=88; row++){
            const critCell=sheet["B"+row];
            const valCell=sheet["F"+row];
            if(!critCell || !valCell) continue;
            let v=String(valCell.v).replace(",",".");

            if(v!=="0" && v!=="1") continue;
            const num=parseInt(v,10);
            detalles.push({criterio:String(critCell.v),aplica:num});
          }
          let aplicProc=leerNumeroCelda(sheet,"F90");
          if(aplicProc==null && detalles.length){
            const total=detalles.length;
            const aplica=detalles.filter(d=>d.aplica===1).length;
            aplicProc=(aplica/total)*100;
          }
          const aplicaHIT=boolDesdeCelda(sheet["F63"]);
          const convPrueba=leerNumeroCelda(sheet,"B92");
          const convVenta=leerNumeroCelda(sheet,"B93");
          metrics={aplicProc,aplicaHIT,convPrueba,convVenta};
        }else{
          for(let row=8; row<=102; row++){
            const critCell=sheet["B"+row];
            const valCell=sheet["F"+row];
            if(!critCell || !valCell) continue;
            let v=String(valCell.v).replace(",",".");

            if(v!=="0" && v!=="1") continue;
            const num=parseInt(v,10);
            detalles.push({criterio:String(critCell.v),aplica:num});
          }
          let aplicProc=leerNumeroCelda(sheet,"F104");
          if(aplicProc==null && detalles.length){
            const total=detalles.length;
            const aplica=detalles.filter(d=>d.aplica===1).length;
            aplicProc=(aplica/total)*100;
          }
          const aplicaHIT=boolDesdeCelda(sheet["F65"]);
          const convPrueba=leerNumeroCelda(sheet,"I126");
          const convVenta=leerNumeroCelda(sheet,"I127");
          metrics={aplicProc,aplicaHIT,convPrueba,convVenta};
        }

        const partes=[];
        partes.push(`Checklist ${tipo} cargado (${file.name}).`);
        if(metrics.aplicProc!=null) partes.push(`% aplicaci√≥n procesos: ${metrics.aplicProc.toFixed(1)}.`);
        if(metrics.convPrueba!=null) partes.push(`Conv. a prueba: ${metrics.convPrueba}.`);
        if(metrics.convVenta!=null) partes.push(`Conv. a venta: ${metrics.convVenta}.`);
        if(metrics.aplicaHIT!=null) partes.push(`Aplica HIT: ${metrics.aplicaHIT ? "S√≠" : "No"}.`);
        const resumen=partes.join(" ");

        document.getElementById("checklistResumen").textContent=resumen;
        renderChecklistCharts(metrics,detalles);

        const eCentro=estado[centroSeleccionadoCodigo];
        if(eCentro){
          const inf=(eCentro.informes||[]).find(i=>i.id===currentInformeId);
          if(inf){
            inf.checklistResumen=resumen;
            inf.checklistTipo=tipo;
            inf.checklistMetrics=metrics;
            inf.checklistDetalles=detalles;
            guardarEstado();
          }
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function guardarInforme(finalizar){
      if(!centroSeleccionadoCodigo || !currentInformeId){
        alert("Selecciona primero un centro e informe.");
        return;
      }
      const code=centroSeleccionadoCodigo;
      const e=estado[code];
      if(!e) return;
      const inf=(e.informes||[]).find(i=>i.id===currentInformeId);
      if(!inf) return;

      inf.audiologo=document.getElementById("infAudiologo").value.trim();
      inf.horasServicio=document.getElementById("infHorasServicio").value.trim();
      inf.delegadoFormacion=document.getElementById("infDelFormacion").value.trim();
      inf.tipoVisita=leerTipoVisitaDesdeUI();
      inf.recomendaciones=document.getElementById("informeRecomendaciones").value.trim();
      inf.compromisos=document.getElementById("informeCompromisos").value.trim();

      if(!estado[code]) estado[code]={informes:[]};
      estado[code].audiologoCentro=inf.audiologo;
      estado[code].horasCentro=inf.horasServicio;

      const c=centros.find(x=>x.CODIGO===code);
      if(c){
        c.AUDIOLOGO=inf.audiologo;
        c.HORAS_SERVICIO=inf.horasServicio;
      }

      if(finalizar){
        inf.estado="finalizado";
        inf.fechaFinalizacion=new Date().toISOString();
      }else{
        inf.estado=inf.estado||"borrador";
      }
      guardarEstado();
      aplicarEstadoALosCentros();
      renderTabla(document.getElementById("searchInput").value);
      actualizarResumen();

      document.getElementById("informeEstadoBadge").textContent=finalizar ? "Informe finalizado" : "Informe guardado";
      if(finalizar) setInformeEditable(false);
      alert(finalizar ? `Informe finalizado para el centro ${code}.` : `Borrador de informe guardado para el centro ${code}.`);
    }

    /* -------------------- HIST√ìRICO ------------------------ */

    function construirFilaHistorico(centro,inf){
      const item=document.createElement("div");
      item.className="historico-item";
      const text=document.createElement("div");
      text.className="historico-text";
      const l1=document.createElement("div");
      const fechaVisita=inf.fechaVisita ? formatearFechaCorta(inf.fechaVisita) : "sin fecha";
      l1.textContent=`${centro.CODIGO} ¬∑ ${centro.CENTRO} ¬∑ Visita: ${fechaVisita} ¬∑ Estado: ${inf.estado==="finalizado"?"Finalizado":"Borrador"}`;
      const l2=document.createElement("div");
      l2.className="historico-tag";
      l2.textContent=`Creado: ${formatearFechaCorta(inf.fechaCreacion)} ¬∑ √öltima actualizaci√≥n: ${inf.fechaFinalizacion ? formatearFechaCorta(inf.fechaFinalizacion) : "-"}`;
      text.appendChild(l1); text.appendChild(l2);

      const acc=document.createElement("div");
      acc.style.display="flex";
      acc.style.gap="4px";

      const btnVer=document.createElement("button");
      btnVer.className="btn btn-outline btn-sm";
      btnVer.textContent="Ver";
      btnVer.addEventListener("click",()=>{
        document.getElementById("historicoModal").style.display="none";
        cargarCentroEnInforme(centro.CODIGO,inf.id,inf.estado==="finalizado");
      });

      const btnImp=document.createElement("button");
      btnImp.className="btn btn-primary btn-sm";
      btnImp.textContent="Imprimir";
      btnImp.addEventListener("click",()=>{
        document.getElementById("historicoModal").style.display="none";
        cargarCentroEnInforme(centro.CODIGO,inf.id,true);
        setTimeout(()=>window.print(),300);
      });

      acc.appendChild(btnVer); acc.appendChild(btnImp);
      item.appendChild(text); item.appendChild(acc);
      return item;
    }

    function abrirHistoricoGlobal(){
      const modal=document.getElementById("historicoModal");
      const lista=document.getElementById("historicoLista");
      const titulo=document.getElementById("historicoTitulo");
      titulo.textContent="Hist√≥rico global de visitas e informes";
      lista.innerHTML="";
      let total=0;
      centros.forEach(c=>{
        const e=estado[c.CODIGO]||{informes:[]};
        (e.informes||[]).forEach(inf=>{
          const item=construirFilaHistorico(c,inf);
          lista.appendChild(item);
          total++;
        });
      });
      if(!total){
        const p=document.createElement("p");
        p.className="text-muted";
        p.textContent="Todav√≠a no hay visitas ni informes registrados.";
        lista.appendChild(p);
      }
      modal.style.display="flex";
    }

    /* ------------------ ZOOM IM√ÅGENES ---------------------- */
    function abrirZoomImagen(src){
      const overlay=document.getElementById("imgZoomOverlay");
      const img=document.getElementById("imgZoomImage");
      img.src=src;
      overlay.style.display="flex";
    }
    function cerrarZoomImagen(){
      document.getElementById("imgZoomOverlay").style.display="none";
    }
    function setupImagenInput(inputId,zoneId){
      const input=document.getElementById(inputId);
      const zone=document.getElementById(zoneId);
      if(!input || !zone) return;
      input.addEventListener("change",()=>{
        const file=input.files[0];
        if(!file) return;
        const reader=new FileReader();
        reader.onload=ev=>{
          zone.innerHTML="";
          const img=document.createElement("img");
          img.src=ev.target.result;
          img.addEventListener("click",()=>abrirZoomImagen(img.src));
          zone.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    /* ---------------------- TEMA --------------------------- */
    function aplicarTemaDesdeStorage(){
      const saved=localStorage.getItem("InformeAudioThemeMode")||"light";
      if(saved==="dark"){
        document.body.classList.add("dark");
        document.getElementById("btnTheme").textContent="‚òÄÔ∏è";
      }else{
        document.body.classList.remove("dark");
        document.getElementById("btnTheme").textContent="üåô";
      }
    }
    function toggleTheme(){
      const isDark=document.body.classList.toggle("dark");
      localStorage.setItem("InformeAudioThemeMode",isDark?"dark":"light");
      document.getElementById("btnTheme").textContent=isDark?"‚òÄÔ∏è":"üåô";
    }

    /* ---------------------- VISITA ------------------------- */
    function abrirVisitaModal(codigo){
      const centro=centros.find(c=>c.CODIGO===codigo);
      if(!centro) return;
      visitaModalCodigo=codigo;
      const input=document.getElementById("visitaModalFecha");
      input.value=centro.VISITA||"";
      document.getElementById("visitaModalCentro").textContent=`Centro: ${centro.CENTRO||codigo}`;
      document.getElementById("visitaModal").style.display="flex";
    }
    function cerrarVisitaModal(){
      document.getElementById("visitaModal").style.display="none";
      visitaModalCodigo=null;
    }

    /* ---------------------- M√ìDULOS ------------------------ */
    function setActiveModule(mod){
      document.getElementById("modCentros").style.display=mod==="centros"?"block":"none";
      document.getElementById("modInforme").style.display=mod==="informe"?"block":"none";
      document.getElementById("navCentros").classList.toggle("active",mod==="centros");
      document.getElementById("navInforme").classList.toggle("active",mod==="informe");
      const title=document.getElementById("mainTitle");
      const sub=document.getElementById("mainSubtitle");
      if(mod==="centros"){
        title.textContent="Centros y delegados";
        sub.textContent="Visi√≥n general, calendario y tabla tipo Excel. Alimenta todos los informes.";
      }else{
        title.textContent="Informe de visita";
        sub.textContent="Edici√≥n del informe ejecutivo Informe Audio.";
      }
    }

    /* ------------------------- INIT ------------------------ */
    document.addEventListener("DOMContentLoaded",()=>{
      estado=cargarEstado();
      centros=JSON.parse(JSON.stringify(demoData));
      aplicarEstadoALosCentros();

      const today=new Date();
      calendarYear=today.getFullYear();
      calendarMonth=today.getMonth();

      renderTabla();
      actualizarResumen();
      aplicarTemaDesdeStorage();
      setActiveModule("centros");

      document.getElementById("searchInput").addEventListener("input",e=>renderTabla(e.target.value));
      document.getElementById("excelInput").addEventListener("change",e=>{
        const file=e.target.files[0];
        if(file) manejarExcel(file);
      });
      document.getElementById("btnExport").addEventListener("click",()=>{
        const payload={fechaExport:new Date().toISOString(),centros,estado};
        const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url;
        a.download="informe-audio-estado.json";
        a.click();
        URL.revokeObjectURL(url);
      });
      document.getElementById("btnReset").addEventListener("click",()=>{
        if(!confirm("¬øSeguro que quieres borrar todas las visitas e informes guardados?")) return;
        localStorage.removeItem(STORAGE_KEY);
        estado={};
        centros=JSON.parse(JSON.stringify(demoData));
        aplicarEstadoALosCentros();
        renderTabla(document.getElementById("searchInput").value);
        actualizarResumen();
        centroSeleccionadoCodigo=null;
        currentInformeId=null;
        document.getElementById("informeEmpty").style.display="block";
        document.getElementById("informeContenido").style.display="none";
        document.getElementById("informeEstadoBadge").textContent="Sin centro seleccionado";
        limpiarImagenesYChecklist();
      });
      document.getElementById("btnTheme").addEventListener("click",toggleTheme);

      document.getElementById("checklistInput").addEventListener("change",e=>{
        const file=e.target.files[0];
        if(file) manejarChecklist(file);
      });

      setupImagenInput("imgInput1","imgZone1");
      setupImagenInput("imgInput2","imgZone2");
      setupImagenInput("imgInput3","imgZone3");
      setupImagenInput("imgInput4","imgZone4");

      document.getElementById("btnApertura").addEventListener("click",e=>{
        e.target.classList.toggle("active");
      });
      document.getElementById("btnSeguimiento").addEventListener("click",e=>{
        e.target.classList.toggle("active");
      });

      document.getElementById("btnGuardarBorrador").addEventListener("click",()=>guardarInforme(false));
      document.getElementById("btnGuardarFinal").addEventListener("click",()=>guardarInforme(true));

      document.getElementById("btnImprimirInforme").addEventListener("click",()=>{
        if(!centroSeleccionadoCodigo || !currentInformeId){
          alert("Selecciona primero un informe para imprimir.");
          return;
        }
        setActiveModule("informe");
        cargarCentroEnInforme(centroSeleccionadoCodigo,currentInformeId,true);
        setTimeout(()=>window.print(),200);
      });

      document.getElementById("navCentros").addEventListener("click",()=>setActiveModule("centros"));
      document.getElementById("navInforme").addEventListener("click",()=>setActiveModule("informe"));
      document.getElementById("navHistorico").addEventListener("click",abrirHistoricoGlobal);

      document.getElementById("historicoCerrar").addEventListener("click",()=>{document.getElementById("historicoModal").style.display="none";});
      document.getElementById("historicoModal").addEventListener("click",e=>{
        if(e.target.id==="historicoModal") document.getElementById("historicoModal").style.display="none";
      });

      document.getElementById("imgZoomOverlay").addEventListener("click",cerrarZoomImagen);

      document.getElementById("calPrevMonth").addEventListener("click",()=>{
        calendarMonth--;
        if(calendarMonth<0){calendarMonth=11;calendarYear--;}
        actualizarCalendarioVisitas();
      });
      document.getElementById("calNextMonth").addEventListener("click",()=>{
        calendarMonth++;
        if(calendarMonth>11){calendarMonth=0;calendarYear++;}
        actualizarCalendarioVisitas();
      });

      document.getElementById("visitaModalGuardar").addEventListener("click",()=>{
        if(!visitaModalCodigo) return;
        const fecha=document.getElementById("visitaModalFecha").value;
        if(!fecha){ alert("Selecciona una fecha de visita."); return; }
        const code=visitaModalCodigo;
        if(!estado[code]) estado[code]={informes:[]};
        estado[code].visita=fecha;
        estado[code].visitaEstado="pendiente";
        const c=centros.find(c=>c.CODIGO===code);
        if(c){
          c.VISITA=fecha;
          c.VISITA_ESTADO="pendiente";
        }
        guardarEstado();
        aplicarEstadoALosCentros();
        renderTabla(document.getElementById("searchInput").value);
        actualizarResumen();
        cerrarVisitaModal();
      });

      document.getElementById("visitaModalAnular").addEventListener("click",()=>{
        if(!visitaModalCodigo) return;
        const fecha=document.getElementById("visitaModalFecha").value;
        if(!fecha){ alert("Selecciona una fecha para anular."); return; }
        const motivo=prompt("Motivo de anulaci√≥n de la visita:");
        if(!motivo) return;
        const code=visitaModalCodigo;
        if(!estado[code]) estado[code]={informes:[]};
        estado[code].visita=fecha;
        estado[code].visitaEstado="anulada";
        estado[code].motivoAnulacion=motivo.trim();
        const c=centros.find(c=>c.CODIGO===code);
        if(c){
          c.VISITA=fecha;
          c.VISITA_ESTADO="anulada";
        }
        guardarEstado();
        aplicarEstadoALosCentros();
        renderTabla(document.getElementById("searchInput").value);
        actualizarResumen();
        cerrarVisitaModal();
      });

      document.getElementById("visitaModalCancelar").addEventListener("click",cerrarVisitaModal);
      document.getElementById("visitaModal").addEventListener("click",e=>{
        if(e.target.id==="visitaModal") cerrarVisitaModal();
      });
    });
  </script>
</body>
</html>
