<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>INFORME AUDIO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #f97373;
      --primary-strong: #f43f5e;
      --bg: #020617;
      --bg-card: #020617;
      --border: #020617;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      display: flex;
      min-height: 100vh;
    }

    /* SIDEBAR */

    .sidebar {
      width: 240px;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #0f172a;
    }

    .sidebar-header {
      padding: 16px 18px;
      border-bottom: 1px solid #0f172a;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: var(--primary-strong);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: #0b1120;
    }

    .sidebar-title {
      display: flex;
      flex-direction: column;
    }

    .sidebar-title span:first-child {
      font-weight: 600;
      font-size: 15px;
      letter-spacing: 0.03em;
    }

    .sidebar-title span:last-child {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .sidebar-nav {
      padding: 10px 8px;
      flex: 1;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 8px 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      color: #e5e7eb;
      margin: 2px 4px;
      border: 1px solid transparent;
    }

    .nav-item span.icon { font-size: 16px; }

    .nav-item.active {
      background: #111827;
      border-color: #1e293b;
    }

    .nav-item:hover:not(.active) {
      background: #020617;
      border-color: #1e293b;
    }

    .sidebar-footer {
      padding: 10px 14px;
      border-top: 1px solid #0f172a;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* MAIN */

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .main-header {
      padding: 12px 18px;
      border-bottom: 1px solid #020617;
      background: #020617;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .main-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .main-title {
      font-size: 19px;
      font-weight: 600;
    }

    .main-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .main-header-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid #1e293b;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #020617;
      color: var(--text-main);
    }

    .btn-sm { padding: 4px 10px; font-size: 11px; }

    .btn-primary {
      background: var(--primary-strong);
      border-color: var(--primary-strong);
      color: #020617;
    }

    .btn-primary:hover { filter: brightness(1.05); }

    .btn-outline { background: #020617; }
    .btn-outline:hover { background: #0b1120; }

    .btn-icon {
      width: 30px;
      height: 30px;
      padding: 0;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
    }

    input[type="file"] { display: none; }

    .main-content {
      padding: 10px 16px 18px;
      overflow: auto;
      flex: 1;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 12px 14px 14px;
      border: 1px solid var(--border);
      box-shadow: 0 0 0 1px #020617;
      margin-bottom: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 6px;
      flex-wrap: wrap;
    }

    .card-title { font-size: 14px; font-weight: 600; }
    .card-subtitle { font-size: 11px; color: var(--text-muted); }

    .badge {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: #020617;
      color: var(--text-muted);
    }

    .text-muted { color: var(--text-muted); font-size: 11px; }

    /* DASHBOARD TOP: GRAFICA + CALENDARIO */

    .dashboard-top {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 8px;
    }

    .mini-chart {
      border-radius: 12px;
      border: 1px solid #020617;
      background: #020617;
      padding: 6px 8px;
    }

    .mini-chart canvas { max-height: 150px; }

    .mini-calendar {
      border-radius: 12px;
      border: 1px solid #020617;
      background: #020617;
      padding: 6px 8px;
      font-size: 10px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 2px;
    }

    .calendar-day-header {
      text-align: center;
      font-size: 9px;
      color: var(--text-muted);
    }

    .calendar-cell {
      min-height: 16px;
      border-radius: 4px;
      border: 1px solid #020617;
      text-align: right;
      padding: 1px 3px;
      font-size: 9px;
    }

    .calendar-cell-pendiente { background: rgba(234,179,8,0.9); color: #020617; }
    .calendar-cell-realizada { background: rgba(22,163,74,0.9); color: #f9fafb; }
    .calendar-cell-anulada { background: rgba(239,68,68,0.95); color: #f9fafb; }

    .calendar-legend {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      font-size: 9px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .calendar-legend-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .calendar-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    /* TABLA CENTROS */

    .table-wrapper { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 900px;
    }

    thead { background: #020617; }

    th, td {
      padding: 5px 6px;
      border-bottom: 1px solid #020617;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    tbody tr:hover { background: #020617; }

    .col-codigo {
      font-weight: 600;
      font-size: 11px;
      color: var(--primary);
    }

    .col-centro { font-weight: 500; }

    .col-visit-cell { min-width: 150px; }

    .visita-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 3px;
    }

    .visita-input {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: #020617;
      color: var(--text-main);
      min-width: 100px;
    }

    .visita-input:focus {
      outline: none;
      border-color: #facc15;
    }

    .visita-guardada .visita-input {
      background: #1f2937;
      border-color: #facc15;
    }

    .pill {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #1e293b;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #020617;
      color: var(--text-main);
    }

    .pill-corner {
      border-color: #f97373;
      color: #f97373;
    }

    .pill-crear {
      background: var(--primary-strong);
      border-color: var(--primary-strong);
      color: #020617;
      cursor: pointer;
    }

    .icon-finalizado { color: #22c55e; font-size: 16px; }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
      justify-content: space-between;
    }

    .input-text {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: #020617;
      color: var(--text-main);
      min-width: 160px;
    }

    .input-text:focus { outline: none; border-color: var(--primary-strong); }

    .estado-select {
      font-size: 10px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: #020617;
      color: var(--text-main);
      padding: 2px 4px;
    }

    /* INFORME DE VISITA */

    .informe-empty {
      padding: 4px 2px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .informe-banner {
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 8px;
      border: 1px solid #020617;
      display: flex;
      background: linear-gradient(90deg, #020617 0%, #020617 60%, #0f172a 100%);
    }

    .informe-banner-left {
      background: #ef4444;
      color: #020617;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .informe-banner-right {
      flex: 1;
      padding: 6px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      color: #e5e7eb;
    }

    .informe-banner-title { font-size: 15px; font-weight: 600; }
    .informe-banner-subtitle { font-size: 11px; color: var(--text-muted); }

    .informe-meta-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px 8px;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .meta-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 1px;
    }

    .meta-input,
    .meta-select {
      width: 100%;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 4px 8px;
      background: #020617;
      color: var(--text-main);
    }

    .meta-input[readonly] { opacity: 0.7; }

    .meta-input:focus,
    .meta-select:focus {
      outline: none;
      border-color: var(--primary-strong);
    }

    .tipo-visita-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 6px;
      font-size: 11px;
    }

    .pill-toggle {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 10px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .pill-toggle.active {
      background: var(--primary-strong);
      border-color: var(--primary-strong);
      color: #020617;
    }

    .informe-centro-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px 8px;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .informe-centro-item-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .informe-centro-item-value {
      font-size: 12px;
      font-weight: 500;
    }

    .informe-section {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed #1f2937;
    }

    .informe-section-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 6px;
    }

    .informe-section-title {
      font-size: 12px;
      font-weight: 600;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .chart-card-inner {
      border-radius: 12px;
      border: 1px solid #020617;
      background: #020617;
      padding: 8px 8px 6px;
      height: 170px;
      display: flex;
      flex-direction: column;
    }

    .chart-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .chart-tag {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #1e293b;
      color: var(--text-muted);
    }

    .chart-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chart-wrapper canvas { max-width: 100%; max-height: 130px; }

    /* IM√ÅGENES Y NOTAS */

    .img-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 4px;
    }

    .img-card {
      border-radius: 12px;
      border: 1px solid #020617;
      background: #020617;
      padding: 6px 8px;
      font-size: 11px;
    }

    .img-title { font-size: 11px; font-weight: 600; margin-bottom: 2px; }
    .img-subtitle { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }

    .img-preview-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .img-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #020617;
      cursor: zoom-in;
    }

    .img-notes-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .textarea-base {
      width: 100%;
      min-height: 70px;
      border-radius: 10px;
      border: 1px solid #1e293b;
      padding: 6px 8px;
      font-size: 11px;
      resize: vertical;
      font-family: inherit;
      background: #020617;
      color: var(--text-main);
    }

    .textarea-base:focus {
      outline: none;
      border-color: var(--primary-strong);
    }

    .textarea-wide {
      margin-top: 4px;
      min-height: 50px;
    }

    .obs-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .obs-card {
      border-radius: 12px;
      border: 1px solid #020617;
      background: #020617;
      padding: 6px 8px;
    }

    .obs-title { font-size: 11px; font-weight: 600; margin-bottom: 2px; }

    .informe-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 8px;
    }

    /* MODAL HIST√ìRICO */

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-card {
      background: #020617;
      border-radius: 12px;
      padding: 10px 12px;
      max-width: 720px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
      border: 1px solid #1e293b;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .modal-title { font-size: 14px; font-weight: 600; }
    .modal-body { font-size: 11px; }

    .historico-item {
      border-radius: 10px;
      border: 1px solid #1e293b;
      padding: 6px 7px;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .historico-text { display: flex; flex-direction: column; gap: 2px; }
    .historico-tag { font-size: 10px; color: var(--text-muted); }

    /* ZOOM IMAGEN */

    .img-zoom-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .img-zoom-overlay img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
    }

    /* DETALLES CHECKLIST (P√ÅGINA 2 IMPRESI√ìN) */

    #cardChecklistDetalles { margin-top: 8px; }

    #checklistDetallesTabla {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    #checklistDetallesTabla th,
    #checklistDetallesTabla td {
      padding: 4px 6px;
      border-bottom: 1px solid #020617;
      text-align: left;
    }

    #checklistDetallesTabla th {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    /* MODO CLARO (override r√°pido) */

    body.light-mode {
      background: #f3f4f6;
      color: #111827;
    }

    body.light-mode .main-header,
    body.light-mode .card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 1px 3px rgba(15,23,42,0.1);
    }

    body.light-mode .mini-chart,
    body.light-mode .mini-calendar,
    body.light-mode .chart-card-inner,
    body.light-mode .img-card,
    body.light-mode .obs-card {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    body.light-mode .table-wrapper thead th {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    body.light-mode .visita-input,
    body.light-mode .input-text,
    body.light-mode .meta-input,
    body.light-mode .meta-select,
    body.light-mode .textarea-base,
    body.light-mode .estado-select {
      background: #ffffff;
      color: #111827;
      border-color: #d1d5db;
    }

    body.light-mode .sidebar {
      background: #111827;
    }

    /* PRINT */

    @media print {
      body {
        background: #ffffff;
        color: #000000;
      }

      .sidebar,
      .main-header,
      #historicoModal,
      #imgZoomOverlay {
        display: none !important;
      }

      .main {
        flex: none;
        width: 100%;
      }

      .main-content {
        padding: 0;
      }

      .card {
        background: #ffffff;
        border-color: #e5e7eb;
        box-shadow: none;
      }

      #cardChecklistDetalles {
        page-break-before: always;
      }
    }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      .chart-grid { grid-template-columns: minmax(0, 1fr); }
      .img-row { grid-template-columns: minmax(0, 1fr); }
      .img-notes-row { grid-template-columns: minmax(0, 1fr); }
      .obs-grid { grid-template-columns: minmax(0, 1fr); }
      .informe-meta-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .informe-centro-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .dashboard-top { grid-template-columns: minmax(0, 1fr); }
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-circle">IA</div>
      <div class="sidebar-title">
        <span>INFORME AUDIO</span>
        <span>Panel visitas</span>
      </div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section-title">M√≥dulos</div>
      <div class="nav-item active">
        <span class="icon">üìù</span><span>Informe de visita</span>
      </div>
      <div class="nav-item" id="navDashboard">
        <span class="icon">üìä</span><span>Dashboard general</span>
      </div>
      <div class="nav-item" id="navHistorico">
        <span class="icon">üìÜ</span><span>Hist√≥rico visitas</span>
      </div>
    </div>
    <div class="sidebar-footer">
      INFORME AUDIO ¬∑ Demo<br/>Datos guardados en este navegador.
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header class="main-header">
      <div class="main-header-left">
        <div class="main-title">Centros auditivos ¬∑ visitas</div>
        <div class="main-subtitle">
          Programa visitas, crea informes y alimenta el dashboard general.
        </div>
      </div>
      <div class="main-header-actions">
        <label class="btn btn-outline btn-sm" for="excelInput">
          üì• Cargar Excel centros
        </label>
        <input type="file" id="excelInput" accept=".xlsx,.xls" />
        <button class="btn btn-primary btn-sm" id="btnExport">‚¨áÔ∏è Exportar estado</button>
        <button class="btn btn-icon btn-outline" id="btnTheme" title="Modo claro / oscuro">‚òÄÔ∏è</button>
        <button class="btn btn-icon btn-outline" id="btnReset" title="Borrar estado">üóëÔ∏è</button>
      </div>
    </header>

    <section class="main-content">
      <!-- Resumen + calendario -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Visi√≥n general</div>
            <div class="card-subtitle">
              Alimentado autom√°ticamente por las visitas e informes del m√≥dulo Informe de visita.
            </div>
          </div>
          <span class="badge">INFORME AUDIO</span>
        </div>

        <div class="dashboard-top">
          <div class="mini-chart">
            <canvas id="miniSummaryChart"></canvas>
          </div>
          <div class="mini-calendar">
            <div class="calendar-header">
              <span>Calendario visitas (mes actual)</span>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="calendar-legend">
              <div class="calendar-legend-item">
                <span class="calendar-dot" style="background:#eab308;"></span><span>Pendiente</span>
              </div>
              <div class="calendar-legend-item">
                <span class="calendar-dot" style="background:#22c55e;"></span><span>Realizada (con informe)</span>
              </div>
              <div class="calendar-legend-item">
                <span class="calendar-dot" style="background:#ef4444;"></span><span>Anulada</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tabla centros -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Centros auditivos ¬∑ visitas</div>
            <div class="card-subtitle">
              Carga tu Excel o usa los datos demo. Programa la visita, marca el estado y crea el informe.
            </div>
          </div>
        </div>
        <div class="filter-row">
          <input id="searchInput" class="input-text" placeholder="Buscar por c√≥digo, centro, provincia..." />
          <span class="text-muted">Visita pendiente: √°mbar ¬∑ con informe: verde ¬∑ anulada: rojo (en el calendario).</span>
        </div>
        <div class="table-wrapper">
          <table id="tablaCentros">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Propietario</th>
                <th>Centro</th>
                <th>Provincia</th>
                <th>Delegado</th>
                <th>Tipolog√≠a</th>
                <th>Centro AAR</th>
                <th>Visita</th>
                <th>Informe / hist√≥rico</th>
                <th>Audi√≥logo</th>
                <th>Horas servicio</th>
                <th>Resp. Audio</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- INFORME DE VISITA (P√ÅGINA 1) -->
      <section class="card" id="cardInformeVisita">
        <div class="card-header">
          <div>
            <div class="card-title">Informe de visita</div>
            <div class="card-subtitle">
              Al crear un informe desde una visita pendiente se rellenan autom√°ticamente los datos de cabecera.
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
            <span class="badge" id="informeEstadoBadge">Sin centro seleccionado</span>
            <button class="btn btn-outline btn-sm" id="btnImprimirInforme">üñ®Ô∏è Imprimir</button>
          </div>
        </div>

        <div class="informe-banner">
          <div class="informe-banner-left">IA</div>
          <div class="informe-banner-right">
            <div class="informe-banner-title">Informe de visita</div>
            <div class="informe-banner-subtitle">
              Evaluaci√≥n ejecutiva del punto de venta y procesos de audiolog√≠a.
            </div>
          </div>
        </div>

        <div id="informeEmpty" class="informe-empty">
          Selecciona un centro con el bot√≥n <strong>‚ÄúCrear‚Äù</strong> o abre un informe desde el hist√≥rico.
        </div>

        <div id="informeContenido" style="display:none;">
          <!-- Meta cabecera -->
          <div class="informe-meta-grid">
            <div>
              <div class="meta-label">Centro</div>
              <input id="metaCentro" class="meta-input" readonly />
            </div>
            <div>
              <div class="meta-label">Delegado</div>
              <input id="metaDelegado" class="meta-input" readonly />
            </div>
            <div>
              <div class="meta-label">Tipo de centro</div>
              <select id="metaTipoCentro" class="meta-select">
                <option value="">Corner o Exclusivo...</option>
                <option value="CORNER">Corner</option>
                <option value="EXCLUSIVO">Exclusivo</option>
              </select>
            </div>
            <div>
              <div class="meta-label">Centro AAR</div>
              <select id="metaCentroAAR" class="meta-select">
                <option value="">¬øCentro AAR?</option>
                <option value="S√≠">S√≠</option>
                <option value="No">No</option>
              </select>
            </div>
            <div>
              <div class="meta-label">Responsable Audio</div>
              <select id="infRespAudioSelect" class="meta-select">
                <option value="">Selecciona responsable...</option>
                <option value="Ariannys Rojas">Ariannys Rojas</option>
                <option value="Sonia Guasque">Sonia Guasque</option>
              </select>
            </div>
            <div>
              <div class="meta-label">Fecha visita</div>
              <input id="metaFechaVisita" class="meta-input" readonly placeholder="dd/mm/aaaa" />
            </div>
            <div>
              <div class="meta-label">Audiol√≥g@</div>
              <input id="infAudiologo" class="meta-input" placeholder="Nombre del audiol√≥g@" />
            </div>
            <div>
              <div class="meta-label">Horas servicio</div>
              <input id="infHorasServicio" class="meta-input" placeholder="p. ej. 4 h" />
            </div>
          </div>

          <div class="tipo-visita-row">
            <span class="meta-label" style="margin:0;">Tipo de visita</span>
            <button type="button" id="btnApertura" class="pill-toggle">Apertura</button>
            <button type="button" id="btnSeguimiento" class="pill-toggle">Seguimiento</button>
            <span style="flex:1;"></span>
            <label class="btn btn-outline btn-sm" for="checklistInput">
              üìé Checklist evaluaci√≥n (adjuntar fichero)
            </label>
            <input type="file" id="checklistInput" accept=".xlsx,.xls,.csv" />
          </div>

          <!-- Datos centro compactos -->
          <div class="informe-centro-grid">
            <div>
              <div class="informe-centro-item-label">C√≥digo</div>
              <div class="informe-centro-item-value" id="infCodigo"></div>
            </div>
            <div>
              <div class="informe-centro-item-label">Provincia</div>
              <div class="informe-centro-item-value" id="infProvincia"></div>
            </div>
            <div>
              <div class="informe-centro-item-label">Propietario</div>
              <div class="informe-centro-item-value" id="infPropietario"></div>
            </div>
            <div>
              <div class="informe-centro-item-label">Resp. Audio (centro)</div>
              <div class="informe-centro-item-value" id="infRespAudioCentro"></div>
            </div>
          </div>

          <!-- GRAFICOS -->
          <div class="informe-section">
            <div class="chart-grid">
              <div class="chart-card-inner">
                <div class="chart-title-row">
                  <span>Radar de resultados</span>
                  <span class="chart-tag">% visita</span>
                </div>
                <div class="chart-wrapper">
                  <canvas id="radarChart"></canvas>
                </div>
              </div>
              <div class="chart-card-inner">
                <div class="chart-title-row">
                  <span>√Åreas de mejora de procesos</span>
                  <span class="chart-tag">% no aplicados</span>
                </div>
                <div class="chart-wrapper">
                  <canvas id="mejoraChart"></canvas>
                </div>
              </div>
              <div class="chart-card-inner">
                <div class="chart-title-row">
                  <span>KPIs de negocio visita</span>
                  <span class="chart-tag">% visita</span>
                </div>
                <div class="chart-wrapper">
                  <canvas id="kpiChart"></canvas>
                </div>
              </div>
            </div>
            <div id="checklistResumen" class="text-muted" style="margin-top:4px;">
              Checklist no adjuntado todav√≠a.
            </div>
          </div>

          <!-- IM√ÅGENES -->
          <div class="informe-section">
            <div class="informe-section-header">
              <div class="informe-section-title">
                Im√°genes de la visita
              </div>
            </div>
            <div class="img-row">
              <div class="img-card">
                <div class="img-title">Imagen 1 ¬∑ Exterior</div>
                <div class="img-subtitle">Escaparate, fachada, visibilidad desde el exterior.</div>
                <label class="btn btn-outline btn-sm" for="imgInput1">üñºÔ∏è Seleccionar</label>
                <input type="file" id="imgInput1" accept="image/*" />
                <div id="imgPreview1" class="img-preview-row"></div>
              </div>
              <div class="img-card">
                <div class="img-title">Imagen 2 ¬∑ Interior</div>
                <div class="img-subtitle">Zona de recepci√≥n, sala de espera, visibilidad de audio.</div>
                <label class="btn btn-outline btn-sm" for="imgInput2">üñºÔ∏è Seleccionar</label>
                <input type="file" id="imgInput2" accept="image/*" />
                <div id="imgPreview2" class="img-preview-row"></div>
              </div>
              <div class="img-card">
                <div class="img-title">Imagen 3 ¬∑ Gabinete t√©cnico</div>
                <div class="img-subtitle">Equipamiento, insonorizaci√≥n, ergonom√≠a.</div>
                <label class="btn btn-outline btn-sm" for="imgInput3">üñºÔ∏è Seleccionar</label>
                <input type="file" id="imgInput3" accept="image/*" multiple />
                <div id="imgPreview3" class="img-preview-row"></div>
              </div>
            </div>

            <div class="img-notes-row">
              <textarea id="imgObs12" class="textarea-base" placeholder="Observaciones im√°genes 1 y 2..."></textarea>
              <textarea id="imgObs3" class="textarea-base" placeholder="Observaciones gabinete t√©cnico..."></textarea>
            </div>
            <textarea id="imgObsGeneral" class="textarea-base textarea-wide" placeholder="Observaciones generales sobre las im√°genes y documentaci√≥n fotogr√°fica..."></textarea>
          </div>

          <!-- OBS / RECOM / COMPROMISOS -->
          <div class="informe-section">
            <div class="obs-grid">
              <div class="obs-card">
                <div class="obs-title">Observaciones</div>
                <textarea id="informeObservaciones" class="textarea-base" placeholder="Observaciones relevantes de la visita..."></textarea>
              </div>
              <div class="obs-card">
                <div class="obs-title">Recomendaciones</div>
                <textarea id="informeRecomendaciones" class="textarea-base" placeholder="Recomendaciones de mejora, acciones sugeridas..."></textarea>
              </div>
              <div class="obs-card">
                <div class="obs-title">Compromisos</div>
                <textarea id="informeCompromisos" class="textarea-base" placeholder="Compromisos acordados con el centro (plazos, responsables, seguimiento)..."></textarea>
              </div>
            </div>

            <div class="informe-actions">
              <button class="btn btn-outline btn-sm" id="btnGuardarBorrador">üíæ Guardar borrador</button>
              <button class="btn btn-primary btn-sm" id="btnGuardarFinal">‚úÖ Guardar y finalizar</button>
            </div>
          </div>
        </div>
      </section>

      <!-- DETALLES CHECKLIST (P√ÅGINA 2 IMPRESI√ìN) -->
      <section class="card" id="cardChecklistDetalles">
        <div class="card-header">
          <div>
            <div class="card-title">Detalles checklist</div>
            <div class="card-subtitle">
              Criterios y estado de aplicaci√≥n (informaci√≥n de apoyo para lectura detallada).
            </div>
          </div>
        </div>
        <div id="checklistDetallesVacio" class="text-muted">
          A√∫n no se ha cargado ning√∫n checklist para este informe.
        </div>
        <div class="table-wrapper" id="checklistDetallesContenido" style="display:none;">
          <table id="checklistDetallesTabla">
            <thead>
              <tr>
                <th>#</th>
                <th>Criterio</th>
                <th>Aplica</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <!-- MODAL HIST√ìRICO GLOBAL -->
  <div class="modal-overlay" id="historicoModal">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="historicoTitulo">Hist√≥rico de visitas e informes</div>
        <button class="btn btn-icon btn-outline" id="historicoCerrar">‚úñÔ∏è</button>
      </div>
      <div class="modal-body" id="historicoLista"></div>
    </div>
  </div>

  <!-- ZOOM IMAGEN -->
  <div class="img-zoom-overlay" id="imgZoomOverlay">
    <img id="imgZoomImage" src="" alt="Zoom" />
  </div>

  <!-- SheetJS y Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /* =====================
       DEMO Y ESTADO
    ======================*/
    const demoData = [
      {
        CODIGO: "4DIA",
        PROPIETARIO: "AAO",
        CENTRO: "AVENIDA DIAGONAL",
        PROVINCIA: "BARCELONA",
        DELEGADOS: "ENERITZ ARANGUREN",
        TIPOLOGIA: "C√≥rner",
        CENTRO_AAR: "",
        VISITA: "",
        AUDIOLOGO: "",
        HORAS_SERVICIO: "",
        RESP_AUDIO: "Sonia Guasque",
      },
      {
        CODIGO: "4AXA",
        PROPIETARIO: "VADILLO Pedro",
        CENTRO: "CERDANYOLA",
        PROVINCIA: "BARCELONA",
        DELEGADOS: "LAURA PLAZAS",
        TIPOLOGIA: "C√≥rner",
        CENTRO_AAR: "",
        VISITA: "",
        AUDIOLOGO: "",
        HORAS_SERVICIO: "",
        RESP_AUDIO: "Sonia Guasque",
      },
      {
        CODIGO: "4AES",
        PROPIETARIO: "FRAGUELA Jacobo",
        CENTRO: "AAA NAR√ìN",
        PROVINCIA: "Galicia",
        DELEGADOS: "Daniel Chazo",
        TIPOLOGIA: "C√≥rner",
        CENTRO_AAR: "",
        VISITA: "",
        AUDIOLOGO: "",
        HORAS_SERVICIO: "",
        RESP_AUDIO: "Ariannys Rojas",
      },
      {
        CODIGO: "4ADX",
        PROPIETARIO: "LOPEZ Jose",
        CENTRO: "AGUILAS",
        PROVINCIA: "MURCIA",
        DELEGADOS: "Manuel C√°novas",
        TIPOLOGIA: "C√≥rner",
        CENTRO_AAR: "",
        VISITA: "",
        AUDIOLOGO: "",
        HORAS_SERVICIO: "",
        RESP_AUDIO: "Sonia Guasque",
      },
      {
        CODIGO: "4ARK",
        PROPIETARIO: "BELLOT Sonia",
        CENTRO: "ALAIN AFFLELOU OPTICO CARLET",
        PROVINCIA: "VALENCIA",
        DELEGADOS: "Cecilia P√©rez",
        TIPOLOGIA: "C√≥rner",
        CENTRO_AAR: "",
        VISITA: "",
        AUDIOLOGO: "",
        HORAS_SERVICIO: "",
        RESP_AUDIO: "Sonia Guasque",
      },
    ];

    const STORAGE_KEY = "InformeAudio_v2";

    let centros = [];
    let estado = {}; // {CODIGO: {visita, visitaEstado, centroAAR, respAudio, informes: [...]}}
    let centroSeleccionadoCodigo = null;
    let currentInformeId = null;

    let radarChart = null;
    let mejoraChart = null;
    let kpiChart = null;
    let miniSummaryChart = null;

    function cargarEstado() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        console.error(e);
        return {};
      }
    }

    function guardarEstado() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(estado));
      } catch (e) {
        console.error(e);
      }
    }

    function estadoCentroDesdeInformes(informes) {
      if (!informes || !informes.length) return "";
      if (informes.some((i) => i.estado === "finalizado")) return "finalizado";
      if (informes.some((i) => i.estado === "borrador")) return "borrador";
      return "";
    }

    function aplicarEstadoALosCentros() {
      centros.forEach((c) => {
        const e = estado[c.CODIGO];
        if (e) {
          c.VISITA = e.visita || "";
          c.CENTRO_AAR = e.centroAAR || c.CENTRO_AAR || "";
          c.RESP_AUDIO = e.respAudio || c.RESP_AUDIO || "";
          c.VISITA_ESTADO = e.visitaEstado || "pendiente";
          const infs = e.informes || [];
          c.NUM_INFORMES = infs.length;
          c.INFORME_ESTADO = estadoCentroDesdeInformes(infs);
          const finalizados = infs.filter((i) => i.estado === "finalizado");
          const ultimo = finalizados[finalizados.length - 1];
          c.ULTIMO_INFORME_FECHA = ultimo ? ultimo.fechaVisita || ultimo.fechaFinalizacion : "";
        } else {
          c.NUM_INFORMES = 0;
          c.INFORME_ESTADO = "";
          c.ULTIMO_INFORME_FECHA = "";
          c.VISITA_ESTADO = "pendiente";
        }
      });
    }

    function formatearFechaCorta(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleDateString("es-ES", { day: "2-digit", month: "2-digit", year: "2-digit" });
    }

    function leerNumeroCelda(sheet, addr) {
      const cell = sheet[addr];
      if (!cell) return null;
      let v = cell.v;
      if (typeof v === "string") v = v.replace("%", "").replace(",", ".");
      const num = parseFloat(v);
      return isNaN(num) ? null : num;
    }

    function boolDesdeCelda(cell) {
      if (!cell) return null;
      const v = String(cell.v).trim().toUpperCase();
      if (["1", "SI", "S√ç", "YES"].includes(v)) return true;
      if (["0", "NO"].includes(v)) return false;
      return null;
    }

    /* ========= TABLA CENTROS ========= */

    function renderTabla(filtroTexto = "") {
      const tbody = document.querySelector("#tablaCentros tbody");
      tbody.innerHTML = "";
      const term = filtroTexto.trim().toLowerCase();

      const filtrados = centros.filter((c) => {
        if (!term) return true;
        const str =
          (c.CODIGO || "") +
          " " +
          (c.PROPIETARIO || "") +
          " " +
          (c.CENTRO || "") +
          " " +
          (c.PROVINCIA || "") +
          " " +
          (c.DELEGADOS || "");
        return str.toLowerCase().includes(term);
      });

      filtrados.forEach((c) => {
        const tr = document.createElement("tr");
        tr.dataset.codigo = c.CODIGO;

        const tdCodigo = document.createElement("td");
        tdCodigo.className = "col-codigo";
        tdCodigo.textContent = c.CODIGO || "";
        tr.appendChild(tdCodigo);

        const tdProp = document.createElement("td");
        tdProp.textContent = c.PROPIETARIO || "";
        tr.appendChild(tdProp);

        const tdCentro = document.createElement("td");
        tdCentro.className = "col-centro";
        tdCentro.textContent = c.CENTRO || "";
        tr.appendChild(tdCentro);

        const tdProv = document.createElement("td");
        tdProv.textContent = c.PROVINCIA || "";
        tr.appendChild(tdProv);

        const tdDel = document.createElement("td");
        tdDel.textContent = c.DELEGADOS || "";
        tr.appendChild(tdDel);

        const tdTip = document.createElement("td");
        const spanTip = document.createElement("span");
        spanTip.className = "pill pill-corner";
        spanTip.textContent = c.TIPOLOGIA || "";
        tdTip.appendChild(spanTip);
        tr.appendChild(tdTip);

        const tdAar = document.createElement("td");
        const selAar = document.createElement("select");
        selAar.className = "meta-select";
        selAar.style.fontSize = "11px";
        selAar.innerHTML = `<option value="">‚Äî</option><option value="S√≠">S√≠</option><option value="No">No</option>`;
        selAar.value = c.CENTRO_AAR || "";
        selAar.addEventListener("change", () => {
          const code = c.CODIGO;
          if (!estado[code]) estado[code] = { informes: [] };
          estado[code].centroAAR = selAar.value;
          c.CENTRO_AAR = selAar.value;
          guardarEstado();
          if (centroSeleccionadoCodigo === code) {
            document.getElementById("metaCentroAAR").value = selAar.value || "";
          }
        });
        tdAar.appendChild(selAar);
        tr.appendChild(tdAar);

        const tdVisita = document.createElement("td");
        tdVisita.className = "col-visit-cell";
        const vGroup = document.createElement("div");
        vGroup.className = "visita-group";
        const inputDate = document.createElement("input");
        inputDate.type = "date";
        inputDate.className = "visita-input";
        if (c.VISITA) {
          inputDate.value = c.VISITA;
          tdVisita.classList.add("visita-guardada");
        }
        const btnSave = document.createElement("button");
        btnSave.className = "btn btn-outline btn-sm";
        btnSave.textContent = "Guardar";

        const selEstado = document.createElement("select");
        selEstado.className = "estado-select";
        selEstado.innerHTML =
          '<option value="pendiente">Pendiente</option><option value="anulada">Anulada</option>';
        selEstado.value = c.VISITA_ESTADO || "pendiente";

        btnSave.addEventListener("click", () => {
          const valor = inputDate.value;
          if (!valor) {
            alert("Selecciona una fecha de visita antes de guardar.");
            return;
          }
          const code = c.CODIGO;
          if (!estado[code]) estado[code] = { informes: [] };
          estado[code].visita = valor;
          estado[code].visitaEstado = selEstado.value || "pendiente";
          guardarEstado();
          aplicarEstadoALosCentros();
          renderTabla(document.getElementById("searchInput").value);
          actualizarResumen();
        });

        selEstado.addEventListener("change", () => {
          const code = c.CODIGO;
          if (!estado[code]) estado[code] = { informes: [] };
          estado[code].visitaEstado = selEstado.value;
          c.VISITA_ESTADO = selEstado.value;
          guardarEstado();
          actualizarResumen();
        });

        vGroup.appendChild(inputDate);
        vGroup.appendChild(btnSave);
        vGroup.appendChild(selEstado);
        tdVisita.appendChild(vGroup);
        tr.appendChild(tdVisita);

        const tdInforme = document.createElement("td");
        const cont = document.createElement("div");
        cont.style.display = "flex";
        cont.style.flexDirection = "column";
        cont.style.gap = "3px";
        const filaA = document.createElement("div");
        filaA.style.display = "flex";
        filaA.style.gap = "4px";
        filaA.style.flexWrap = "wrap";
        const filaB = document.createElement("div");
        filaB.className = "text-muted";

        const eC = estado[c.CODIGO] || { informes: [] };
        const numInf = (eC.informes || []).length;

        if (!numInf) {
          if (c.VISITA) {
            const btnCrear = document.createElement("button");
            btnCrear.className = "pill pill-crear";
            btnCrear.textContent = "Crear";
            btnCrear.addEventListener("click", () => crearInformeParaCentro(c));
            filaA.appendChild(btnCrear);
            filaB.textContent = "Sin informes previos.";
          } else {
            filaB.textContent = "Sin visita guardada.";
          }
        } else {
          if (c.INFORME_ESTADO === "finalizado") {
            const icon = document.createElement("span");
            icon.className = "icon-finalizado";
            icon.textContent = "‚úÖ";
            filaB.appendChild(icon);
            const span = document.createElement("span");
            span.textContent =
              "  (" +
              numInf +
              " en hist√≥rico, √∫ltimo " +
              (c.ULTIMO_INFORME_FECHA ? formatearFechaCorta(c.ULTIMO_INFORME_FECHA) : "-") +
              ")";
            filaB.appendChild(span);
          } else {
            filaB.textContent = `En edici√≥n (${numInf}).`;
          }

          if (c.VISITA) {
            const btnCrear = document.createElement("button");
            btnCrear.className = "pill pill-crear";
            btnCrear.textContent = "Crear";
            btnCrear.addEventListener("click", () => crearInformeParaCentro(c));
            filaA.appendChild(btnCrear);
          }

          const btnHist = document.createElement("button");
          btnHist.className = "btn btn-outline btn-sm";
          btnHist.textContent = `Hist√≥rico (${numInf})`;
          btnHist.addEventListener("click", () => abrirHistoricoCentro(c.CODIGO));
          filaA.appendChild(btnHist);
        }

        cont.appendChild(filaA);
        cont.appendChild(filaB);
        tdInforme.appendChild(cont);
        tr.appendChild(tdInforme);

        const tdAud = document.createElement("td");
        tdAud.textContent = c.AUDIOLOGO || "";
        tr.appendChild(tdAud);

        const tdHoras = document.createElement("td");
        tdHoras.textContent = c.HORAS_SERVICIO || "";
        tr.appendChild(tdHoras);

        const tdResp = document.createElement("td");
        const selResp = document.createElement("select");
        selResp.className = "meta-select";
        selResp.style.fontSize = "11px";
        selResp.innerHTML =
          '<option value="">‚Äî</option><option value="Ariannys Rojas">Ariannys Rojas</option><option value="Sonia Guasque">Sonia Guasque</option>';
        selResp.value = c.RESP_AUDIO || "";
        selResp.addEventListener("change", () => {
          const code = c.CODIGO;
          if (!estado[code]) estado[code] = { informes: [] };
          estado[code].respAudio = selResp.value;
          c.RESP_AUDIO = selResp.value;
          guardarEstado();
          if (centroSeleccionadoCodigo === code) {
            document.getElementById("infRespAudioCentro").textContent = selResp.value || "‚Äî";
            document.getElementById("infRespAudioSelect").value = selResp.value || "";
          }
        });
        tdResp.appendChild(selResp);
        tr.appendChild(tdResp);

        tbody.appendChild(tr);
      });

      if (!filtrados.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 12;
        td.className = "text-muted";
        td.textContent = "No hay centros que coincidan con el filtro.";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    /* ========= RESUMEN / GRAFICA + CALENDARIO ========= */

    function actualizarResumen() {
      const total = centros.length;
      let visitas = 0;
      let informesFinal = 0;

      centros.forEach((c) => {
        if (c.VISITA) visitas++;
        if (c.INFORME_ESTADO === "finalizado") informesFinal++;
      });

      actualizarMiniSummaryChart(total, visitas, informesFinal);
      actualizarCalendarioVisitas();
    }

    function actualizarMiniSummaryChart(total, visitas, informesFinal) {
      const ctx = document.getElementById("miniSummaryChart").getContext("2d");
      if (miniSummaryChart) miniSummaryChart.destroy();
      miniSummaryChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Centros", "Visitas", "Informes"],
          datasets: [
            {
              data: [total, visitas, informesFinal],
              backgroundColor: [
                "rgba(59,130,246,0.9)",   // azul
                "rgba(234,179,8,0.9)",    // √°mbar
                "rgba(34,197,94,0.9)",    // verde
              ],
            },
          ],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: "#9ca3af", font: { size: 9 } },
              grid: { color: "#1f2937" },
            },
            x: {
              ticks: { color: "#9ca3af", font: { size: 9 } },
              grid: { display: false },
            },
          },
        },
      });
    }

    function obtenerMapaEstadosVisitas() {
      const map = {};
      const priority = { anulada: 1, pendiente: 2, realizada: 3 };

      centros.forEach((c) => {
        if (!c.VISITA) return;
        const code = c.CODIGO;
        const e = estado[code] || {};
        let st = e.visitaEstado || "pendiente";
        if (c.INFORME_ESTADO === "finalizado") st = "realizada";
        const dateStr = c.VISITA; // YYYY-MM-DD
        if (!map[dateStr] || priority[st] > priority[map[dateStr]]) {
          map[dateStr] = st;
        }
      });
      return map;
    }

    function actualizarCalendarioVisitas() {
      const grid = document.getElementById("calendarGrid");
      if (!grid) return;
      grid.innerHTML = "";

      const statusMap = obtenerMapaEstadosVisitas();
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth(); // 0-11

      const weekdayNames = ["L", "M", "X", "J", "V", "S", "D"];
      weekdayNames.forEach((d) => {
        const div = document.createElement("div");
        div.className = "calendar-day-header";
        div.textContent = d;
        grid.appendChild(div);
      });

      const firstDay = (new Date(year, month, 1).getDay() + 6) % 7; // lunes=0
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        const div = document.createElement("div");
        grid.appendChild(div);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const div = document.createElement("div");
        div.className = "calendar-cell";
        div.textContent = d;
        const dateStr =
          year +
          "-" +
          String(month + 1).padStart(2, "0") +
          "-" +
          String(d).padStart(2, "0");
        const st = statusMap[dateStr];
        if (st === "pendiente") div.classList.add("calendar-cell-pendiente");
        else if (st === "realizada") div.classList.add("calendar-cell-realizada");
        else if (st === "anulada") div.classList.add("calendar-cell-anulada");
        grid.appendChild(div);
      }
    }

    /* ========= CARGA EXCEL CENTROS ========= */

    function manejarExcel(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        const mapped = json.map((row) => ({
          CODIGO: row["CODIGO"] || "",
          PROPIETARIO: row["PROPIETARIO"] || "",
          CENTRO: row["CENTRO"] || "",
          PROVINCIA: row["PROVINCIA"] || "",
          DELEGADOS: row["DELEGADOS"] || "",
          TIPOLOGIA:
            row["Tpolog√≠a"] || row["Tipolog√≠a"] || row["TIPOLOGIA"] || "",
          CENTRO_AAR: row["Centro AAR"] || "",
          VISITA: "",
          AUDIOLOGO: row["Audi√≥logo"] || "",
          HORAS_SERVICIO: row["Horas de servicio"] || "",
          RESP_AUDIO: row["Resp. Audio"] || "",
        }));
        centros = mapped;
        aplicarEstadoALosCentros();
        renderTabla(document.getElementById("searchInput").value);
        actualizarResumen();
      };
      reader.readAsArrayBuffer(file);
    }

    /* ========= INFORME ========= */

    function limpiarImagenesYChecklist() {
      ["imgPreview1", "imgPreview2", "imgPreview3"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = "";
      });
      ["imgInput1", "imgInput2", "imgInput3", "checklistInput"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      document.getElementById("checklistResumen").textContent =
        "Checklist no adjuntado todav√≠a.";

      if (radarChart) radarChart.destroy();
      if (mejoraChart) mejoraChart.destroy();
      if (kpiChart) kpiChart.destroy();
      radarChart = mejoraChart = kpiChart = null;

      renderChecklistDetalles(null);
    }

    function actualizarTipoVisitaUI(tv) {
      const btnA = document.getElementById("btnApertura");
      const btnS = document.getElementById("btnSeguimiento");
      btnA.classList.toggle("active", !!(tv && tv.apertura));
      btnS.classList.toggle("active", !!(tv && tv.seguimiento));
    }

    function leerTipoVisitaDesdeUI() {
      const btnA = document.getElementById("btnApertura");
      const btnS = document.getElementById("btnSeguimiento");
      return {
        apertura: btnA.classList.contains("active"),
        seguimiento: btnS.classList.contains("active"),
      };
    }

    function setInformeEditable(editable) {
      const ids = [
        "metaTipoCentro",
        "metaCentroAAR",
        "infRespAudioSelect",
        "infAudiologo",
        "infHorasServicio",
        "checklistInput",
        "imgInput1",
        "imgInput2",
        "imgInput3",
        "imgObs12",
        "imgObs3",
        "imgObsGeneral",
        "informeObservaciones",
        "informeRecomendaciones",
        "informeCompromisos",
      ];
      ids.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.disabled = !editable;
      });
      const tvRow = document.querySelector(".tipo-visita-row");
      if (tvRow) {
        tvRow.style.pointerEvents = editable ? "auto" : "none";
        tvRow.style.opacity = editable ? "1" : "0.6";
      }
      document.getElementById("btnGuardarBorrador").style.display =
        editable ? "inline-flex" : "none";
      document.getElementById("btnGuardarFinal").style.display =
        editable ? "inline-flex" : "none";
    }

    function cargarCentroEnInforme(codigo, informeId, soloLecturaForzado = false) {
      const centro = centros.find((c) => c.CODIGO === codigo);
      const badge = document.getElementById("informeEstadoBadge");
      const empty = document.getElementById("informeEmpty");
      const cont = document.getElementById("informeContenido");

      if (!centro) {
        badge.textContent = "Centro no encontrado";
        empty.style.display = "block";
        cont.style.display = "none";
        return;
      }

      const e = estado[codigo] || { informes: [] };
      e.informes = e.informes || [];
      let inf = e.informes.find((i) => i.id === informeId);
      if (!inf) inf = e.informes[e.informes.length - 1];
      if (!inf) {
        badge.textContent = "No hay informe para mostrar";
        empty.style.display = "block";
        cont.style.display = "none";
        return;
      }

      centroSeleccionadoCodigo = codigo;
      currentInformeId = inf.id;

      empty.style.display = "none";
      cont.style.display = "block";

      document.getElementById("metaCentro").value = centro.CENTRO || "";
      document.getElementById("metaDelegado").value = centro.DELEGADOS || "";
      document.getElementById("metaTipoCentro").value = inf.checklistTipo || "";
      document.getElementById("metaCentroAAR").value = centro.CENTRO_AAR || "";
      document.getElementById("metaFechaVisita").value = centro.VISITA || "";

      const respAudio =
        (estado[codigo] && estado[codigo].respAudio) || centro.RESP_AUDIO || "";
      document.getElementById("infRespAudioSelect").value = respAudio;
      document.getElementById("infRespAudioCentro").textContent = respAudio || "‚Äî";

      document.getElementById("infCodigo").textContent = centro.CODIGO || "";
      document.getElementById("infProvincia").textContent = centro.PROVINCIA || "";
      document.getElementById("infPropietario").textContent = centro.PROPIETARIO || "";

      document.getElementById("infAudiologo").value = inf.audiologo || "";
      document.getElementById("infHorasServicio").value =
        inf.horasServicio || centro.HORAS_SERVICIO || "";
      document.getElementById("imgObs12").value = inf.imgObs12 || "";
      document.getElementById("imgObs3").value = inf.imgObs3 || "";
      document.getElementById("imgObsGeneral").value = inf.imgObsGeneral || "";
      document.getElementById("informeObservaciones").value =
        inf.observaciones || "";
      document.getElementById("informeRecomendaciones").value =
        inf.recomendaciones || "";
      document.getElementById("informeCompromisos").value =
        inf.compromisos || "";
      document.getElementById("checklistResumen").textContent =
        inf.checklistResumen || "Checklist no adjuntado todav√≠a.";

      actualizarTipoVisitaUI(inf.tipoVisita || {});

      limpiarImagenesYChecklist();
      if (inf.checklistMetrics && inf.checklistDetalles) {
        renderChecklistCharts(inf.checklistMetrics, inf.checklistDetalles);
        document.getElementById("checklistResumen").textContent =
          inf.checklistResumen || "";
      }

      const soloLectura = soloLecturaForzado || inf.estado === "finalizado";
      setInformeEditable(!soloLectura);
      badge.textContent =
        inf.estado === "finalizado" ? "Informe finalizado" : "Informe en edici√≥n";
    }

    function crearInformeParaCentro(c) {
      if (!c.VISITA) {
        alert("Primero guarda una fecha de visita para este centro.");
        return;
      }
      const code = c.CODIGO;
      if (!estado[code]) estado[code] = { informes: [] };
      const e = estado[code];
      e.informes = e.informes || [];

      const id = "INF-" + Date.now().toString();
      const nuevo = {
        id,
        fechaCreacion: new Date().toISOString(),
        fechaVisita: c.VISITA || "",
        estado: "borrador",
        audiologo: "",
        horasServicio: "",
        tipoVisita: { apertura: false, seguimiento: false },
        observaciones: "",
        recomendaciones: "",
        compromisos: "",
        checklistResumen: "",
        checklistTipo: null,
        checklistMetrics: null,
        checklistDetalles: null,
        imgObs12: "",
        imgObs3: "",
        imgObsGeneral: "",
      };
      e.informes.push(nuevo);
      guardarEstado();
      aplicarEstadoALosCentros();
      renderTabla(document.getElementById("searchInput").value);
      actualizarResumen();
      cargarCentroEnInforme(code, id, false);

      document.getElementById("infAudiologo").focus();
      document
        .getElementById("cardInformeVisita")
        .scrollIntoView({ behavior: "smooth" });
    }

    /* ========= CHECKLIST Y GR√ÅFICOS ========= */

    function renderChecklistCharts(metrics, detalles) {
      const radarCtx = document.getElementById("radarChart").getContext("2d");
      const mejoraCtx = document.getElementById("mejoraChart").getContext("2d");
      const kpiCtx = document.getElementById("kpiChart").getContext("2d");

      if (radarChart) radarChart.destroy();
      if (mejoraChart) mejoraChart.destroy();
      if (kpiChart) kpiChart.destroy();

      const aplic = metrics && metrics.aplicProc != null ? metrics.aplicProc : 0;
      const convP = metrics && metrics.convPrueba != null ? metrics.convPrueba : 0;
      const convV = metrics && metrics.convVenta != null ? metrics.convVenta : 0;
      const formaciones = aplic;

      radarChart = new Chart(radarCtx, {
        type: "radar",
        data: {
          labels: ["Aplicaci√≥n procesos", "Formaciones", "Conv. prueba", "Conv. venta"],
          datasets: [
            {
              data: [aplic, formaciones, convP, convV],
              borderColor: "rgba(248,113,113,1)",
              backgroundColor: "rgba(248,113,113,0.2)",
              pointBackgroundColor: "rgba(248,113,113,1)",
            },
          ],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            r: {
              beginAtZero: true,
              angleLines: { color: "#1f2937" },
              grid: { color: "#1f2937" },
              pointLabels: { color: "#9ca3af", font: { size: 9 } },
              ticks: { display: false },
            },
          },
        },
      });

      let mejoras = [];
      if (detalles && detalles.length) {
        mejoras = detalles.filter((d) => d.aplica === 0 || d.aplica === "0").slice(0, 5);
      }
      if (!mejoras.length) {
        mejoras = [{ criterio: "Sin procesos pendientes", aplica: 0 }];
      }

      mejoraChart = new Chart(mejoraCtx, {
        type: "bar",
        data: {
          labels: mejoras.map((d) => d.criterio),
          datasets: [
            {
              data: mejoras.map(() => 100),
              backgroundColor: "rgba(239,68,68,0.9)", // rojo
            },
          ],
        },
        options: {
          indexAxis: "y",
          plugins: { legend: { display: false } },
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              ticks: { color: "#9ca3af", font: { size: 9 } },
              grid: { color: "#1f2937" },
            },
            y: {
              ticks: { color: "#9ca3af", font: { size: 9 } },
              grid: { display: false },
            },
          },
        },
      });

      const hit = metrics && metrics.aplicaHIT != null ? (metrics.aplicaHIT ? 100 : 0) : 0;
      kpiChart = new Chart(kpiCtx, {
        type: "bar",
        data: {
          labels: ["HIT", "Aplic. procesos", "Conv. prueba", "Conv. venta"],
          datasets: [
            {
              data: [hit, aplic, convP, convV],
              backgroundColor: [
                "rgba(239,68,68,0.9)",   // rojo
                "rgba(59,130,246,0.9)",  // azul
                "rgba(34,197,94,0.9)",   // verde
                "rgba(249,115,22,0.9)",  // naranja
              ],
            },
          ],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: "#9ca3af", font: { size: 9 } },
              grid: { color: "#1f2937" },
            },
            x: {
              ticks: { color: "#9ca3af", font: { size: 9 } },
              grid: { display: false },
            },
          },
        },
      });

      renderChecklistDetalles(detalles);
    }

    function renderChecklistDetalles(detalles) {
      const cont = document.getElementById("checklistDetallesContenido");
      const tbody = document.querySelector("#checklistDetallesTabla tbody");
      const vacio = document.getElementById("checklistDetallesVacio");
      tbody.innerHTML = "";

      if (!detalles || !detalles.length) {
        cont.style.display = "none";
        vacio.style.display = "block";
        return;
      }

      detalles.forEach((d, idx) => {
        const tr = document.createElement("tr");
        const tdIdx = document.createElement("td");
        tdIdx.textContent = idx + 1;
        const tdCrit = document.createElement("td");
        tdCrit.textContent = d.criterio || "";
        const tdAplica = document.createElement("td");
        const v = d.aplica === 1 || d.aplica === "1" ? "S√≠ (1)" : "No aplica (0)";
        tdAplica.textContent = v;
        tr.appendChild(tdIdx);
        tr.appendChild(tdCrit);
        tr.appendChild(tdAplica);
        tbody.appendChild(tr);
      });

      cont.style.display = "block";
      vacio.style.display = "none";
    }

    function manejarChecklist(file) {
      if (!centroSeleccionadoCodigo || !currentInformeId) {
        alert("Selecciona primero un centro e informe (bot√≥n 'Crear').");
        const inp = document.getElementById("checklistInput");
        if (inp) inp.value = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];

        // Tipo desde el desplegable
        let tipo = document.getElementById("metaTipoCentro").value || null;

        const nameUpper = file.name.toUpperCase();
        if (!tipo) {
          if (nameUpper.includes("CORNER")) tipo = "CORNER";
          else if (nameUpper.includes("EXCLUSIVO")) tipo = "EXCLUSIVO";
        }
        if (!tipo) {
          const centro = centros.find((c) => c.CODIGO === centroSeleccionadoCodigo);
          const t = (centro?.TIPOLOGIA || "").toUpperCase();
          if (t.includes("CORNER") || t.includes("C√ìRNER")) tipo = "CORNER";
          else if (t.includes("EXCLUSIVO")) tipo = "EXCLUSIVO";
        }
        if (!tipo) tipo = "CORNER"; // √∫ltimo recurso

        document.getElementById("metaTipoCentro").value = tipo;

        let metrics = {};
        let detalles = [];

        if (tipo === "CORNER") {
          for (let row = 7; row <= 88; row++) {
            const critCell = sheet["B" + row];
            const valCell = sheet["F" + row];
            if (!critCell || !valCell) continue;
            const v = parseFloat(valCell.v);
            if (v !== 0 && v !== 1) continue;
            detalles.push({ criterio: String(critCell.v), aplica: v });
          }
          let aplicProc = leerNumeroCelda(sheet, "F90");
          if (aplicProc == null && detalles.length) {
            const total = detalles.length;
            const aplica = detalles.filter((d) => d.aplica === 1).length;
            aplicProc = (aplica / total) * 100;
          }
          const aplicaHIT = boolDesdeCelda(sheet["F63"]);
          const convPrueba = leerNumeroCelda(sheet, "B92");
          const convVenta = leerNumeroCelda(sheet, "B93");
          metrics = { aplicProc, aplicaHIT, convPrueba, convVenta };
        } else {
          for (let row = 8; row <= 102; row++) {
            const critCell = sheet["B" + row];
            const valCell = sheet["F" + row];
            if (!critCell || !valCell) continue;
            const v = parseFloat(valCell.v);
            if (v !== 0 && v !== 1) continue;
            detalles.push({ criterio: String(critCell.v), aplica: v });
          }
          let aplicProc = leerNumeroCelda(sheet, "F104");
          if (aplicProc == null && detalles.length) {
            const total = detalles.length;
            const aplica = detalles.filter((d) => d.aplica === 1).length;
            aplicProc = (aplica / total) * 100;
          }
          const aplicaHIT = boolDesdeCelda(sheet["F65"]);
          const convPrueba = leerNumeroCelda(sheet, "I126");
          const convVenta = leerNumeroCelda(sheet, "I127");
          metrics = { aplicProc, aplicaHIT, convPrueba, convVenta };
        }

        const partes = [];
        partes.push(`Checklist ${tipo} cargado (${file.name}).`);
        if (metrics.aplicProc != null)
          partes.push(`% aplicaci√≥n procesos: ${metrics.aplicProc.toFixed(1)}.`);
        if (metrics.convPrueba != null)
          partes.push(`Conv. a prueba: ${metrics.convPrueba}.`);
        if (metrics.convVenta != null)
          partes.push(`Conv. a venta: ${metrics.convVenta}.`);
        if (metrics.aplicaHIT != null)
          partes.push(`Aplica HIT: ${metrics.aplicaHIT ? "S√≠" : "No"}.`);

        document.getElementById("checklistResumen").textContent = partes.join(" ");

        renderChecklistCharts(metrics, detalles);

        const eCentro = estado[centroSeleccionadoCodigo];
        if (eCentro) {
          const inf = (eCentro.informes || []).find((i) => i.id === currentInformeId);
          if (inf) {
            inf.checklistResumen = partes.join(" ");
            inf.checklistTipo = tipo;
            inf.checklistMetrics = metrics;
            inf.checklistDetalles = detalles;
            guardarEstado();
          }
        }
      };
      reader.readAsArrayBuffer(file);
    }

    /* ========= GUARDAR INFORME ========= */

    function guardarInforme(finalizar) {
      if (!centroSeleccionadoCodigo || !currentInformeId) {
        alert("Selecciona primero un centro e informe.");
        return;
      }
      const code = centroSeleccionadoCodigo;
      const e = estado[code];
      if (!e) return;
      const inf = (e.informes || []).find((i) => i.id === currentInformeId);
      if (!inf) return;

      inf.audiologo = document.getElementById("infAudiologo").value.trim();
      inf.horasServicio = document.getElementById("infHorasServicio").value.trim();
      inf.tipoVisita = leerTipoVisitaDesdeUI();
      inf.observaciones = document.getElementById("informeObservaciones").value.trim();
      inf.recomendaciones = document
        .getElementById("informeRecomendaciones")
        .value.trim();
      inf.compromisos = document.getElementById("informeCompromisos").value.trim();
      inf.imgObs12 = document.getElementById("imgObs12").value.trim();
      inf.imgObs3 = document.getElementById("imgObs3").value.trim();
      inf.imgObsGeneral = document.getElementById("imgObsGeneral").value.trim();

      const respSel = document.getElementById("infRespAudioSelect").value;
      if (respSel) {
        e.respAudio = respSel;
        const centro = centros.find((c) => c.CODIGO === code);
        if (centro) centro.RESP_AUDIO = respSel;
      }

      if (finalizar) {
        inf.estado = "finalizado";
        inf.fechaFinalizacion = new Date().toISOString();
      } else {
        inf.estado = inf.estado || "borrador";
      }

      guardarEstado();
      aplicarEstadoALosCentros();
      renderTabla(document.getElementById("searchInput").value);
      actualizarResumen();

      document.getElementById("informeEstadoBadge").textContent = finalizar
        ? "Informe finalizado"
        : "Informe guardado";

      if (finalizar) setInformeEditable(false);

      alert(
        finalizar
          ? `Informe finalizado para el centro ${code}.`
          : `Borrador de informe guardado para el centro ${code}.`
      );
    }

    /* ========= HIST√ìRICO ========= */

    function abrirHistoricoCentro(codigo) {
      const modal = document.getElementById("historicoModal");
      const lista = document.getElementById("historicoLista");
      const centro = centros.find((c) => c.CODIGO === codigo);
      const e = estado[codigo] || { informes: [] };
      const informes = e.informes || [];

      document.getElementById("historicoTitulo").textContent =
        "Hist√≥rico de visitas e informes ¬∑ " +
        codigo +
        " ¬∑ " +
        (centro ? centro.CENTRO : "");

      lista.innerHTML = "";

      if (!informes.length) {
        const p = document.createElement("p");
        p.className = "text-muted";
        p.textContent = "Este centro a√∫n no tiene informes registrados.";
        lista.appendChild(p);
      } else {
        informes.forEach((inf) => {
          const item = construirFilaHistorico(centro, inf);
          lista.appendChild(item);
        });
      }

      modal.style.display = "flex";
    }

    function abrirHistoricoGlobal() {
      const modal = document.getElementById("historicoModal");
      const lista = document.getElementById("historicoLista");
      const titulo = document.getElementById("historicoTitulo");
      titulo.textContent = "Hist√≥rico global de visitas e informes";

      lista.innerHTML = "";
      let totalRegistros = 0;

      centros.forEach((c) => {
        const e = estado[c.CODIGO] || { informes: [] };
        const infs = e.informes || [];
        infs.forEach((inf) => {
          const item = construirFilaHistorico(c, inf);
          lista.appendChild(item);
          totalRegistros++;
        });
      });

      if (!totalRegistros) {
        const p = document.createElement("p");
        p.className = "text-muted";
        p.textContent = "Todav√≠a no hay visitas ni informes registrados.";
        lista.appendChild(p);
      }

      modal.style.display = "flex";
    }

    function construirFilaHistorico(centro, inf) {
      const item = document.createElement("div");
      item.className = "historico-item";

      const text = document.createElement("div");
      text.className = "historico-text";

      const l1 = document.createElement("div");
      const fechaVisita = inf.fechaVisita
        ? formatearFechaCorta(inf.fechaVisita)
        : "sin fecha";
      l1.textContent = `${centro.CODIGO} ¬∑ ${centro.CENTRO} ¬∑ Visita: ${fechaVisita} ¬∑ Estado: ${
        inf.estado === "finalizado" ? "Finalizado" : "Borrador"
      }`;

      const l2 = document.createElement("div");
      l2.className = "historico-tag";
      l2.textContent = `Creado: ${formatearFechaCorta(
        inf.fechaCreacion
      )} ¬∑ √öltima actualizaci√≥n: ${
        inf.fechaFinalizacion ? formatearFechaCorta(inf.fechaFinalizacion) : "-"
      }`;

      text.appendChild(l1);
      text.appendChild(l2);

      const acc = document.createElement("div");
      acc.style.display = "flex";
      acc.style.gap = "4px";

      const btnVer = document.createElement("button");
      btnVer.className = "btn btn-outline btn-sm";
      btnVer.textContent = "Ver";
      btnVer.addEventListener("click", () => {
        document.getElementById("historicoModal").style.display = "none";
        cargarCentroEnInforme(centro.CODIGO, inf.id, inf.estado === "finalizado");
        document
          .getElementById("cardInformeVisita")
          .scrollIntoView({ behavior: "smooth" });
      });

      const btnImp = document.createElement("button");
      btnImp.className = "btn btn-primary btn-sm";
      btnImp.textContent = "Imprimir";
      btnImp.addEventListener("click", () => {
        document.getElementById("historicoModal").style.display = "none";
        cargarCentroEnInforme(centro.CODIGO, inf.id, true);
        setTimeout(() => window.print(), 300);
      });

      acc.appendChild(btnVer);
      acc.appendChild(btnImp);

      item.appendChild(text);
      item.appendChild(acc);
      return item;
    }

    function cerrarHistorico() {
      document.getElementById("historicoModal").style.display = "none";
    }

    /* ========= ZOOM IMAGEN ========= */

    function abrirZoomImagen(src) {
      const overlay = document.getElementById("imgZoomOverlay");
      const img = document.getElementById("imgZoomImage");
      img.src = src;
      overlay.style.display = "flex";
    }

    function cerrarZoomImagen() {
      document.getElementById("imgZoomOverlay").style.display = "none";
    }

    function setupImagenInput(inputId, previewId, maxImgs) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      if (!input || !preview) return;
      input.addEventListener("change", () => {
        const files = Array.from(input.files || []).slice(0, maxImgs);
        preview.innerHTML = "";
        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const img = document.createElement("img");
            img.src = ev.target.result;
            img.className = "img-thumb";
            img.addEventListener("click", () => abrirZoomImagen(img.src));
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });
    }

    /* ========= TEMA CLARO/OSCURO ========= */

    function aplicarTemaDesdeStorage() {
      const saved = localStorage.getItem("InformeAudioThemeMode") || "dark";
      if (saved === "light") {
        document.body.classList.add("light-mode");
        document.getElementById("btnTheme").textContent = "üåô";
      } else {
        document.body.classList.remove("light-mode");
        document.getElementById("btnTheme").textContent = "‚òÄÔ∏è";
      }
    }

    function toggleTheme() {
      const isLight = document.body.classList.toggle("light-mode");
      localStorage.setItem("InformeAudioThemeMode", isLight ? "light" : "dark");
      document.getElementById("btnTheme").textContent = isLight ? "üåô" : "‚òÄÔ∏è";
    }

    /* ========= INIT ========= */

    document.addEventListener("DOMContentLoaded", () => {
      estado = cargarEstado();
      centros = JSON.parse(JSON.stringify(demoData));
      aplicarEstadoALosCentros();
      renderTabla();
      actualizarResumen();
      aplicarTemaDesdeStorage();

      document
        .getElementById("searchInput")
        .addEventListener("input", (e) => renderTabla(e.target.value));

      document
        .getElementById("excelInput")
        .addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) manejarExcel(file);
        });

      document.getElementById("btnExport").addEventListener("click", () => {
        const payload = { fechaExport: new Date().toISOString(), centros, estado };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "informe-audio-estado.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById("btnReset").addEventListener("click", () => {
        if (
          !confirm("¬øSeguro que quieres borrar todas las visitas e informes guardados?")
        )
          return;
        localStorage.removeItem(STORAGE_KEY);
        estado = {};
        aplicarEstadoALosCentros();
        renderTabla(document.getElementById("searchInput").value);
        actualizarResumen();
        centroSeleccionadoCodigo = null;
        currentInformeId = null;
        document.getElementById("informeEmpty").style.display = "block";
        document.getElementById("informeContenido").style.display = "none";
        document.getElementById("informeEstadoBadge").textContent =
          "Sin centro seleccionado";
        limpiarImagenesYChecklist();
      });

      document
        .getElementById("checklistInput")
        .addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) manejarChecklist(file);
        });

      setupImagenInput("imgInput1", "imgPreview1", 1);
      setupImagenInput("imgInput2", "imgPreview2", 1);
      setupImagenInput("imgInput3", "imgPreview3", 3);

      document.getElementById("btnApertura").addEventListener("click", (e) => {
        e.target.classList.toggle("active");
      });
      document.getElementById("btnSeguimiento").addEventListener("click", (e) => {
        e.target.classList.toggle("active");
      });

      document
        .getElementById("btnGuardarBorrador")
        .addEventListener("click", () => guardarInforme(false));
      document
        .getElementById("btnGuardarFinal")
        .addEventListener("click", () => guardarInforme(true));

      document
        .getElementById("btnImprimirInforme")
        .addEventListener("click", () => {
          if (!centroSeleccionadoCodigo || !currentInformeId) {
            alert("Selecciona primero un informe para imprimir.");
            return;
          }
          cargarCentroEnInforme(centroSeleccionadoCodigo, currentInformeId, true);
          setTimeout(() => window.print(), 200);
        });

      document
        .getElementById("historicoCerrar")
        .addEventListener("click", cerrarHistorico);
      document
        .getElementById("historicoModal")
        .addEventListener("click", (e) => {
          if (e.target.id === "historicoModal") cerrarHistorico();
        });

      document
        .getElementById("imgZoomOverlay")
        .addEventListener("click", cerrarZoomImagen);

      document
        .getElementById("btnTheme")
        .addEventListener("click", toggleTheme);

      document
        .getElementById("navHistorico")
        .addEventListener("click", abrirHistoricoGlobal);

      // El dashboard general (navDashboard) usa los mismos datos; por ahora no cambia la vista,
      // solo sirve como recordatorio de que todo se alimenta del m√≥dulo Informe.
      document
        .getElementById("navDashboard")
        .addEventListener("click", () => {
          document
            .getElementById("cardInformeVisita")
            .scrollIntoView({ behavior: "smooth" });
        });
    });
  </script>
</body>
</html>
