<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Center Audio - Dashboard v5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #e5e7eb, #f9fafb 55%);
      --bg-card: #ffffff;
      --bg-card-soft: #f3f4f6;
      --text-main: #020617;
      --text-muted: #6b7280;
      --border-soft: #d4d4d8;
      --shadow-soft: 0 14px 30px rgba(15, 23, 42, 0.18);
      --accent-red: #ff2440;
      --accent-blue: #1d4ed8;
      --accent-green: #16a34a;
      --accent-orange: #ea580c;
    }

    body.dark {
      --bg-main: radial-gradient(circle at top left, #1f2937, #020617 55%);
      --bg-card: #0b1120;
      --bg-card-soft: #020617;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.65);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden; /* sin scroll */
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      display: flex;
    }

    /* SIDEBAR (negro fijo) */
    .sidebar {
      width: 250px;
      background: #020617;
      border-right: 1px solid #111827;
      padding: 18px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      color: #e5e7eb;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, var(--accent-red));
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.75);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: #9ca3af;
    }

    .section-title {
      font-size: .75rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .12em;
      margin-bottom: 8px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .88rem;
      color: #9ca3af;
      cursor: pointer;
      transition: all .18s ease;
    }

    .nav-item span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
    }

    /* activo en ROJO, como pediste */
    .nav-item.active {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
    }

    .nav-item.active span.icon {
      background: rgba(15, 23, 42, 0.2);
    }

    .nav-item:hover:not(.active) {
      background: rgba(31, 41, 55, 0.9);
      color: #e5e7eb;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: #9ca3af;
    }

    /* MAIN */
    .main {
      flex: 1;
      padding: 10px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 100vh;
      overflow: hidden;
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-input-wrapper {
      flex: 1;
      position: relative;
    }

    .search-input {
      width: 100%;
      background: #ffffff;
      border-radius: 999px;
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      font-size: .86rem;
      outline: none;
    }

    body.dark .search-input {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: .8rem;
      color: var(--text-muted);
    }

    .btn {
      border-radius: 999px;
      padding: 7px 12px;
      border: 1px solid transparent;
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e5e7eb;
      color: #111827;
      white-space: nowrap;
    }

    body.dark .btn {
      background: #020617;
      border-color: #1f2937;
      color: #e5e7eb;
    }

    .btn-cta {
      background: linear-gradient(90deg, var(--accent-red), #fb7185);
      color: #111827;
      font-weight: 600;
      box-shadow: 0 10px 24px rgba(248, 113, 113, 0.6);
    }

    .btn span.icon {
      font-size: .85rem;
    }

    #themeToggle {
      min-width: 110px;
      justify-content: center;
    }

    .filters-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .8rem;
      margin-top: 4px;
    }

    .filters-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filters-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .select {
      background: #ffffff;
      border-radius: 999px;
      padding: 5px 10px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      outline: none;
      font-size: .8rem;
    }

    body.dark .select {
      background: #020617;
      color: #e5e7eb;
      border-color: #1f2937;
    }

    .visits-chip {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-soft);
      font-size: .75rem;
      background: #f97316;
      color: #111827;
      font-weight: 600;
    }

    body.dark .visits-chip {
      background: #f97316;
      color: #111827;
      border-color: #1f2937;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .section-header h2 {
      font-size: 1.02rem;
      font-weight: 600;
    }

    .section-header span.sub {
      font-size: .76rem;
      color: var(--text-muted);
    }

    /* KPIs ‚Äì 7 cajas peque√±as */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
    }

    .card-kpi {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 8px 10px 8px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .card-kpi-title {
      font-size: .75rem;
      color: var(--text-muted);
    }

    .card-kpi-main {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }

    .card-kpi-value {
      font-size: 1.05rem;
      font-weight: 700;
    }

    .badge {
      font-size: .65rem;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(248, 113, 113, 0.12);
      color: var(--accent-red);
      border: 1px solid rgba(248, 113, 113, 0.6);
    }

    .badge.ok {
      background: rgba(22, 163, 74, 0.1);
      color: var(--accent-green);
      border-color: rgba(22, 163, 74, 0.6);
    }

    .card-kpi-foot {
      font-size: .68rem;
      color: var(--text-muted);
    }

    /* BLOQUE CENTRAL */
    .center-layout {
      display: grid;
      grid-template-rows: 210px 170px 150px;
      gap: 6px;
      flex: 1;
      min-height: 0;
    }

    .grid-main {
      display: grid;
      grid-template-columns: 2.1fr 1.2fr 1.2fr;
      gap: 6px;
      align-items: stretch;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px 10px 8px;
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .card h3 {
      font-size: .9rem;
      margin-bottom: 2px;
    }

    .card-sub {
      font-size: .72rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .chart-container {
      position: relative;
      height: 150px;
      width: 100%;
    }

    /* Ranking delegados con 7 KPI */
    .ranking-header,
    .ranking-row {
      display: grid;
      grid-template-columns: 1.35fr repeat(7, .6fr);
      font-size: .72rem;
      column-gap: 4px;
      align-items: center;
      padding: 3px 0;
    }

    .ranking-header {
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-soft);
      margin-bottom: 2px;
    }

    .ranking-row {
      border-radius: 8px;
      padding-inline: 4px;
      cursor: pointer;
    }

    .ranking-row:nth-child(even) {
      background: var(--bg-card-soft);
    }

    .ranking-row:hover {
      background: rgba(2, 6, 23, 0.06);
    }

    body.dark .ranking-row:nth-child(even) {
      background: #020617;
    }

    .ranking-row .delegado-nombre {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .ranking-row-color {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .ranking-details {
      display: none;
      font-size: .7rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .ranking-details span {
      margin-right: 10px;
    }

    /* Fald√≥n delegados inferior (leyenda de colores) */
    .delegados-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .delegados-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .delegados-header h3 {
      font-size: .9rem;
    }

    .delegados-header span {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .delegados-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 4px;
      font-size: .7rem;
    }

    .delegado-pill-bottom {
      border-radius: 999px;
      padding: 3px 6px;
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card);
      cursor: default;
    }

    .delegate-color-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <span class="logo-title">Control Center Audio</span>
        <span class="logo-subtitle">Dashboard de centros, visitas y KPIs</span>
      </div>
    </div>

    <div>
      <div class="section-title">Secciones</div>
      <nav class="nav-list">
        <div class="nav-item active">
          <span class="icon">üè†</span> Dashboard
        </div>
        <div class="nav-item">
          <span class="icon">üè¢</span> Centros
        </div>
        <div class="nav-item">
          <span class="icon">üë£</span> Visitas
        </div>
        <div class="nav-item">
          <span class="icon">üõ†</span> Servicios
        </div>
        <div class="nav-item">
          <span class="icon">üí≥</span> Ventas
        </div>
        <div class="nav-item">
          <span class="icon">üìä</span> Proyectos
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      <p>Versi√≥n demo ¬∑ Datos ficticios</p>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- Topbar -->
    <div class="topbar">
      <div class="search-input-wrapper">
        <span class="search-icon">üîç</span>
        <input class="search-input" placeholder="Busca centros, visitas, procesos..." />
      </div>
      <button class="btn" id="themeToggle">
        <span class="icon">üåì</span> Oscuro / Claro
      </button>
      <button class="btn">
        <span class="icon">üíæ</span> Guardar vista
      </button>
      <button class="btn">
        <span class="icon">‚¨áÔ∏è</span> Exportar HTML
      </button>
      <button class="btn btn-cta">
        <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
      </button>
    </div>

    <!-- Filtros + visitas -->
    <div class="filters-row">
      <div class="filters-left">
        <div class="visits-chip">
          Visitas: 316 / 384 centros ¬∑ Ene‚ÄìDic
        </div>
      </div>
      <div class="filters-right">
        <select class="select" id="delegadoSelect">
          <option value="global">Delegado: Todos</option>
        </select>
        <select class="select" id="centroSelect">
          <option value="todos">Centro: Todos</option>
        </select>
      </div>
    </div>

    <!-- Resumen general -->
    <div class="section-header">
      <h2>Resumen general KPIs</h2>
      <span class="sub">Promedio sobre el total visitado ¬∑ Procesos y calidad de ejecuci√≥n</span>
    </div>

    <!-- 7 KPIs -->
    <section class="kpi-grid">
      <div class="card-kpi" data-kpi="procesos">
        <div class="card-kpi-title">Procesos completados</div>
        <div class="card-kpi-main">
          <span class="card-kpi-value" id="kpiProcesos">78%</span>
          <span class="badge ok" id="kpiProcesosBadge">Objetivo 80%</span>
        </div>
        <div class="card-kpi-foot">Media general sobre todas las visitas.</div>
      </div>

      <div class="card-kpi" data-kpi="prueba">
        <div class="card-kpi-title">Conversi√≥n a prueba</div>
        <div class="card-kpi-main">
          <span class="card-kpi-value" id="kpiPrueba">46%</span>
        </div>
        <div class="card-kpi-foot">Pacientes que pasan a prueba de aud√≠fonos.</div>
      </div>

      <div class="card-kpi" data-kpi="cierre">
        <div class="card-kpi-title">Conversi√≥n cierre</div>
        <div class="card-kpi-main">
          <span class="card-kpi-value" id="kpiCierre">28%</span>
          <span class="badge" id="kpiCierreBadge">Reforzar cierre</span>
        </div>
        <div class="card-kpi-foot">Ventas sobre total de visitas.</div>
      </div>

      <div class="card-kpi" data-kpi="hit">
        <div class="card-kpi-title">Aplicaci√≥n HIT</div>
        <div class="card-kpi-main">
          <span class="card-kpi-value" id="kpiHit">82%</span>
        </div>
        <div class="card-kpi-foot">% visitas donde se aplica protocolo HIT.</div>
      </div>

      <div class="card-kpi" data-kpi="ayudas">
        <div class="card-kpi-title">Ayudas</div>
        <div class="card-kpi-main">
          <span class="card-kpi-value" id="kpiAyudas">41%</span>
        </div>
        <div class="card-kpi-foot">Operaciones con ayuda / subvenci√≥n.</div>
      </div>

      <div class="card-kpi" data-kpi="aar">
        <div class="card-kpi-title">AAR</div>
        <div class="card-kpi-main">
          <span class="card-kpi-value" id="kpiAar">64%</span>
        </div>
        <div class="card-kpi-foot">Adaptaciones en revisi√≥n sobre servicios.</div>
      </div>

      <div class="card-kpi" data-kpi="form">
        <div class="card-kpi-title">Formaciones</div>
        <div class="card-kpi-main">
          <span class="card-kpi-value" id="kpiForm">3,2</span>
          <span style="font-size:.7rem;">/delegado</span>
        </div>
        <div class="card-kpi-foot">Formaciones medias realizadas por delegado.</div>
      </div>
    </section>

    <!-- Bloque central -->
    <section class="center-layout">
      <!-- Gr√°ficas -->
      <section class="grid-main">
        <!-- Evoluci√≥n mensual -->
        <article class="card">
          <h3>Evoluci√≥n mensual de procesos (%)</h3>
          <p class="card-sub">
            Promedio mensual por visitas: Procesos, aplica HIT y no aplica (√°reas de mejora).
          </p>
          <div class="chart-container">
            <canvas id="chartEvolucion"></canvas>
          </div>
        </article>

        <!-- √Åreas de mejora -->
        <article class="card">
          <h3>√Åreas de mejora habituales</h3>
          <p class="card-sub">
            Top 10 motivos de mejora detectados sobre el total visitado.
          </p>
          <div class="chart-container">
            <canvas id="chartAreas"></canvas>
          </div>
        </article>

        <!-- Radar KPIs generales/contexto -->
        <article class="card">
          <h3>Radar KPIs</h3>
          <p class="card-sub">
            Perfil de KPIs globales (o del delegado/centro seleccionado).
          </p>
          <div class="chart-container">
            <canvas id="chartRadar"></canvas>
          </div>
        </article>
      </section>

      <!-- Ranking delegados -->
      <section class="card">
        <h3>Ranking de delegados</h3>
        <p class="card-sub">
          Promedio de KPIs sobre el total visitado por cada delegado ¬∑ clic para ver detalle.
        </p>
        <div class="ranking-header">
          <span>Delegado</span>
          <span>Proc.</span>
          <span>Conv. prueba</span>
          <span>Conv. cierre</span>
          <span>HIT</span>
          <span>Ayudas</span>
          <span>AAR</span>
          <span>Form.</span>
        </div>
        <div id="rankingBody"></div>
      </section>

      <!-- Fald√≥n delegados (leyenda de colores) -->
      <section class="delegados-section">
        <div class="delegados-header">
          <h3>Delegados ¬∑ leyenda de colores</h3>
          <span>Colores coherentes con ranking y filtros.</span>
        </div>
        <div class="delegados-grid" id="bottomDelegados"></div>
      </section>
    </section>
  </main>

  <script>
    // Toggle oscuro / claro
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });

    // Delegados y colores (Laura Ramos vs Laura Plazas diferenciadas)
    const delegados = {
      "Eneritz Aranguren": "#22c55e",
      "Laura Plazas": "#2563eb",
      "Laura Ramos": "#14b8a6",
      "Daniel Chazo": "#a855f7",
      "Manuel C√°novas": "#f97316",
      "Cecilia P√©rez": "#0ea5e9",
      "Martin Sebasti√°n": "#ef4444",
      "Marisa Carmona": "#eab308",
      "Blanca Fdez. de la Pradilla": "#ec4899",
      "Maribel Amezcua": "#facc15",
      "Sonia Godino": "#22d3ee",
      "Ver√≥nica Alfons√≠n": "#4ade80",
      "Sergio Per√°n": "#fb7185"
    };

    // KPIs globales (promedio sobre total visitado)
    const kpiGlobal = {
      procesos: 78,
      prueba: 46,
      cierre: 28,
      hit: 82,
      ayudas: 41,
      aar: 64,
      form: 3.2
    };

    // KPIs por delegado
    const kpiDelegados = {
      "Eneritz Aranguren":  { procesos:82, prueba:52, cierre:31, hit:88, ayudas:39, aar:67, form:4.2 },
      "Laura Plazas":       { procesos:79, prueba:49, cierre:29, hit:84, ayudas:41, aar:62, form:3.8 },
      "Laura Ramos":        { procesos:77, prueba:46, cierre:27, hit:82, ayudas:39, aar:60, form:3.4 },
      "Daniel Chazo":       { procesos:76, prueba:47, cierre:26, hit:80, ayudas:37, aar:58, form:3.5 },
      "Manuel C√°novas":     { procesos:74, prueba:44, cierre:25, hit:78, ayudas:42, aar:61, form:3.1 },
      "Cecilia P√©rez":      { procesos:81, prueba:51, cierre:30, hit:86, ayudas:43, aar:66, form:4.0 },
      "Martin Sebasti√°n":   { procesos:72, prueba:42, cierre:24, hit:75, ayudas:38, aar:57, form:2.9 },
      "Marisa Carmona":     { procesos:80, prueba:50, cierre:29, hit:85, ayudas:40, aar:63, form:3.7 },
      "Blanca Fdez. de la Pradilla": { procesos:78, prueba:48, cierre:28, hit:83, ayudas:44, aar:62, form:3.9 },
      "Maribel Amezcua":    { procesos:75, prueba:45, cierre:26, hit:79, ayudas:36, aar:59, form:3.0 },
      "Sonia Godino":       { procesos:73, prueba:43, cierre:25, hit:77, ayudas:35, aar:56, form:2.8 },
      "Ver√≥nica Alfons√≠n":  { procesos:79, prueba:49, cierre:28, hit:84, ayudas:41, aar:64, form:3.6 },
      "Sergio Per√°n":       { procesos:76, prueba:47, cierre:27, hit:81, ayudas:38, aar:60, form:3.2 }
    };

    // Centros por delegado (demo)
    const centrosPorDelegado = {
      "Eneritz Aranguren":  ["Barcelona Diagonal", "Lleida CC Carrefour", "Terrassa"],
      "Laura Plazas":       ["Cerdanyola", "Barcelona Sants", "Vic"],
      "Laura Ramos":        ["Madrid Xanad√∫", "Valdemoro", "Villaverde"],
      "Daniel Chazo":       ["Nar√≥n", "Ferrol Alcampo", "Lugo"],
      "Manuel C√°novas":     ["√Åguilas", "El Palmar", "Nueva Condomina"],
      "Cecilia P√©rez":      ["Carlet", "Alzira", "Nuevo Centro"],
      "Martin Sebasti√°n":   ["Alameda M√°laga", "C√≥rdoba Carrefour", "Estepona"],
      "Marisa Carmona":     ["Islazul", "La Gavia", "Madrid R√≠o 2"],
      "Blanca Fdez. de la Pradilla": ["Aravaca", "Gran Plaza 2", "Tres Cantos"],
      "Maribel Amezcua":    ["C√°ceres", "Camas", "Nevada Shopping"],
      "Sonia Godino":       ["Barakaldo", "Bilbao Correo", "San Sebasti√°n"],
      "Ver√≥nica Alfons√≠n":  ["Bouzas", "Castelao", "Gij√≥n"],
      "Sergio Per√°n":       ["La Vaguada", "Salamanca C/Toro", "Torrelavega"]
    };

    // √Åreas de mejora (top 10)
    const areasMejora = [
      { label: "Seguimiento postventa", valor: 38 },
      { label: "Comunicaci√≥n con ORL", valor: 34 },
      { label: "Aplicaci√≥n HIT incompleta", valor: 29 },
      { label: "Seguimiento AAR", valor: 27 },
      { label: "Registro en CRM", valor: 25 },
      { label: "Formaci√≥n insuficiente", valor: 23 },
      { label: "Argumentario comercial", valor: 21 },
      { label: "Tiempo medio de atenci√≥n", valor: 19 },
      { label: "Evaluaci√≥n cognitiva", valor: 17 },
      { label: "Uso de ayudas/subvenciones", valor: 16 }
    ];

    // Inicializar select Delegado y Centro
    const delegadoSelect = document.getElementById('delegadoSelect');
    const centroSelect = document.getElementById('centroSelect');

    Object.keys(delegados).forEach(nombre => {
      const opt = document.createElement('option');
      opt.value = nombre;
      opt.textContent = `Delegado: ${nombre}`;
      delegadoSelect.appendChild(opt);
    });

    function rellenarCentros(delegado) {
      centroSelect.innerHTML = '';
      const optTodos = document.createElement('option');
      optTodos.value = 'todos';
      optTodos.textContent = 'Centro: Todos';
      centroSelect.appendChild(optTodos);

      if (delegado !== 'global' && centrosPorDelegado[delegado]) {
        centrosPorDelegado[delegado].forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          centroSelect.appendChild(opt);
        });
      }
    }

    rellenarCentros('global');

    // Fald√≥n inferior de delegados (leyenda)
    const bottomDelegados = document.getElementById('bottomDelegados');
    Object.entries(delegados).forEach(([nombre, color]) => {
      const pill = document.createElement('div');
      pill.className = 'delegado-pill-bottom';
      pill.innerHTML = `<span class="delegate-color-dot" style="background:${color}"></span>${nombre}`;
      bottomDelegados.appendChild(pill);
    });

    // Ranking delegados
    const rankingBody = document.getElementById('rankingBody');
    Object.entries(kpiDelegados).forEach(([nombre, kpis]) => {
      const row = document.createElement('div');
      row.className = 'ranking-row';
      row.innerHTML = `
        <span class="delegado-nombre">
          <span class="ranking-row-color" style="background:${delegados[nombre]}"></span>${nombre}
        </span>
        <span>${kpis.procesos}%</span>
        <span>${kpis.prueba}%</span>
        <span>${kpis.cierre}%</span>
        <span>${kpis.hit}%</span>
        <span>${kpis.ayudas}%</span>
        <span>${kpis.aar}%</span>
        <span>${kpis.form.toFixed(1)}</span>
      `;
      const details = document.createElement('div');
      details.className = 'ranking-details';
      details.textContent = 'Centros destacados: ejemplo 1, ejemplo 2, ejemplo 3‚Ä¶';

      row.addEventListener('click', () => {
        details.style.display = details.style.display === 'block' ? 'none' : 'block';
      });

      rankingBody.appendChild(row);
      rankingBody.appendChild(details);
    });

    // BASE para evoluci√≥n mensual (global)
    const baseMensual = {
      procesos: [70,72,73,75,76,78,79,80,80,81,82,83],
      aplica:   [60,62,63,65,67,69,70,71,72,73,74,75],
      noAplica:[40,38,37,35,33,31,30,29,28,27,26,25]
    };

    function escalarSerie(serie, factor) {
      return serie.map(v => Math.round(v * factor));
    }

    // GR√ÅFICA Evoluci√≥n mensual
    const ctxEvo = document.getElementById('chartEvolucion').getContext('2d');
    const chartEvolucion = new Chart(ctxEvo, {
      type: 'line',
      data: {
        labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
        datasets: [
          {
            label: 'Procesos (%)',
            data: baseMensual.procesos,
            borderWidth: 2,
            tension: 0.35,
            borderColor: '#1d4ed8',
            backgroundColor: 'rgba(37,99,235,0.15)'
          },
          {
            label: 'Aplica HIT (%)',
            data: baseMensual.aplica,
            borderWidth: 2,
            tension: 0.35,
            borderColor: '#16a34a',
            backgroundColor: 'rgba(22,163,74,0.15)'
          },
          {
            label: 'No aplica (%)',
            data: baseMensual.noAplica,
            borderWidth: 2,
            tension: 0.35,
            borderColor: '#ea580c',
            backgroundColor: 'rgba(234,88,12,0.15)'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#6b7280', font: { size: 10 } }
          }
        },
        scales: {
          x: {
            ticks: { color: '#6b7280', font: { size: 9 } },
            grid: { color: 'rgba(148,163,184,0.4)' }
          },
          y: {
            ticks: { color: '#6b7280', font: { size: 9 }, callback: v => v + '%' },
            grid: { color: 'rgba(148,163,184,0.4)' },
            suggestedMin: 20,
            suggestedMax: 90
          }
        }
      }
    });

    // GR√ÅFICO √Åreas de mejora (barras horizontales)
    const ctxAreas = document.getElementById('chartAreas').getContext('2d');
    const chartAreas = new Chart(ctxAreas, {
      type: 'bar',
      data: {
        labels: areasMejora.map(a => a.label),
        datasets: [{
          label: '% de visitas con esta √°rea de mejora',
          data: areasMejora.map(a => a.valor),
          backgroundColor: '#ea580c'
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: ctx => ctx.parsed.x + '%'
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#6b7280',
              font: { size: 9 },
              callback: v => v + '%'
            },
            grid: { color: 'rgba(148,163,184,0.4)' }
          },
          y: {
            ticks: { color: '#6b7280', font: { size: 8 } },
            grid: { display: false }
          }
        }
      }
    });

    // RADAR KPIs (una sola l√≠nea seg√∫n contexto)
    const ctxRadar = document.getElementById('chartRadar').getContext('2d');
    const radarLabels = ['Procesos','Conv. prueba','Conv. cierre','HIT','Ayudas','AAR','Formaciones'];
    const chartRadar = new Chart(ctxRadar, {
      type: 'radar',
      data: {
        labels: radarLabels,
        datasets: [{
          label: 'KPIs globales',
          data: [
            kpiGlobal.procesos,
            kpiGlobal.prueba,
            kpiGlobal.cierre,
            kpiGlobal.hit,
            kpiGlobal.ayudas,
            kpiGlobal.aar,
            kpiGlobal.form * 10
          ],
          borderColor: '#16a34a',
          backgroundColor: 'rgba(22,163,74,0.25)',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#6b7280', font: { size: 9 } }
          }
        },
        scales: {
          r: {
            angleLines: { color: 'rgba(148,163,184,0.4)' },
            grid: { color: 'rgba(148,163,184,0.4)' },
            pointLabels: { color: '#6b7280', font: { size: 8 } },
            ticks: { display: false, beginAtZero: true }
          }
        }
      }
    });

    // Actualizar KPIs y gr√°ficas seg√∫n contexto (global / delegado / centro)
    function actualizarDashboard(contextKpi, labelRadar) {
      // KPIs
      document.getElementById('kpiProcesos').textContent = contextKpi.procesos + '%';
      document.getElementById('kpiPrueba').textContent   = contextKpi.prueba + '%';
      document.getElementById('kpiCierre').textContent   = contextKpi.cierre + '%';
      document.getElementById('kpiHit').textContent      = contextKpi.hit + '%';
      document.getElementById('kpiAyudas').textContent   = contextKpi.ayudas + '%';
      document.getElementById('kpiAar').textContent      = contextKpi.aar + '%';
      document.getElementById('kpiForm').textContent     = contextKpi.form.toFixed(1);

      // Badges m√≠nimos
      const procesosBadge = document.getElementById('kpiProcesosBadge');
      procesosBadge.textContent = `Objetivo 80%`;
      procesosBadge.className = 'badge ' + (contextKpi.procesos >= 80 ? 'ok' : '');

      const cierreBadge = document.getElementById('kpiCierreBadge');
      cierreBadge.textContent = contextKpi.cierre >= 30 ? 'Buen cierre' : 'Reforzar cierre';

      // Radar
      chartRadar.data.datasets[0].label = labelRadar;
      chartRadar.data.datasets[0].data = [
        contextKpi.procesos,
        contextKpi.prueba,
        contextKpi.cierre,
        contextKpi.hit,
        contextKpi.ayudas,
        contextKpi.aar,
        contextKpi.form * 10
      ];
      chartRadar.update();

      // Evoluci√≥n mensual: escalamos en funci√≥n de procesos delegados vs global
      const factor = contextKpi.procesos / kpiGlobal.procesos;
      chartEvolucion.data.datasets[0].data = escalarSerie(baseMensual.procesos, factor);
      chartEvolucion.data.datasets[1].data = escalarSerie(baseMensual.aplica, contextKpi.hit / kpiGlobal.hit);
      chartEvolucion.data.datasets[2].data = escalarSerie(baseMensual.noAplica, (100 - contextKpi.hit) / (100 - kpiGlobal.hit));
      chartEvolucion.update();
    }

    // Estado actual
    let contextoActual = 'global'; // 'global' | 'delegado' | 'centro'
    let delegadoActual = null;
    let centroActual = null;

    // Inicial global
    actualizarDashboard(kpiGlobal, 'KPIs globales');

    delegadoSelect.addEventListener('change', () => {
      const val = delegadoSelect.value;
      if (val === 'global') {
        contextoActual = 'global';
        delegadoActual = null;
        rellenarCentros('global');
        actualizarDashboard(kpiGlobal, 'KPIs globales');
      } else {
        contextoActual = 'delegado';
        delegadoActual = val;
        rellenarCentros(val);
        const kpi = kpiDelegados[val];
        actualizarDashboard(kpi, `KPIs ¬∑ ${val}`);
      }
    });

    centroSelect.addEventListener('change', () => {
      const val = centroSelect.value;
      centroActual = val;
      if (val === 'todos') {
        // Volvemos al contexto del delegado o global
        if (delegadoActual && kpiDelegados[delegadoActual]) {
          actualizarDashboard(kpiDelegados[delegadoActual], `KPIs ¬∑ ${delegadoActual}`);
        } else {
          actualizarDashboard(kpiGlobal, 'KPIs globales');
        }
      } else {
        // Centro seleccionado -> en demo usamos mismo perfil que su delegado
        if (delegadoActual && kpiDelegados[delegadoActual]) {
          actualizarDashboard(kpiDelegados[delegadoActual], `KPIs ¬∑ ${delegadoActual} ¬∑ ${val}`);
        }
      }
    });
  </script>
</body>
</html>
