<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Center Audio - Centros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-main: radial-gradient(circle at top left, #111827, #020617 55%);
      --bg-card: #020617;
      --bg-card-soft: #0b1120;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --accent-red: #ff2440;
      --accent-blue: #38bdf8;
      --accent-green: #22c55e;
      --accent-orange: #f97316;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      display: flex;
    }

    /* SIDEBAR */
    .sidebar {
      width: 250px;
      background: #020617;
      border-right: 1px solid #020617;
      padding: 18px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      color: #e5e7eb;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, var(--accent-red));
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: #9ca3af;
    }

    .section-title {
      font-size: .75rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .12em;
      margin-bottom: 8px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .88rem;
      color: #9ca3af;
      cursor: pointer;
      transition: all .18s ease;
    }

    .nav-item span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
    }

    .nav-item.active {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
    }

    .nav-item.active span.icon {
      background: rgba(15,23,42,.2);
    }

    .nav-item:hover:not(.active) {
      background: rgba(31,41,55,0.9);
      color: #e5e7eb;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: #9ca3af;
    }

    /* MAIN */
    .main {
      flex: 1;
      padding: 10px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 100vh;
      overflow: hidden;
    }

    .topbar {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 4px;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #020617;
      color: #e5e7eb;
      white-space: nowrap;
      box-shadow: none;
    }

    .btn-cta {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
      box-shadow: none;
      border-color: transparent;
    }

    .btn span.icon {
      font-size: .85rem;
    }

    #themeToggle {
      min-width: 110px;
      justify-content: center;
    }

    /* BUSCADOR CENTROS */
    .centros-search-row {
      margin-top: 2px;
    }

    .centros-search-wrapper {
      position: relative;
    }

    .centros-search-input {
      width: 100%;
      background: #020617;
      border-radius: 999px;
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      font-size: .86rem;
      outline: none;
    }

    .centros-search-input::placeholder {
      color: var(--text-muted);
    }

    .centros-search-wrapper .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: .8rem;
      color: var(--text-muted);
    }

    /* BLOQUE SUPERIOR: MAPA + DELEGADOS */
    .top-layout {
      display: grid;
      grid-template-columns: 1.7fr 1fr;
      gap: 10px;
      min-height: 220px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .card h3 {
      font-size: .9rem;
      margin-bottom: 4px;
    }

    .card-sub {
      font-size: .72rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    /* MAPA */
    .map-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .8rem;
    }

    .badge-small {
      font-size: .7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
      color: var(--text-muted);
      border: 1px solid var(--border-soft);
    }

    .map-body {
      flex: 1;
      background: #020617;
      border-radius: 12px;
      padding: 6px;
    }

    svg#spainMap {
      width: 100%;
      height: 100%;
      display: block;
    }

    .spain-shape {
      fill: #4b5563;
      stroke: #111827;
      stroke-width: 1.4;
      cursor: pointer;
    }

    .map-dot {
      stroke: #020617;
      stroke-width: 1;
      cursor: pointer;
    }

    .map-footer {
      font-size: .7rem;
      color: var(--text-muted);
      text-align: right;
    }

    /* PANEL DERECHA: DELEGADOS Y ACCIONES */
    .delegados-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .delegados-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: .76rem;
      max-height: 160px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .delegado-card {
      border-radius: 10px;
      background: #020617;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      cursor: pointer;
    }

    .delegado-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .delegado-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .delegado-color {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .delegado-count {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .delegado-centros {
      margin-top: 4px;
      font-size: .7rem;
      color: var(--text-muted);
      display: none;
    }

    .delegado-card.open .delegado-centros {
      display: block;
    }

    .delegado-card-bar {
      margin-top: 4px;
      height: 4px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .delegado-card-bar-inner {
      height: 100%;
    }

    .actions-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .summary-text {
      font-size: .74rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* TABLA */
    .table-wrapper {
      flex: 1;
      background: var(--bg-card);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .table-header {
      padding: 8px 10px 6px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .table-header h3 {
      font-size: .9rem;
    }

    .table-header span {
      font-size: .72rem;
      color: var(--text-muted);
    }

    .table-scroll {
      flex: 1;
      overflow: auto;
      border-top: 1px solid var(--border-soft);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .78rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 2;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #0b1120;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      font-size: .75rem;
      color: var(--text-muted);
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    tbody tr:hover {
      background: rgba(15,23,42,0.9);
    }

    .tag {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: .7rem;
      border: 1px solid var(--border-soft);
      background: #0b1120;
    }

    .tag.exclusivo {
      background: rgba(22,163,74,0.15);
      color: var(--accent-green);
      border-color: rgba(22,163,74,0.7);
    }

    .tag.corner {
      background: rgba(37,99,235,0.15);
      color: var(--accent-blue);
      border-color: rgba(37,99,235,0.7);
    }

    .tag-aar {
      background: rgba(148,163,184,0.15);
      border-color: rgba(148,163,184,0.7);
      color: var(--text-muted);
    }

    .tag-aar.si {
      background: rgba(34,197,94,0.15);
      border-color: rgba(34,197,94,0.7);
      color: var(--accent-green);
    }

    .tag-aar.formacion {
      background: rgba(234,179,8,0.15);
      border-color: rgba(234,179,8,0.7);
      color: #eab308;
    }

    .btn-link {
      border: none;
      background: transparent;
      color: var(--accent-blue);
      cursor: pointer;
      font-size: .74rem;
      text-decoration: underline;
    }

    /* MODALES */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #020617;
      border-radius: 14px;
      padding: 14px;
      width: 420px;
      max-width: 95%;
      border: 1px solid var(--border-soft);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      font-size: .95rem;
    }

    .modal-close {
      cursor: pointer;
      font-size: 1rem;
      color: var(--text-muted);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: .78rem;
    }

    .modal-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal-field label {
      font-size: .74rem;
      color: var(--text-muted);
    }

    .modal-field input,
    .modal-field select {
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #0b1120;
      color: var(--text-main);
      font-size: .78rem;
      outline: none;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
  </style>

  <!-- Librer√≠a para leer Excel en el navegador -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <span class="logo-title">Control Center Audio</span>
        <span class="logo-subtitle">Gesti√≥n de centros y delegados</span>
      </div>
    </div>

    <div>
      <div class="section-title">Secciones</div>
      <nav class="nav-list">
        <div class="nav-item">
          <span class="icon">üè†</span> Dashboard
        </div>
        <div class="nav-item active">
          <span class="icon">üè¢</span> Centros
        </div>
        <div class="nav-item">
          <span class="icon">üë£</span> Visitas
        </div>
        <div class="nav-item">
          <span class="icon">üõ†</span> Servicios
        </div>
        <div class="nav-item">
          <span class="icon">üí≥</span> Ventas
        </div>
        <div class="nav-item">
          <span class="icon">üìä</span> Proyectos
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      Versi√≥n demo ¬∑ Datos ficticios
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- Topbar con acciones generales -->
    <div class="topbar">
      <button class="btn" id="themeToggle">
        <span class="icon">üåì</span> Oscuro / Claro
      </button>
      <button class="btn">
        <span class="icon">üíæ</span> Guardar vista
      </button>
      <button class="btn">
        <span class="icon">‚¨áÔ∏è</span> Exportar HTML
      </button>
      <button class="btn btn-cta">
        <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
      </button>
    </div>

    <!-- Buscador local de centros -->
    <div class="centros-search-row">
      <div class="centros-search-wrapper">
        <span class="search-icon">üîç</span>
        <input id="buscadorCentros" class="centros-search-input"
               placeholder="Buscar por centro, propietario o delegado..." />
      </div>
    </div>

    <!-- MAPA + PANEL DELEGADOS -->
    <section class="top-layout">
      <!-- IZQUIERDA: MAPA ESPA√ëA -->
      <article class="card map-container">
        <div class="map-header">
          <span>Mapa de delegados (est√°tico)</span>
          <span class="badge-small">Clic en un punto para filtrar ¬∑ clic en silueta para ver todos</span>
        </div>
        <div class="map-body">
          <svg id="spainMap" viewBox="0 0 300 200">
            <!-- Silueta estilizada de Espa√±a -->
            <path id="spainShape" class="spain-shape"
              d="M35 70 L60 40 L95 30 L135 25 L175 30 L205 40 L235 55 L255 80 L260 105 L250 135 L225 160 L190 175 L145 180 L105 176 L70 165 L50 145 L40 120 Z" />
          </svg>
        </div>
        <div class="map-footer">
          Espa√±a ¬∑ Silueta est√°tica de referencia
        </div>
      </article>

      <!-- DERECHA: DELEGADOS Y ACCIONES -->
      <article class="card delegados-panel">
        <div>
          <h3>Centros y delegados</h3>
          <p class="card-sub">
            Cada barra muestra un delegado, su color y el n√∫mero de centros asociados.
            Haz clic para desplegar sus centros.
          </p>
        </div>

        <div class="delegados-list" id="delegadosLegend"></div>

        <div class="actions-row">
          <button class="btn btn-cta" id="btnAddCentro">
            <span class="icon">‚ûï</span> A√±adir centro
          </button>
          <button class="btn" id="btnAdjuntarExcel">
            <span class="icon">üì§</span> Adjuntar centros (Excel)
          </button>
          <input type="file" id="inputExcel" accept=".xlsx,.xls" style="display:none" />
        </div>

        <p class="summary-text" id="summaryCentros">
          A√∫n no hay centros cargados. Adjunta el Excel maestro para verlos en el mapa y en la tabla.
        </p>
      </article>
    </section>

    <!-- TABLA CENTROS -->
    <section class="table-wrapper">
      <div class="table-header">
        <div>
          <h3>Listado de centros</h3>
          <span>Vista consolidada de centros Corner y Exclusivos ¬∑ fuente: Excel maestro.</span>
        </div>
        <span class="badge-small" id="totalCentrosLabel">Sin centros cargados</span>
      </div>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Propietario</th>
              <th>Centro</th>
              <th>Provincia</th>
              <th>Delegado</th>
              <th>Tipo</th>
              <th>Informes</th>
              <th>Centro AAR</th>
            </tr>
          </thead>
          <tbody id="tablaCentrosBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL NUEVO CENTRO -->
  <div class="modal-backdrop" id="modalCentro">
    <div class="modal">
      <div class="modal-header">
        <h3>Nuevo centro</h3>
        <span class="modal-close" data-close="modalCentro">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label>C√≥digo</label>
          <input id="nuevoCodigo" />
        </div>
        <div class="modal-field">
          <label>Propietario</label>
          <input id="nuevoPropietario" />
        </div>
        <div class="modal-field">
          <label>Centro</label>
          <input id="nuevoCentro" />
        </div>
        <div class="modal-field">
          <label>Provincia</label>
          <input id="nuevoProvincia" />
        </div>
        <div class="modal-field">
          <label>Delegado</label>
          <select id="nuevoDelegado"></select>
        </div>
        <div class="modal-field">
          <label>Tipo</label>
          <select id="nuevoTipo">
            <option value="Corner">Corner</option>
            <option value="Exclusivo">Exclusivo</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalCentro">Cancelar</button>
        <button class="btn btn-cta" id="guardarCentro">Guardar centro</button>
      </div>
    </div>
  </div>

  <!-- MODAL INFORMES -->
  <div class="modal-backdrop" id="modalInformes">
    <div class="modal">
      <div class="modal-header">
        <h3>Informes del centro</h3>
        <span class="modal-close" data-close="modalInformes">‚úï</span>
      </div>
      <div class="modal-body" id="informesBody"></div>
      <div class="modal-footer">
        <button class="btn" data-close="modalInformes">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // ---- TEMA OSCURO/CLARO (placeholder) ----
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('light');
    });

    // ---- COLORES DELEGADOS ----
    const delegadosColores = {
      "ENERITZ ARANGUREN": "#22c55e",
      "LAURA PLAZAS": "#2563eb",
      "LAURA RAMOS": "#14b8a6",
      "Daniel Chazo": "#a855f7",
      "Manuel C√°novas": "#f97316",
      "Cecilia P√©rez": "#0ea5e9",
      "Martin SEBASTI√ÅN": "#ef4444",
      "Marisa Carmona": "#eab308",
      "Blanca Fdez. de la Pradilla": "#ec4899",
      "Maribel Amezcua": "#facc15",
      "Sonia Godino": "#22d3ee",
      "Ver√≥nica Alfons√≠n": "#4ade80",
      "Sergio Per√°n": "#fb7185"
    };

    // ---- DATOS ----
    const centros = []; // se llenar√° desde Excel o altas manuales

    const exclusivosNombres = new Set([
      "CC LOS VALLES",
      "FUENLABRADA Calle Leganes",
      "PAMPLONA C. Exclusivo",
      "PAMPLONA Calle Sancho el Mayor",
      "PAMPLONA Carlos III",
      "REINA DE MERCEDES",
      "SANTANDER CC PE√ëACASTILLO",
      "SANTIAGO DE COMPOSTELA RUA DA ROSA",
      "TORRELAVEGA CARREFOUR CC",
      "ZARAGOZA CALLE DELICIAS"
    ]);

    const informesPorCentro = {};
    const aarPorCentro = {};

    // ---- UTILIDADES ----
    function normaliza(txt) {
      return (txt || "")
        .toString()
        .trim()
        .toUpperCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    // Alias de provincias/zonas a provincia "real"
    const provinciaAlias = {
      "GALICIA": "A CORUNA",
      "SANTIAGO DE COMPOSTELA": "A CORUNA",
      "SANTIAGO DE COMPOSTELA RUA DA ROSA": "A CORUNA",
      "SAN SEBASTIAN": "GIPUZKOA",
      "SAN SEBASTIAN.": "GIPUZKOA",
      "SAN SEBASTIAN DE LOS REYES": "MADRID",
      "SAN SEBASTIAN DE LOS REYES CARREFOUR CC": "MADRID",
      "BALEARES MALLORCA": "BALEARES",
      "BALEARES. MALLORCA": "BALEARES"
    };

    // posiciones aproximadas por provincia en el mapa (viewBox 0..300 x 0..200)
    const provinciaPos = {
      "A CORUNA": [55, 70],
      "CORUNA": [55, 70],
      "LUGO": [70, 55],
      "PONTEVEDRA": [65, 90],
      "OURENSE": [70, 95],
      "ASTURIAS": [90, 55],
      "CANTABRIA": [105, 60],
      "SANTANDER": [105, 60],
      "VIZCAYA": [120, 60],
      "GIPUZKOA": [135, 60],
      "NAVARRA": [145, 65],
      "LA RIOJA": [140, 75],
      "BURGOS": [120, 75],
      "LEON": [95, 70],
      "PALENCIA": [105, 80],
      "VALLADOLID": [110, 90],
      "ZAMORA": [100, 95],
      "SALAMANCA": [95, 105],
      "SEGOVIA": [120, 95],
      "SORIA": [135, 90],
      "MADRID": [135, 105],
      "TOLEDO": [135, 120],
      "CIUDAD REAL": [125, 125],
      "CUENCA": [150, 120],
      "ZARAGOZA": [170, 90],
      "HUESCA": [170, 75],
      "TERUEL": [170, 115],
      "BARCELONA": [210, 80],
      "TARRAGONA": [205, 95],
      "LLEIDA": [195, 85],
      "GIRONA": [215, 70],
      "CASTELLON": [200, 105],
      "VALENCIA": [195, 115],
      "ALICANTE": [190, 130],
      "MURCIA": [185, 140],
      "ALBACETE": [170, 130],
      "BADAJOZ": [100, 120],
      "CACERES": [100, 110],
      "SEVILLA": [110, 135],
      "CORDOBA": [120, 120],
      "HUELVA": [95, 135],
      "CADIZ": [105, 155],
      "MALAGA": [125, 150],
      "GRANADA": [135, 145],
      "JAEN": [140, 130],
      "ALMERIA": [150, 150],
      "CUENCA": [150, 120],
      "SORIA": [135, 90],
      "LAS PALMAS": [245, 175],
      "TENERIFE": [230, 175],
      "BALEARES": [235, 115],
      "FIGUERAS": [215, 75]
    };

    function getPosFromProvincia(prov) {
      let p = normaliza(prov);
      if (provinciaAlias[p]) {
        p = provinciaAlias[p];
      }
      if (provinciaPos[p]) return provinciaPos[p];

      // fallback: zona centro con peque√±o desplazamiento determinista
      const baseX = 150, baseY = 110;
      let h = 0;
      for (let i = 0; i < p.length; i++) h += p.charCodeAt(i);
      const dx = (h % 40) - 20;   // -20..19
      const dy = ((h / 3) % 30) - 15;
      return [baseX + dx, baseY + dy];
    }

    // ---- TABLA ----
    const tablaBody = document.getElementById('tablaCentrosBody');
    const totalCentrosLabel = document.getElementById('totalCentrosLabel');
    const summaryCentros = document.getElementById('summaryCentros');

    let filtroDelegadoActual = null;
    let filtroTextoActual = "";

    function tipoCentro(nombreCentro) {
      return exclusivosNombres.has(nombreCentro) ? "Exclusivo" : "Corner";
    }

    function getInformes(nombreCentro) {
      return informesPorCentro[nombreCentro] || [];
    }

    function getAarEstado(nombreCentro) {
      return aarPorCentro[nombreCentro] || "No";
    }

    function renderTabla() {
      const texto = filtroTextoActual.toLowerCase();
      tablaBody.innerHTML = "";

      const filtrados = centros.filter(c => {
        const cad = (c.centro + " " + c.propietario + " " + c.delegado).toLowerCase();
        const pasaTexto = cad.includes(texto);
        const pasaDelegado = !filtroDelegadoActual ||
          c.delegado.toLowerCase().includes(filtroDelegadoActual.toLowerCase());
        return pasaTexto && pasaDelegado;
      });

      filtrados.forEach(c => {
        const tr = document.createElement('tr');
        const t = tipoCentro(c.centro);
        const informes = getInformes(c.centro);
        const aarEstado = getAarEstado(c.centro);

        tr.innerHTML = `
          <td>${c.codigo}</td>
          <td>${c.propietario}</td>
          <td>${c.centro}</td>
          <td>${c.provincia}</td>
          <td>${c.delegado}</td>
          <td><span class="tag ${t === 'Exclusivo' ? 'exclusivo' : 'corner'}">${t}</span></td>
          <td>
            <button class="btn-link" data-centro="${c.centro}">
              ${informes.length ? `Ver (${informes.length})` : "A√±adir informe"}
            </button>
          </td>
          <td>
            <span class="tag tag-aar ${
              aarEstado === 'S√≠' ? 'si' :
              aarEstado === 'En formaci√≥n' ? 'formacion' : ''
            }">${aarEstado}</span>
          </td>
        `;
        tablaBody.appendChild(tr);
      });

      if (centros.length === 0) {
        totalCentrosLabel.textContent = "Sin centros cargados";
        summaryCentros.textContent =
          "A√∫n no hay centros cargados. Adjunta el Excel maestro para verlos en el mapa y en la tabla.";
      } else {
        totalCentrosLabel.textContent =
          `Centros mostrados: ${filtrados.length} / ${centros.length}`;
        summaryCentros.textContent =
          `Centros mostrados: ${filtrados.length} ¬∑ Total cargados desde Excel o altas manuales: ${centros.length}`;
      }
    }

    // ---- MAPA ----
    const spainMap = document.getElementById('spainMap');

    function clearMapDots() {
      Array.from(spainMap.querySelectorAll('circle.map-dot')).forEach(c => c.remove());
    }

    function renderMapa() {
      clearMapDots();

      centros.forEach(c => {
        const [x, y] = getPosFromProvincia(c.provincia);
        const color = delegadosColores[c.delegado] || "#e5e7eb";
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute('class', 'map-dot');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 4);
        circle.setAttribute('fill', color);
        circle.dataset.delegado = c.delegado;
        circle.addEventListener('click', e => {
          e.stopPropagation();
          filtroDelegadoActual = c.delegado;
          renderTabla();
          renderDelegadosPanel();
        });
        spainMap.appendChild(circle);
      });
    }

    // clic en silueta = reset filtro delegado
    document.getElementById('spainShape').addEventListener('click', () => {
      filtroDelegadoActual = null;
      renderTabla();
      renderDelegadosPanel();
    });

    // ---- PANEL DELEGADOS (barras y tarjetas) ----
    const delegadosLegend = document.getElementById('delegadosLegend');

    function renderDelegadosPanel() {
      delegadosLegend.innerHTML = "";
      if (!centros.length) return;

      // agrupamos por delegado
      const mapa = new Map();
      centros.forEach(c => {
        if (!mapa.has(c.delegado)) mapa.set(c.delegado, []);
        mapa.get(c.delegado).push(c);
      });

      const maxCentros = Math.max(...Array.from(mapa.values()).map(arr => arr.length));

      mapa.forEach((listaCentros, delegado) => {
        const color = delegadosColores[delegado] || "#e5e7eb";
        const card = document.createElement('div');
        card.className = 'delegado-card';

        const ancho = 100 * (listaCentros.length / maxCentros || 0);

        const centrosTexto = listaCentros
          .map(c => c.centro)
          .sort()
          .join(" ¬∑ ");

        card.innerHTML = `
          <div class="delegado-card-header">
            <div class="delegado-name">
              <span class="delegado-color" style="background:${color}"></span>
              <span>${delegado}</span>
            </div>
            <span class="delegado-count">${listaCentros.length} centro${listaCentros.length !== 1 ? 's' : ''}</span>
          </div>
          <div class="delegado-card-bar">
            <div class="delegado-card-bar-inner" style="background:${color}; width:${ancho}%"></div>
          </div>
          <div class="delegado-centros">${centrosTexto}</div>
        `;

        card.addEventListener('click', () => {
          // desplegar / plegar tarjeta
          card.classList.toggle('open');
          // filtro de tabla + mapa
          filtroDelegadoActual =
            filtroDelegadoActual === delegado ? null : delegado;
          renderTabla();
        });

        delegadosLegend.appendChild(card);
      });
    }

    // ---- BUSCADOR ----
    document.getElementById('buscadorCentros').addEventListener('input', e => {
      filtroTextoActual = e.target.value || "";
      renderTabla();
    });

    // ---- MODALES ----
    function abrirModal(id) {
      document.getElementById(id).style.display = 'flex';
    }
    function cerrarModal(id) {
      document.getElementById(id).style.display = 'none';
    }
    document.querySelectorAll('[data-close]').forEach(el => {
      el.addEventListener('click', () => cerrarModal(el.dataset.close));
    });

    // ---- ALTA MANUAL DE CENTRO ----
    document.getElementById('btnAddCentro').addEventListener('click', () => {
      const sel = document.getElementById('nuevoDelegado');
      sel.innerHTML = "";
      const nombres = new Set([...Object.keys(delegadosColores), ...centros.map(c => c.delegado)]);
      nombres.forEach(nombre => {
        const opt = document.createElement('option');
        opt.value = nombre;
        opt.textContent = nombre;
        sel.appendChild(opt);
      });
      abrirModal('modalCentro');
    });

    document.getElementById('guardarCentro').addEventListener('click', () => {
      const nuevo = {
        codigo: document.getElementById('nuevoCodigo').value || "NEW",
        propietario: document.getElementById('nuevoPropietario').value || "N/D",
        centro: document.getElementById('nuevoCentro').value || "Centro sin nombre",
        provincia: document.getElementById('nuevoProvincia').value || "N/D",
        delegado: document.getElementById('nuevoDelegado').value || "N/D"
      };
      const tipo = document.getElementById('nuevoTipo').value;
      if (tipo === "Exclusivo") exclusivosNombres.add(nuevo.centro);
      centros.push(nuevo);
      cerrarModal('modalCentro');
      renderTabla();
      renderMapa();
      renderDelegadosPanel();
    });

    // ---- ADJUNTAR CENTROS (EXCEL) ----
    const inputExcel = document.getElementById('inputExcel');
    document.getElementById('btnAdjuntarExcel').addEventListener('click', () => {
      inputExcel.click();
    });

    inputExcel.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        // Esperado: CODIGO | PROPIETARIO | CENTRO | PROVINCIA | DELEGADOS
        centros.length = 0; // limpiamos TODO (incluida demo, si existiera)
        rows.slice(1).forEach(row => {
          if (!row || row.length < 5) return;
          const [codigo, propietario, centro, provincia, delegado] = row;
          if (!centro) return;
          centros.push({
            codigo: (codigo || "").toString().trim(),
            propietario: (propietario || "").toString().trim(),
            centro: (centro || "").toString().trim(),
            provincia: (provincia || "").toString().trim(),
            delegado: (delegado || "").toString().trim()
          });
        });

        filtroDelegadoActual = null;
        filtroTextoActual = "";
        document.getElementById('buscadorCentros').value = "";

        renderTabla();
        renderMapa();
        renderDelegadosPanel();
      };
      reader.readAsArrayBuffer(file);
    });

    // ---- INFORMES (demo) ----
    document.addEventListener('click', e => {
      if (e.target.matches('.btn-link[data-centro]')) {
        const nombreCentro = e.target.dataset.centro;
        const informes = getInformes(nombreCentro);
        const cont = document.getElementById('informesBody');
        cont.innerHTML = "";

        if (!informes.length) {
          cont.innerHTML = "<p style='font-size:.8rem;'>Este centro a√∫n no tiene informes guardados. Desde el m√≥dulo de informes podr√°s adjuntar documentos (visitas, auditor√≠as, etc.).</p>";
        } else {
          informes.forEach((inf, idx) => {
            const div = document.createElement('div');
            div.className = 'modal-field';
            div.innerHTML = `<label>Informe ${idx + 1}</label><div>${inf}</div>`;
            cont.appendChild(div);
          });
        }
        abrirModal('modalInformes');
      }
    });
  </script>
</body>
</html>
