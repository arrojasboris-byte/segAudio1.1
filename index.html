<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Seguimiento de procesos de Audio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect } = React;

      // =====================
      // Checklist (mapa horizontal)
      // =====================

      const CHECKLIST = [
        {
          etapa: "HOLA",
          items: [
            "Espacio audio limpio, ordenado",
            "Esp茅culos, olivas y cascos desinfectados",
            "Acogida al cliente con una sonrisa, amable y cercana",
            "Llamar al paciente por su nombre",
            "Acompa帽ar al paciente al gabinete para la revisi贸n auditiva",
            "Confirmar motivo de visita",
          ],
        },
        {
          etapa: "SOY NICO",
          items: [
            "Abrir ficha y rellenar RGPD completa (incluidos checks comerciales)",
            "Realizar anamnesis HACE (H谩bitos, Antecedentes, Cl铆nica, Expectativas)",
            "Anotar al menos 2 expectativas/necesidades concretas",
            "Recoger entorno sonoro y situaciones clave para el paciente",
          ],
        },
        {
          etapa: "MI AUDICIN",
          items: [
            "Explicar brevemente cada prueba y confirmar comprensi贸n",
            "Evaluar ambos o铆dos con videotoscopia y explicar procedimiento",
            "Realizar timpanometr铆a y explicar procedimiento",
            "Realizar v铆a a茅rea y v铆a 贸sea explicando cada paso",
            "Mantener TV encendida para comunicar audio y mostrar resultados",
          ],
        },
        {
          etapa: "MI SOLUCIN",
          items: [
            "Resumir claramente los resultados y su impacto",
            "Usar gr谩ficas para apoyar la explicaci贸n (severidad, 谩rea audible, fonemas)",
            "Vincular resultados con s铆ntomas y quejas de la anamnesis",
            "Hacer visible la p茅rdida auditiva con preguntas de implicaci贸n",
            "Simular sonidos para mostrar la diferencia con/ sin ayuda",
          ],
        },
        {
          etapa: "PRUEBO",
          items: [
            "Explicar la prueba de capacidad de adaptaci贸n como prueba de salud",
            "Escoger aud铆fono seg煤n perfil en gama adecuada (Diamante)",
            "Realizar programaci贸n inicial y ajustes seg煤n perfil",
            "Explicar funcionamiento y mantenimiento para llevarse aud铆fonos a casa",
            "Entregar documentaci贸n (contrato, presupuesto, pasaporte)",
          ],
        },
        {
          etapa: "ME COMPROMETO",
          items: [
            "Trabajar resoluci贸n de objeciones con lenguaje positivo",
            "Explicar facilidades de pago (Infinity / NextYear)",
            "Detallar pack Serenidad y Serenidad + (compromisos)",
            "Explicar en detalle pruebas HIT y su utilidad",
            "Recomendar accesorios de conectividad y productos de higiene",
          ],
        },
        {
          etapa: "ME CONVIERTO EN FAN",
          items: [
            "Explicar llamadas de seguimiento y agenda futura",
            "Reforzar logros y mejoras conseguidas en cada visita",
            "Aplicar t茅cnicas de Neuroventas en el seguimiento",
          ],
        },
        {
          etapa: "SEGUIMIENTO Y AGENDA",
          items: [
            "Registrar prueba en el sistema (Gio)",
            "Llamar al d铆a siguiente de la prueba para seguimiento",
            "Agendar visita en 4 d铆as para revisi贸n",
          ],
        },
        {
          etapa: "COMUNICACIN DEL CENTRO",
          items: [
            "Comunicaci贸n del centro adecuada a su perfil",
            "Revisi贸n de comunicaci贸n en RRSS",
            "Uniformidad adecuada",
            "Contacto con locales vecinos y colaboraciones",
            "Escaparate atractivo con novedad de producto",
          ],
        },
        {
          etapa: "AYUDAS Y ACUERDOS",
          items: [
            "Conocer y activar acuerdos con FIAPAS y ONCE",
            "Revisar convenios locales (anotar detalle en observaciones)",
            "Conocer ayudas de comunidad aut贸noma",
            "Conocer ayudas generales +65 a帽os y hasta 26 a帽os",
          ],
        },
        {
          etapa: "INCENTIVOS",
          items: ["Incentivos por derivaci贸n", "Incentivos por AAR"],
        },
        {
          etapa: "FORMACIN",
          items: [
            "Onboarding Academy realizado",
            "Formaciones obligatorias de centros exclusivos cumplimentadas",
            "Formaciones obligatorias de centros audio realizadas",
          ],
        },
      ];

      // Centros exclusivos (por nombre normalizado)
      const EXCLUSIVE_CENTERS_NAMES = [
        "PAMPLONA C. EXCLUSIVO",
        "CC LOS VALLES",
        "SANTIAGO DE COMPOSTELA RUA DA ROSA",
        "CC PLAZA DE LA ESTACIN",
        "REINA DE MERCEDES",
        "SANTANDER CC PEACASTILLO",
        "TORRELAVEGA CARREFOUR CC",
        "ZARAGOZA CALLE DELICIAS",
      ];

      // Meses para ventas / objetivos (Jul 2025 - Jul 2026)
      const EXCLUSIVE_MONTHS = [
        { key: "2025-07", label: "Jul 2025" },
        { key: "2025-08", label: "Ago 2025" },
        { key: "2025-09", label: "Sep 2025" },
        { key: "2025-10", label: "Oct 2025" },
        { key: "2025-11", label: "Nov 2025" },
        { key: "2025-12", label: "Dic 2025" },
        { key: "2026-01", label: "Ene 2026" },
        { key: "2026-02", label: "Feb 2026" },
        { key: "2026-03", label: "Mar 2026" },
        { key: "2026-04", label: "Abr 2026" },
        { key: "2026-05", label: "May 2026" },
        { key: "2026-06", label: "Jun 2026" },
        { key: "2026-07", label: "Jul 2026" },
      ];

      const ACTION_TYPES = [
        "Stand",
        "Mailing",
        "Cashback",
        "Azafata calle",
        "Ruleta",
        "Acci贸n colectivo",
        "Call center",
        "Acci贸n derivaci贸n tienda",
        "Derivaci贸n colectivo",
      ];

      // =====================
      // Utilidades / modelos
      // =====================

      function createEmptyVisits() {
        return [1, 2, 3, 4].map((id) => ({
          id,
          fecha: "",
          responsable: "",
          excelName: "",
          hit: "",
          checklist: null,
          centroAAR: "",
          stagePercents: null,
        }));
      }

      function normalizarCentro(nombre) {
        return (nombre || "").trim().toUpperCase();
      }

      function normalizarDelegado(nombre) {
        const trimmed = (nombre || "").trim();
        if (!trimmed) return "";
        return trimmed
          .toLowerCase()
          .split(/\s+/)
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
          .join(" ");
      }

      const CENTER_TO_PROVINCE = {};
      const CITY_TO_PROVINCE = {
        NARON: "A CORUA (GALICIA)",
        "NARN": "A CORUA (GALICIA)",
        ONDARA: "ALICANTE (COMUNITAT VALENCIANA)",
      };

      function inferProvincia(centro, provinciaExcel) {
        if (provinciaExcel && provinciaExcel.trim() !== "") {
          return provinciaExcel.trim().toUpperCase();
        }
        const centroNorm = normalizarCentro(centro);
        if (CENTER_TO_PROVINCE[centroNorm]) {
          return CENTER_TO_PROVINCE[centroNorm];
        }
        const tokens = centroNorm
          .split(/[,\-()]/)
          .map((t) => t.trim())
          .filter(Boolean);
        for (let i = tokens.length - 1; i >= 0; i--) {
          const token = tokens[i];
          if (CITY_TO_PROVINCE[token]) {
            return CITY_TO_PROVINCE[token];
          }
        }
        return "";
      }

      function parseFecha(fecha) {
        const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
        const match = fecha.match(regex);
        if (!match) return null;
        const day = Number(match[1]);
        const month = Number(match[2]);
        const year = Number(match[3]);
        const d = new Date(year, month - 1, day);
        if (
          d.getFullYear() !== year ||
          d.getMonth() !== month - 1 ||
          d.getDate() !== day
        ) {
          return null;
        }
        return d;
      }

      function isValidFecha(fecha) {
        if (!fecha) return true;
        return parseFecha(fecha) !== null;
      }

      function media(valores) {
        const nums = valores.filter(
          (v) => typeof v === "number" && !isNaN(v)
        );
        if (nums.length === 0) return null;
        const total = nums.reduce((sum, v) => sum + v, 0);
        return total / nums.length;
      }

      function porcentajeSi(valores) {
        const valid = valores.filter((v) => v === "S铆" || v === "No");
        if (valid.length === 0) return null;
        const countSi = valid.filter((v) => v === "S铆").length;
        return (countSi / valid.length) * 100;
      }

      function donutStyle(percent) {
        const value = percent && percent > 0 ? Math.min(percent, 100) : 0;
        const color =
          percent !== null && percent >= 85 ? "#16a34a" : "#dc2626";
        return {
          background: `conic-gradient(${color} ${value * 3.6}deg, #e5e7eb 0deg)`,
        };
      }

      function kpiBadgeClass(percent) {
        if (percent === null) return "bg-gray-200 text-gray-700";
        if (percent >= 85) return "bg-green-100 text-green-800";
        return "bg-red-100 text-red-700";
      }

      function delegadoColor(delegado) {
        if (!delegado) return {};
        let hash = 0;
        const texto = delegado.trim().toUpperCase();
        for (let i = 0; i < texto.length; i++) {
          hash = (hash * 31 + texto.charCodeAt(i)) | 0;
        }
        const hue = (Math.abs(hash) % 360 + 180) % 360;
        return {
          backgroundColor: `hsl(${hue}, 75%, 90%)`,
          color: `hsl(${hue}, 35%, 28%)`,
        };
      }

      function getUniqueSorted(values) {
        const set = new Set(
          values
            .map((v) => (v || "").trim())
            .filter((v) => v.length > 0)
        );
        return Array.from(set).sort((a, b) =>
          a.localeCompare(b, "es", { sensitivity: "base" })
        );
      }

      function aplicaHitTexto(visitas) {
        const hits = visitas.filter(
          (v) => v.hit === "S铆" || v.hit === "No"
        );
        if (hits.length === 0) return null;
        const anyYes = hits.some((v) => v.hit === "S铆");
        return anyYes ? "S铆" : "No";
      }

      function formatFechaHora(iso) {
        if (!iso) return "Sin guardado";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "Sin guardado";
        return d.toLocaleString("es-ES");
      }

      function deriveRespAudio(store) {
        if (store.responsableAudio && store.responsableAudio.trim()) {
          return store.responsableAudio;
        }
        const visitas = store.visitas || [];
        const copia = [...visitas].reverse();
        const visitaConResp = copia.find((v) => v.responsable);
        return visitaConResp ? visitaConResp.responsable : "";
      }

      function deriveCentroAAR(store) {
        const visitas = store.visitas || [];
        const valores = visitas
          .map((v) => v.centroAAR)
          .filter(
            (v) => v === "S铆" || v === "No" || v === "En formaci贸n"
          );
        if (valores.length === 0) return "";
        if (valores.includes("En formaci贸n")) return "En formaci贸n";
        if (valores.includes("S铆")) return "S铆";
        return "No";
      }

      function isExclusiveCenter(centro) {
        const c = normalizarCentro(centro);
        return EXCLUSIVE_CENTERS_NAMES.some((name) =>
          c.includes(name.toUpperCase())
        );
      }

      // =====================
      // Componente principal
      // =====================

      function App() {
        const [pin, setPin] = useState("");
        const [authorized, setAuthorized] = useState(false);

        const [search, setSearch] = useState("");
        const [filterCodigo, setFilterCodigo] = useState("");
        const [filterPropietario, setFilterPropietario] = useState("");
        const [filterCentro, setFilterCentro] = useState("");
        const [filterProvincia, setFilterProvincia] = useState("");
        const [filterDelegado, setFilterDelegado] = useState("");
        const [filterResponsableAudio, setFilterResponsableAudio] =
          useState("");
        const [filterCentroAAR, setFilterCentroAAR] = useState("");
        const [filterCorreo, setFilterCorreo] = useState("");

        const [storesInput, setStoresInput] = useState("");
        const [stores, setStores] = useState([]);
        const [expandedStoreId, setExpandedStoreId] = useState(null);
        const [dashboardStoreId, setDashboardStoreId] = useState(null);
        const [showCarga, setShowCarga] = useState(false);
        const [lastSavedAt, setLastSavedAt] = useState(null);

        // datos de centros exclusivos (acciones, ventas, objetivos por mes)
        const [exclusiveData, setExclusiveData] = useState({});
        const [expandedExclusiveId, setExpandedExclusiveId] =
          useState(null);

        useEffect(() => {
          try {
            const raw = localStorage.getItem("seguimientoAudioV1");
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed.stores) {
              const normalizedStores = parsed.stores.map((s, idx) => ({
                ...s,
                id: idx + 1,
                centroRegional: normalizarDelegado(s.centroRegional || ""),
              }));
              setStores(normalizedStores);
            }
            if (parsed.lastSavedAt) setLastSavedAt(parsed.lastSavedAt);
            if (parsed.exclusiveData) setExclusiveData(parsed.exclusiveData);
          } catch (e) {
            console.error("Error al cargar de la nube/localStorage", e);
          }
        }, []);

        function handlePin() {
          if (pin.trim().toUpperCase() === "AR4321") setAuthorized(true);
        }

        function handleApplyStores() {
          if (!storesInput.trim()) return;
          let lines = storesInput
            .split("\n")
            .map((line) => line.trim())
            .filter(Boolean);

          if (
            lines.length > 0 &&
            lines[0].toUpperCase().includes("CODIGO") &&
            lines[0].toUpperCase().includes("PROPIETARIO")
          ) {
            lines = lines.slice(1);
          }

          const newStores = lines.map((raw, index) => {
            const parts = raw.split("\t");
            const [
              codigo = "",
              propietario = "",
              centro = "",
              provincia = "",
              correo = "",
              centroRegional = "",
            ] = parts;
            const provinciaInferida = inferProvincia(centro, provincia);
            const delegadoNormalizado = normalizarDelegado(centroRegional);
            return {
              id: index + 1,
              raw,
              codigo,
              propietario,
              centro,
              provincia: provinciaInferida,
              correo,
              centroRegional: delegadoNormalizado,
              region: "",
              responsableAudio: "",
              centroAAR: "",
              visitas: createEmptyVisits(),
            };
          });

          setStores(newStores);
          setExpandedStoreId(null);
          setDashboardStoreId(null);
          setExclusiveData({});
        }

        function updateStoreField(id, field, value) {
          setStores((prev) =>
            prev.map((store) =>
              store.id === id ? { ...store, [field]: value } : store
            )
          );
        }

        function updateVisitField(storeId, visitId, field, value) {
          setStores((prev) =>
            prev.map((store) => {
              if (store.id !== storeId) return store;
              return {
                ...store,
                visitas: store.visitas.map((visit) =>
                  visit.id === visitId ? { ...visit, [field]: value } : visit
                ),
              };
            })
          );
        }

        // --------- CENTROS EXCLUSIVOS: datos de acciones ---------

        function ensureExclusiveEntry(storeId) {
          return (
            exclusiveData[storeId] || {
              acciones: [],
            }
          );
        }

        function addExclusiveAction(storeId) {
          setExclusiveData((prev) => {
            const current = ensureExclusiveEntry(storeId);
            const nueva = {
              id: Date.now() + Math.random(),
              tipo: "",
              fecha: "",
              derivaciones: "",
              ventasMes: "",
              ventasImporte: "",
              objetivoMes: "",
              objetivoImporte: "",
            };
            return {
              ...prev,
              [storeId]: {
                ...current,
                acciones: [...current.acciones, nueva],
              },
            };
          });
        }

        function updateExclusiveAction(storeId, actionId, field, value) {
          setExclusiveData((prev) => {
            const current = ensureExclusiveEntry(storeId);
            const accionesActualizadas = current.acciones.map((a) =>
              a.id === actionId ? { ...a, [field]: value } : a
            );
            return {
              ...prev,
              [storeId]: {
                ...current,
                acciones: accionesActualizadas,
              },
            };
          });
        }

        function removeExclusiveAction(storeId, actionId) {
          setExclusiveData((prev) => {
            const current = ensureExclusiveEntry(storeId);
            const accionesActualizadas = current.acciones.filter(
              (a) => a.id !== actionId
            );
            return {
              ...prev,
              [storeId]: {
                ...current,
                acciones: accionesActualizadas,
              },
            };
          });
        }

        // --------- LECTURA DE EXCEL CHECKLIST (F90 en PROCESOS BASICOS) ---------
        function handleChecklistFileChange(storeId, visitId, event) {
          const file = event.target.files?.[0];
          if (!file) return;

          updateVisitField(storeId, visitId, "excelName", file.name);

          const reader = new FileReader();
          const isExcel =
            file.name.toLowerCase().endsWith(".xlsx") ||
            file.name.toLowerCase().endsWith(".xls");

          reader.onload = (ev) => {
            try {
              const data = ev.target.result;
              let checklistFromF90Set = false;

              if (isExcel && window.XLSX) {
                const wb = XLSX.read(data, { type: "array" });

                let sheetName =
                  wb.SheetNames.find((n) =>
                    n.toLowerCase().includes("procesos basicos")
                  ) ||
                  wb.SheetNames.find((n) =>
                    n.toLowerCase().includes("procesos")
                  ) ||
                  wb.SheetNames[0];

                const sheet = wb.Sheets[sheetName];

                let checklistF90 = null;
                const cell = sheet["F90"];
                if (cell && cell.v != null) {
                  let rawVal = cell.v;
                  if (typeof rawVal === "number") {
                    let v = rawVal;
                    if (v <= 1) v = v * 100;
                    checklistF90 = v;
                  } else if (typeof rawVal === "string") {
                    const m = rawVal
                      .replace(",", ".")
                      .match(/(\d{1,3}(?:\.\d+)?)/);
                    if (m) {
                      let v = parseFloat(m[1]);
                      if (v <= 1) v = v * 100;
                      checklistF90 = v;
                    }
                  }
                }

                if (checklistF90 !== null && !isNaN(checklistF90)) {
                  updateVisitField(
                    storeId,
                    visitId,
                    "checklist",
                    checklistF90
                  );
                  checklistFromF90Set = true;
                }

                const csv = XLSX.utils.sheet_to_csv(sheet);
                parseFromText(csv, checklistFromF90Set);
              } else {
                const text =
                  typeof data === "string"
                    ? data
                    : new TextDecoder("utf-8").decode(data);
                parseFromText(text, checklistFromF90Set);
              }
            } catch (e) {
              console.error("Error leyendo Excel de checklist", e);
            }
          };

          if (isExcel) {
            reader.readAsArrayBuffer(file);
          } else {
            reader.readAsText(file);
          }

          function parseFromText(text, checklistAlreadySet) {
            if (!text) return;

            const reHit = /hit[^a-zA-Z0-9]{0,15}(s[i铆]|no)/i;
            const mHit = text.match(reHit);
            if (mHit) {
              const val = mHit[1].toLowerCase().startsWith("s")
                ? "S铆"
                : "No";
              updateVisitField(storeId, visitId, "hit", val);
            }

            if (!checklistAlreadySet) {
              const reCap =
                /capacitaci[o贸]n[^0-9%]{0,80}(\d{1,3})\s*%/i;
              const mCap = text.match(reCap);
              if (mCap) {
                const n = Number(mCap[1]);
                if (!isNaN(n)) {
                  updateVisitField(storeId, visitId, "checklist", n);
                }
              }
            }
          }
        }

        function saveToCloud() {
          try {
            const payload = {
              stores,
              lastSavedAt: new Date().toISOString(),
              exclusiveData,
            };
            localStorage.setItem(
              "seguimientoAudioV1",
              JSON.stringify(payload)
            );
            setLastSavedAt(payload.lastSavedAt);
          } catch (e) {
            console.error("Error al guardar en nube/localStorage", e);
          }
        }

        function loadFromCloud() {
          try {
            const raw = localStorage.getItem("seguimientoAudioV1");
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed.stores) {
              const normalizedStores = parsed.stores.map((s, idx) => ({
                ...s,
                id: idx + 1,
                centroRegional: normalizarDelegado(s.centroRegional || ""),
              }));
              setStores(normalizedStores);
              setExpandedStoreId(null);
              setDashboardStoreId(null);
            }
            if (parsed.lastSavedAt) setLastSavedAt(parsed.lastSavedAt);
            if (parsed.exclusiveData) setExclusiveData(parsed.exclusiveData);
          } catch (e) {
            console.error("Error al leer de nube/localStorage", e);
          }
        }

        // ------------ FILTRADO Y ORDENACIN LISTADO PRINCIPAL ------------
        const filteredStores = stores.filter((store) => {
          const respAudio = deriveRespAudio(store);
          const centroAARValor = deriveCentroAAR(store);
          const textoGlobal = `${store.codigo} ${store.propietario} ${store.centro} ${store.provincia} ${store.centroRegional} ${store.correo} ${respAudio} ${centroAARValor}`.toLowerCase();

          if (search && !textoGlobal.includes(search.toLowerCase()))
            return false;

          if (
            filterCodigo &&
            store.codigo.toLowerCase() !== filterCodigo.toLowerCase()
          )
            return false;

          if (
            filterPropietario &&
            store.propietario.toLowerCase() !==
              filterPropietario.toLowerCase()
          )
            return false;

          if (
            filterCentro &&
            store.centro.toLowerCase() !== filterCentro.toLowerCase()
          )
            return false;

          if (
            filterCorreo &&
            store.correo.toLowerCase() !== filterCorreo.toLowerCase()
          )
            return false;

          if (
            filterProvincia &&
            store.provincia.toLowerCase() !== filterProvincia.toLowerCase()
          )
            return false;

          if (
            filterDelegado &&
            store.centroRegional.toLowerCase() !==
              filterDelegado.toLowerCase()
          )
            return false;

          if (
            filterResponsableAudio &&
            deriveRespAudio(store).toLowerCase() !==
              filterResponsableAudio.toLowerCase()
          )
            return false;

          if (
            filterCentroAAR &&
            centroAARValor.toLowerCase() !== filterCentroAAR.toLowerCase()
          )
            return false;

          return true;
        });

        const sortedFilteredStores = [...filteredStores].sort((a, b) => {
          const da = (a.centroRegional || "").toLowerCase();
          const db = (b.centroRegional || "").toLowerCase();
          const cmpD = da.localeCompare(db, "es", { sensitivity: "base" });
          if (cmpD !== 0) return cmpD;
          const ca = (a.centro || "").toLowerCase();
          const cb = (b.centro || "").toLowerCase();
          return ca.localeCompare(cb, "es", { sensitivity: "base" });
        });

        const opcionesCodigo = getUniqueSorted(stores.map((s) => s.codigo));
        const opcionesPropietario = getUniqueSorted(
          stores.map((s) => s.propietario)
        );
        const opcionesCentro = getUniqueSorted(stores.map((s) => s.centro));
        const opcionesProvincia = getUniqueSorted(
          stores.map((s) => s.provincia)
        );
        const opcionesCorreo = getUniqueSorted(stores.map((s) => s.correo));
        const opcionesDelegado = getUniqueSorted(
          stores.map((s) => s.centroRegional)
        );
        const opcionesRespAudio = getUniqueSorted(
          stores.map((s) => deriveRespAudio(s))
        );

        // ------------ MTRICAS GLOBALES ------------
        const allVisits = stores.flatMap((s) => s.visitas);
        const visitasValidasGlobal = allVisits.filter(
          (v) => v.excelName && v.excelName !== ""
        );
        const totalVisitas = visitasValidasGlobal.length;
        const totalTiendas = stores.length;
        const tiendasConVisita = stores.filter((s) =>
          s.visitas.some((v) => v.excelName && v.excelName !== "")
        ).length;
        const porcentajeTiendasVisitadas =
          totalTiendas > 0
            ? (tiendasConVisita / totalTiendas) * 100
            : 0;

        const checklistMediaGlobal = media(
          visitasValidasGlobal.map((v) => v.checklist)
        );
        const hitMediaGlobal = porcentajeSi(
          visitasValidasGlobal.map((v) => v.hit)
        );
        const aplicaHitGlobal = aplicaHitTexto(visitasValidasGlobal);

        const algunFechaInvalida = allVisits.some(
          (v) => v.fecha && !isValidFecha(v.fecha)
        );

        const dashboardStore =
          stores.find((s) => s.id === dashboardStoreId) || stores[0] || null;

        let dashVisitasConExcel = [];
        let dashChecklistMedio = null;
        let dashAplicaHit = null;

        if (dashboardStore) {
          dashVisitasConExcel = dashboardStore.visitas.filter(
            (v) => v.excelName && v.excelName !== ""
          );
          dashChecklistMedio = media(
            dashVisitasConExcel.map((v) => v.checklist)
          );
          dashAplicaHit = aplicaHitTexto(dashVisitasConExcel);
        }

        // Centros exclusivos derivados de stores
        const exclusiveStores = stores.filter((s) =>
          isExclusiveCenter(s.centro)
        );

        // Agregados globales de centros exclusivos
        let totalVentasExcl = 0;
        let totalObjetivoExcl = 0;

        exclusiveStores.forEach((s) => {
          const data = ensureExclusiveEntry(s.id);
          const acciones = data.acciones || [];
          const tVentas = acciones.reduce(
            (sum, a) => sum + (Number(a.ventasImporte || 0) || 0),
            0
          );
          const tObjetivo = acciones.reduce(
            (sum, a) => sum + (Number(a.objetivoImporte || 0) || 0),
            0
          );
          totalVentasExcl += tVentas;
          totalObjetivoExcl += tObjetivo;
        });

        const pctResultadoExcl =
          totalObjetivoExcl > 0
            ? (totalVentasExcl / totalObjetivoExcl) * 100
            : null;

        // Centros AAR / Audiolog铆a avanzada remoto
        const aarCenters = stores.filter((s) => {
          const v = deriveCentroAAR(s);
          return v === "S铆" || v === "En formaci贸n";
        });

        // =====================
        // RENDER
        // =====================

        return (
          <div className="min-h-screen bg-gray-100 font-sans">
            {!authorized ? (
              <div className="flex items-center justify-center h-screen">
                <div className="bg-white p-10 rounded-2xl shadow-xl w-80">
                  <h2 className="text-xl font-bold text-center mb-4">
                    Acceso Plataforma
                  </h2>
                  <input
                    type="password"
                    className="w-full p-2 border rounded mb-4"
                    placeholder="Introduce PIN"
                    value={pin}
                    onChange={(e) => setPin(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === "Enter") handlePin();
                    }}
                  />
                  <button
                    onClick={handlePin}
                    className="w-full bg-blue-600 text-white py-2 rounded-xl shadow"
                  >
                    Entrar
                  </button>
                </div>
              </div>
            ) : (
              <div className="p-6">
                {/* HEADER */}
                <header className="bg-red-600 text-white p-5 rounded-2xl shadow flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="text-3xl"></span>
                    <h1 className="text-2xl font-bold">
                      Seguimiento de procesos de Audio
                    </h1>
                  </div>
                  <div className="flex flex-col items-end gap-1">
                    <div className="flex gap-2">
                      <button
                        onClick={saveToCloud}
                        className="bg-white text-red-600 px-3 py-1 rounded-xl shadow text-xs font-semibold"
                      >
                        Guardar en nube
                      </button>
                      <button
                        onClick={loadFromCloud}
                        className="bg-red-500 text-white px-3 py-1 rounded-xl shadow text-xs font-semibold border border-white/40"
                      >
                        Actualizar desde nube
                      </button>
                    </div>
                    <p className="text-[10px] text-white/80">
                      ltima actualizaci贸n:{" "}
                      <span className="font-semibold">
                        {formatFechaHora(lastSavedAt)}
                      </span>
                    </p>
                  </div>
                </header>

                {/* MAPA + DASHBOARD */}
                <section className="mt-6 space-y-6">
                  {/* Mapa checklist */}
                  <div className="bg-white p-6 rounded-2xl shadow">
                    <h2 className="font-bold text-lg mb-2">
                      Mapa horizontal de checklist de visita
                    </h2>
                    <p className="text-gray-500 mb-4 text-sm">
                      Etapas del proceso de audio seg煤n el checklist oficial.
                    </p>
                    <div className="flex gap-4 overflow-x-auto pb-2">
                      {CHECKLIST.map((stage) => (
                        <div
                          key={stage.etapa}
                          className="min-w-[260px] max-w-xs bg-gray-50 border rounded-2xl px-4 py-3 flex-shrink-0"
                        >
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-[11px] font-bold uppercase tracking-wide text-red-700">
                              {stage.etapa}
                            </span>
                            <span className="text-[10px] text-gray-500">
                              {stage.items.length} pts
                            </span>
                          </div>
                          <ul className="space-y-1">
                            {stage.items.map((item, idx) => (
                              <li
                                key={idx}
                                className="text-[11px] text-gray-700 flex gap-1"
                              >
                                <span className="mt-1 h-1.5 w-1.5 rounded-full bg-red-500 flex-shrink-0" />
                                <span className="leading-tight">{item}</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Dashboard horizontal */}
                  <div className="bg-white p-4 rounded-2xl shadow">
                    <h3 className="font-bold text-sm mb-3">
                      Dashboard horizontal (general y por centro)
                    </h3>
                    {stores.length === 0 ? (
                      <p className="text-xs text-gray-500">
                        A煤n no hay tiendas cargadas. Pega el listado en la
                        secci贸n de LISTADO DE CENTROS.
                      </p>
                    ) : (
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        {/* General */}
                        <div className="bg-gray-50 rounded-2xl px-4 py-3 border flex flex-col gap-2">
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <p className="text-xs font-semibold">
                                General red Afflelou Audio
                              </p>
                              <p className="text-[10px] text-gray-500">
                                Visitas contabilizadas por Excel adjunto
                                (F90).
                              </p>
                            </div>
                            <div
                              className="w-12 h-12 rounded-full flex items-center justify-center text-[10px] font-bold text-red-700"
                              style={donutStyle(checklistMediaGlobal)}
                            >
                              <div className="w-8 h-8 rounded-full bg-white flex items-center justify-center">
                                <span>
                                  {checklistMediaGlobal !== null
                                    ? `${checklistMediaGlobal.toFixed(0)}%`
                                    : "--"}
                                </span>
                              </div>
                            </div>
                          </div>
                          <div className="text-[10px] space-y-1">
                            <p>
                              Total tiendas:{" "}
                              <strong>{totalTiendas}</strong> 路 con al menos 1
                              visita:{" "}
                              <strong>
                                {tiendasConVisita} (
                                {porcentajeTiendasVisitadas.toFixed(0)}%)
                              </strong>
                            </p>
                            <p>
                              Total visitas (Excels adjuntos):{" "}
                              <strong>{totalVisitas}</strong>
                            </p>
                            <p>
                              Checklist medio global (F90):{" "}
                              {checklistMediaGlobal !== null
                                ? `${checklistMediaGlobal.toFixed(0)}%`
                                : "-"}
                            </p>
                            <p>
                              % aplicaci贸n HIT global:{" "}
                              {hitMediaGlobal !== null
                                ? `${hitMediaGlobal.toFixed(0)}%`
                                : "-"}
                              {aplicaHitGlobal && (
                                <span>
                                  {" "}
                                  路 Aplica HIT:{" "}
                                  <strong>{aplicaHitGlobal}</strong>
                                </span>
                              )}
                            </p>
                          </div>
                        </div>

                        {/* Por centro */}
                        <div className="bg-gray-50 rounded-2xl px-4 py-3 border flex flex-col gap-2">
                          <div className="flex items-center justify-between mb-2 gap-2">
                            <div className="flex-1">
                              <p className="text-xs font-semibold mb-1">
                                Detalle por centro
                              </p>
                              <select
                                className="w-full border rounded px-2 py-1 text-[11px]"
                                value={dashboardStoreId || ""}
                                onChange={(e) =>
                                  setDashboardStoreId(
                                    e.target.value
                                      ? Number(e.target.value)
                                      : null
                                  )
                                }
                              >
                                {stores.length === 0 && (
                                  <option value="">
                                    No hay centros cargados
                                  </option>
                                )}
                                {stores.length > 0 && (
                                  <>
                                    <option value="">
                                      (Selecciona un centro)
                                    </option>
                                    {stores.map((s) => (
                                      <option key={s.id} value={s.id}>
                                        {s.centro || s.codigo}
                                      </option>
                                    ))}
                                  </>
                                )}
                              </select>
                            </div>
                            <div
                              className="w-12 h-12 rounded-full flex items-center justify-center text-[10px] font-bold text-red-700"
                              style={donutStyle(dashChecklistMedio)}
                            >
                              <div className="w-8 h-8 rounded-full bg-white flex items-center justify-center">
                                <span>
                                  {dashChecklistMedio !== null
                                    ? `${dashChecklistMedio.toFixed(0)}%`
                                    : "--"}
                                </span>
                              </div>
                            </div>
                          </div>
                          {dashboardStore ? (
                            <>
                              <div className="text-[10px] space-y-1">
                                <p className="font-semibold">
                                  {dashboardStore.centro ||
                                    dashboardStore.codigo}
                                </p>
                                <p>
                                  Provincia:{" "}
                                  <span
                                    className="inline-block px-2 py-0.5 rounded-full"
                                    style={delegadoColor(
                                      dashboardStore.centroRegional
                                    )}
                                  >
                                    {dashboardStore.provincia ||
                                      "Provincia sin definir"}
                                  </span>
                                </p>
                                <p>
                                  N潞 visitas (Excels adjuntos):{" "}
                                  <strong>
                                    {dashVisitasConExcel.length}
                                  </strong>
                                </p>
                                <p>
                                  % checklist medio (F90):{" "}
                                  {dashChecklistMedio !== null
                                    ? `${dashChecklistMedio.toFixed(0)}%`
                                    : "-"}
                                </p>
                                <p>
                                  Aplica HIT:{" "}
                                  <strong>
                                    {dashAplicaHit ? dashAplicaHit : "-"}
                                  </strong>
                                </p>
                              </div>
                            </>
                          ) : (
                            <p className="text-[10px] text-gray-500">
                              Selecciona un centro en el desplegable para ver
                              su detalle.
                            </p>
                          )}
                        </div>
                      </div>
                    )}

                    {algunFechaInvalida && (
                      <p className="text-xs text-red-500 mt-3">
                        Hay fechas con formato incorrecto. Usa siempre el
                        formato <strong>dd/mm/aaaa</strong>.
                      </p>
                    )}
                  </div>
                </section>

                {/* LISTADO DE CENTROS */}
                <section className="mt-10 bg-white p-6 rounded-2xl shadow">
                  <div className="flex flex-col gap-4">
                    <div className="flex flex-wrap items-center justify-between gap-3">
                      <h3 className="font-bold text-lg bg-red-600 text-white inline-flex items-center px-4 py-2 rounded-2xl">
                        LISTADO DE CENTROS
                      </h3>
                      <button
                        className="text-xs px-3 py-1 rounded-full border border-red-300 text-red-700 bg-white/80 hover:bg-white"
                        onClick={() => setShowCarga((p) => !p)}
                      >
                        {showCarga
                          ? "Ocultar edici贸n de listado"
                          : "Cargar / editar listado desde Excel"}
                      </button>
                    </div>

                    {showCarga && (
                      <div className="bg-gray-50 border rounded-2xl p-3">
                        <p className="text-xs text-gray-600 mb-2">
                          Pega aqu铆 el listado de centros desde Excel (una fila
                          por l铆nea, campos separados por tabulador):
                          <br />
                          <span className="font-semibold">
                            CODIGO 路 PROPIETARIO 路 CENTRO 路 PROVINCIA 路 CORREO 路
                            REGIONAL
                          </span>
                        </p>
                        <textarea
                          className="w-full p-2 border rounded mb-2 text-xs h-20"
                          placeholder="Ejemplo:&#10;4ABB&#9;MAZA Oriol&#9;PAMPLONA C. Exclusivo&#9;NAVARRA&#9;navarra.pamplona.carrefour@afflelou.es&#9;Sonia Godino"
                          value={storesInput}
                          onChange={(e) => setStoresInput(e.target.value)}
                        ></textarea>
                        <button
                          onClick={handleApplyStores}
                          className="text-xs px-3 py-1 rounded-full bg-red-600 text-white font-semibold shadow"
                        >
                          Aplicar/actualizar listado
                        </button>
                      </div>
                    )}

                    {/* Fald贸n rojo buscador + filtros */}
                    <div className="bg-red-600 text-white rounded-2xl p-3">
                      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                        <div className="flex items-center gap-2 flex-1">
                          <span className="text-xl"></span>
                          <input
                            type="text"
                            placeholder="Buscar en todos los campos..."
                            className="flex-1 px-3 py-1 rounded text-xs text-gray-800"
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                          />
                        </div>
                        <div className="text-[10px] opacity-90 lg:text-right">
                          Filtros por columna: selecciona un valor en cualquier
                          desplegable para filtrar el listado (como en Excel).
                        </div>
                      </div>

                      <div className="mt-3 flex flex-nowrap gap-2 text-[11px] overflow-x-auto">
                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[110px]"
                          value={filterCodigo}
                          onChange={(e) => setFilterCodigo(e.target.value)}
                        >
                          <option value="">C贸digo (todos)</option>
                          {opcionesCodigo.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[130px]"
                          value={filterPropietario}
                          onChange={(e) =>
                            setFilterPropietario(e.target.value)
                          }
                        >
                          <option value="">Propietario (todos)</option>
                          {opcionesPropietario.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[160px]"
                          value={filterCentro}
                          onChange={(e) => setFilterCentro(e.target.value)}
                        >
                          <option value="">Centro (todos)</option>
                          {opcionesCentro.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[140px]"
                          value={filterProvincia}
                          onChange={(e) => setFilterProvincia(e.target.value)}
                        >
                          <option value="">Provincia (todas)</option>
                          {opcionesProvincia.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[140px]"
                          value={filterCorreo}
                          onChange={(e) => setFilterCorreo(e.target.value)}
                        >
                          <option value="">Correo (todos)</option>
                          {opcionesCorreo.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[150px]"
                          value={filterDelegado}
                          onChange={(e) => setFilterDelegado(e.target.value)}
                        >
                          <option value="">Delegado (todos)</option>
                          {opcionesDelegado.map((op) => (
                            <option key={op} value={op}>
                              {op || "Sin delegado"}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[150px]"
                          value={filterResponsableAudio}
                          onChange={(e) =>
                            setFilterResponsableAudio(e.target.value)
                          }
                        >
                          <option value="">Resp. audio (todos)</option>
                          {opcionesRespAudio.map((op) => (
                            <option key={op} value={op}>
                              {op}
                            </option>
                          ))}
                        </select>

                        <select
                          className="bg-white text-red-700 rounded px-2 py-1 min-w-[120px]"
                          value={filterCentroAAR}
                          onChange={(e) => setFilterCentroAAR(e.target.value)}
                        >
                          <option value="">Centro AAR (todos)</option>
                          <option value="S铆">S铆</option>
                          <option value="No">No</option>
                          <option value="En formaci贸n">En formaci贸n</option>
                        </select>
                      </div>
                    </div>

                    {/* Tabla sin scroll horizontal */}
                    {stores.length === 0 ? (
                      <p className="text-xs text-gray-500">
                        A煤n no hay centros cargados. Pega el listado arriba y
                        pulsa "Aplicar/actualizar listado".
                      </p>
                    ) : (
                      <div className="overflow-y-auto">
                        <table className="w-full text-[11px] border-collapse">
                          <thead>
                            <tr className="bg-gray-50 border-b">
                              <th className="text-left px-2 py-2">N潞</th>
                              <th className="text-left px-2 py-2">C贸digo</th>
                              <th className="text-left px-2 py-2">
                                Propietario
                              </th>
                              <th className="text-left px-2 py-2">Centro</th>
                              <th className="text-left px-2 py-2">
                                Provincia
                              </th>
                              <th className="text-left px-2 py-2">Correo</th>
                              <th className="text-left px-2 py-2">
                                Delegado regional
                              </th>
                              <th className="text-left px-2 py-2">
                                Resp. audio
                              </th>
                              <th className="text-left px-2 py-2">
                                Centro AAR
                              </th>
                              <th className="text-right px-2 py-2">
                                N潞 visitas
                              </th>
                              <th className="text-right px-2 py-2">
                                Checklist medio %
                              </th>
                              <th className="text-right px-2 py-2">
                                Aplica HIT
                              </th>
                              <th className="text-center px-2 py-2">
                                Visitas / checklist (4)
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            {sortedFilteredStores.map((store, index) => {
                              const visitasConExcel = store.visitas.filter(
                                (v) => v.excelName && v.excelName !== ""
                              );
                              const checklistMedioTienda = media(
                                visitasConExcel.map((v) => v.checklist)
                              );
                              const aplicaHitTienda =
                                aplicaHitTexto(visitasConExcel);

                              const respAudioCentro = deriveRespAudio(store);
                              const centroAARValor = deriveCentroAAR(store);
                              const isExpanded =
                                expandedStoreId === store.id;

                              const checklistBadge =
                                checklistMedioTienda !== null ? (
                                  <span
                                    className={`inline-block min-w-[40px] px-2 py-0.5 rounded-full ${
                                      checklistMedioTienda >= 85
                                        ? "bg-green-100 text-green-800"
                                        : "bg-red-100 text-red-700"
                                    }`}
                                  >
                                    {checklistMedioTienda.toFixed(0)}%
                                  </span>
                                ) : (
                                  "-"
                                );

                              const rowExclusive = isExclusiveCenter(
                                store.centro
                              );

                              return (
                                <React.Fragment key={store.id}>
                                  <tr
                                    className={`border-b hover:bg-gray-50 align-top ${
                                      rowExclusive ? "bg-amber-50/60" : ""
                                    }`}
                                  >
                                    <td className="px-2 py-1">
                                      {index + 1}
                                    </td>
                                    <td className="px-2 py-1">
                                      <span className="font-semibold">
                                        {store.codigo || "-"}
                                      </span>
                                    </td>
                                    <td className="px-2 py-1">
                                      {store.propietario || "-"}
                                    </td>
                                    <td className="px-2 py-1">
                                      {store.centro || "-"}
                                    </td>
                                    <td className="px-2 py-1">
                                      <span
                                        className="inline-block px-2 py-0.5 rounded-full"
                                        style={delegadoColor(
                                          store.centroRegional
                                        )}
                                      >
                                        {store.provincia || "-"}
                                      </span>
                                    </td>
                                    <td className="px-2 py-1 break-all">
                                      {store.correo || "-"}
                                    </td>
                                    <td className="px-2 py-1">
                                      <span
                                        className="inline-block px-2 py-0.5 rounded-full"
                                        style={delegadoColor(
                                          store.centroRegional
                                        )}
                                      >
                                        {store.centroRegional ||
                                          "Sin delegado"}
                                      </span>
                                    </td>
                                    <td className="px-2 py-1">
                                      {respAudioCentro || "-"}
                                    </td>
                                    <td className="px-2 py-1">
                                      {centroAARValor || "-"}
                                    </td>
                                    <td className="px-2 py-1 text-right">
                                      {visitasConExcel.length}
                                    </td>
                                    <td className="px-2 py-1 text-right">
                                      {checklistBadge}
                                    </td>
                                    <td className="px-2 py-1 text-right">
                                      {aplicaHitTienda || "-"}
                                    </td>
                                    <td className="px-2 py-1 text-center">
                                      <button
                                        className="text-[10px] px-2 py-1 rounded-full border border-red-400 text-red-600 hover:bg-red-50"
                                        onClick={() =>
                                          setExpandedStoreId(
                                            isExpanded ? null : store.id
                                          )
                                        }
                                      >
                                        {isExpanded
                                          ? "Ocultar visitas"
                                          : "Ver/editar visitas"}
                                      </button>
                                    </td>
                                  </tr>

                                  {isExpanded && (
                                    <tr className="bg-gray-50 border-b">
                                      <td
                                        colSpan={13}
                                        className="px-3 py-3"
                                      >
                                        <div className="text-[11px]">
                                          <p className="font-semibold mb-2">
                                            Visitas y checklist adjunto (hasta
                                            4)  {store.centro || store.codigo}
                                          </p>
                                          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
                                            {store.visitas.map((visit) => (
                                              <div
                                                key={visit.id}
                                                className="border rounded-xl p-2 bg-white"
                                              >
                                                <p className="font-semibold mb-1">
                                                  Visita {visit.id}
                                                </p>
                                                <input
                                                  type="text"
                                                  placeholder="dd/mm/aaaa"
                                                  className={`w-full border rounded px-2 py-1 mb-1 ${
                                                    visit.fecha &&
                                                    !isValidFecha(visit.fecha)
                                                      ? "border-red-500 bg-red-50"
                                                      : ""
                                                  }`}
                                                  value={visit.fecha}
                                                  onChange={(e) =>
                                                    updateVisitField(
                                                      store.id,
                                                      visit.id,
                                                      "fecha",
                                                      e.target.value
                                                    )
                                                  }
                                                />
                                                <select
                                                  className="w-full border rounded px-2 py-1 mb-1"
                                                  value={
                                                    visit.responsable || ""
                                                  }
                                                  onChange={(e) =>
                                                    updateVisitField(
                                                      store.id,
                                                      visit.id,
                                                      "responsable",
                                                      e.target.value
                                                    )
                                                  }
                                                >
                                                  <option value="">
                                                    Resp. audio
                                                  </option>
                                                  <option value="Sonia">
                                                    Sonia
                                                  </option>
                                                  <option value="Ary Rojas">
                                                    Ary Rojas
                                                  </option>
                                                </select>

                                                <label className="inline-flex items-center px-3 py-1 rounded-xl border cursor-pointer hover:bg-gray-50 mb-1">
                                                  <span className="text-[11px] font-semibold">
                                                    Adjuntar Excel checklist
                                                  </span>
                                                  <input
                                                    type="file"
                                                    accept=".xlsx,.xls,.csv"
                                                    className="hidden"
                                                    onChange={(e) =>
                                                      handleChecklistFileChange(
                                                        store.id,
                                                        visit.id,
                                                        e
                                                      )
                                                    }
                                                  />
                                                </label>
                                                <p className="text-[10px] text-gray-500 mb-1 truncate">
                                                  {visit.excelName ||
                                                    "Sin archivo"}
                                                </p>

                                                <div className="grid grid-cols-3 gap-1 mt-1">
                                                  <div>
                                                    <p className="text-[10px] mb-0.5">
                                                      Checklist % (F90)
                                                    </p>
                                                    <input
                                                      type="number"
                                                      min={0}
                                                      max={100}
                                                      className="w-full border rounded px-1 py-0.5"
                                                      value={
                                                        visit.checklist ?? ""
                                                      }
                                                      onChange={(e) => {
                                                        const val =
                                                          e.target.value;
                                                        const num =
                                                          val === ""
                                                            ? null
                                                            : Number(val);
                                                        updateVisitField(
                                                          store.id,
                                                          visit.id,
                                                          "checklist",
                                                          isNaN(num)
                                                            ? null
                                                            : num
                                                        );
                                                      }}
                                                    />
                                                  </div>
                                                  <div>
                                                    <p className="text-[10px] mb-0.5">
                                                      HIT
                                                    </p>
                                                    <select
                                                      className="w-full border rounded px-1 py-0.5"
                                                      value={visit.hit || ""}
                                                      onChange={(e) =>
                                                        updateVisitField(
                                                          store.id,
                                                          visit.id,
                                                          "hit",
                                                          e.target.value
                                                        )
                                                      }
                                                    >
                                                      <option value="">
                                                        -
                                                      </option>
                                                      <option value="S铆">
                                                        S铆
                                                      </option>
                                                      <option value="No">
                                                        No
                                                      </option>
                                                    </select>
                                                  </div>
                                                  <div>
                                                    <p className="text-[10px] mb-0.5">
                                                      Centro AAR
                                                    </p>
                                                    <select
                                                      className="w-full border rounded px-1 py-0.5"
                                                      value={
                                                        visit.centroAAR || ""
                                                      }
                                                      onChange={(e) =>
                                                        updateVisitField(
                                                          store.id,
                                                          visit.id,
                                                          "centroAAR",
                                                          e.target.value
                                                        )
                                                      }
                                                    >
                                                      <option value="">
                                                        -
                                                      </option>
                                                      <option value="S铆">
                                                        S铆
                                                      </option>
                                                      <option value="No">
                                                        No
                                                      </option>
                                                      <option value="En formaci贸n">
                                                        En formaci贸n
                                                      </option>
                                                    </select>
                                                  </div>
                                                </div>

                                                <p className="text-[9px] text-gray-500 mt-1">
                                                  Adjunta el Excel del
                                                  checklist: se lee
                                                  autom谩ticamente el % global
                                                  desde la celda{" "}
                                                  <strong>F90</strong> de la
                                                  hoja{" "}
                                                  <strong>
                                                    "PROCESOS BASICOS"
                                                  </strong>
                                                  .
                                                </p>
                                              </div>
                                            ))}
                                          </div>
                                          <button
                                            className="mt-3 text-[11px] px-3 py-1 rounded-full bg-red-600 text-white font-semibold"
                                            onClick={() =>
                                              setExpandedStoreId(null)
                                            }
                                          >
                                            Guardar visitas de este centro
                                          </button>
                                        </div>
                                      </td>
                                    </tr>
                                  )}
                                </React.Fragment>
                              );
                            })}
                          </tbody>
                        </table>

                        {/* KPIs globales */}
                        <div className="mt-4 text-[11px] text-gray-600 flex flex-wrap gap-3">
                          <span>
                            Total tiendas: <strong>{totalTiendas}</strong>
                          </span>
                          <span>
                            Tiendas con al menos 1 visita (Excel):{" "}
                            <strong>
                              {tiendasConVisita} (
                              {porcentajeTiendasVisitadas.toFixed(0)}%)
                            </strong>
                          </span>
                          <span>
                            Total visitas (Excels adjuntos):{" "}
                            <strong>{totalVisitas}</strong>
                          </span>
                          <span
                            className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full ${kpiBadgeClass(
                              checklistMediaGlobal
                            )}`}
                          >
                            <span className="w-2 h-2 rounded-full bg-current/70" />
                            <span>
                              Checklist medio global (F90):{" "}
                              {checklistMediaGlobal !== null
                                ? `${checklistMediaGlobal.toFixed(0)}%`
                                : "-"}
                            </span>
                          </span>
                          <span
                            className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full ${kpiBadgeClass(
                              hitMediaGlobal
                            )}`}
                          >
                            <span className="w-2 h-2 rounded-full bg-current/70" />
                            <span>
                              % aplicaci贸n HIT global:{" "}
                              {hitMediaGlobal !== null
                                ? `${hitMediaGlobal.toFixed(0)}%`
                                : "-"}
                            </span>
                          </span>
                        </div>
                      </div>
                    )}
                  </div>
                </section>

                {/* CENTROS EXCLUSIVOS */}
                <section className="mt-10 bg-white p-6 rounded-2xl shadow">
                  <h3 className="font-bold text-lg mb-3">
                    Centros exclusivos
                  </h3>
                  {exclusiveStores.length === 0 ? (
                    <p className="text-xs text-gray-500">
                      A煤n no hay centros exclusivos detectados en el listado.
                    </p>
                  ) : (
                    <>
                      {/* Fald贸n resumen con acumulado y color rojo/verde */}
                      <div className="mb-4 text-[11px] bg-amber-50 border border-amber-200 rounded-2xl px-4 py-3 flex flex-wrap gap-4 items-center">
                        <span>
                          N潞 centros exclusivos:{" "}
                          <strong>{exclusiveStores.length}</strong>
                        </span>
                        <span>
                          Ventas acumuladas:{" "}
                          <strong>
                            {totalVentasExcl.toLocaleString("es-ES", {
                              minimumFractionDigits: 0,
                              maximumFractionDigits: 0,
                            })}
                            
                          </strong>
                        </span>
                        <span>
                          Objetivo acumulado:{" "}
                          <strong>
                            {totalObjetivoExcl.toLocaleString("es-ES", {
                              minimumFractionDigits: 0,
                              maximumFractionDigits: 0,
                            })}
                            
                          </strong>
                        </span>
                        <span
                          className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full ${
                            pctResultadoExcl === null
                              ? "bg-gray-100 text-gray-700"
                              : pctResultadoExcl >= 100
                              ? "bg-green-100 text-green-800"
                              : "bg-red-100 text-red-700"
                          }`}
                        >
                          <span className="w-2 h-2 rounded-full bg-current/70" />
                          <span>
                            % resultado acumulado a帽o:{" "}
                            {pctResultadoExcl !== null
                              ? `${pctResultadoExcl.toFixed(0)}%`
                              : "-"}
                          </span>
                        </span>
                      </div>

                      <div className="overflow-x-auto">
                        <table className="w-full text-[11px] border-collapse">
                          <thead>
                            <tr className="bg-amber-50 border-b">
                              <th className="text-left px-2 py-2">Centro</th>
                              <th className="text-left px-2 py-2">
                                Provincia
                              </th>
                              <th className="text-left px-2 py-2">
                                Delegado
                              </th>
                              <th className="text-right px-2 py-2">
                                Ventas mensuales 
                              </th>
                              <th className="text-right px-2 py-2">
                                Objetivo mensual 
                              </th>
                              <th className="text-right px-2 py-2">
                                % resultado
                              </th>
                              <th className="text-center px-2 py-2">
                                Acciones, meses y derivaciones (+)
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            {exclusiveStores.map((s) => {
                              const data = ensureExclusiveEntry(s.id);
                              const acciones = data.acciones || [];
                              const totalVentas = acciones.reduce(
                                (sum, a) =>
                                  sum +
                                  (Number(a.ventasImporte || 0) || 0),
                                0
                              );
                              const totalObjetivo = acciones.reduce(
                                (sum, a) =>
                                  sum +
                                  (Number(a.objetivoImporte || 0) || 0),
                                0
                              );
                              const pct =
                                totalObjetivo > 0
                                  ? (totalVentas / totalObjetivo) * 100
                                  : null;

                              return (
                                <React.Fragment key={s.id}>
                                  <tr className="border-b bg-amber-50/40">
                                    <td className="px-2 py-1 font-semibold">
                                      {s.centro || "-"}
                                    </td>
                                    <td className="px-2 py-1">
                                      <span
                                        className="inline-block px-2 py-0.5 rounded-full"
                                        style={delegadoColor(
                                          s.centroRegional
                                        )}
                                      >
                                        {s.provincia || "-"}
                                      </span>
                                    </td>
                                    <td className="px-2 py-1">
                                      <span
                                        className="inline-block px-2 py-0.5 rounded-full"
                                        style={delegadoColor(
                                          s.centroRegional
                                        )}
                                      >
                                        {s.centroRegional || "Sin delegado"}
                                      </span>
                                    </td>
                                    <td className="px-2 py-1 text-right">
                                      {totalVentas.toLocaleString("es-ES", {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0,
                                      })}
                                    </td>
                                    <td className="px-2 py-1 text-right">
                                      {totalObjetivo.toLocaleString("es-ES", {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0,
                                      })}
                                    </td>
                                    <td className="px-2 py-1 text-right">
                                      {pct === null ? (
                                        "-"
                                      ) : (
                                        <span
                                          className={`inline-block min-w-[40px] px-2 py-0.5 rounded-full ${
                                            pct >= 100
                                              ? "bg-green-100 text-green-800"
                                              : "bg-red-100 text-red-700"
                                          }`}
                                        >
                                          {pct.toFixed(0)}%
                                        </span>
                                      )}
                                    </td>
                                    <td className="px-2 py-1 text-center">
                                      <button
                                        className="text-[10px] px-3 py-1 rounded-full border border-amber-500 text-amber-700 hover:bg-amber-50"
                                        onClick={() =>
                                          setExpandedExclusiveId(
                                            expandedExclusiveId === s.id
                                              ? null
                                              : s.id
                                          )
                                        }
                                      >
                                        Ver / a帽adir (+)
                                      </button>
                                    </td>
                                  </tr>

                                  {expandedExclusiveId === s.id && (
                                    <tr className="bg-amber-50/30 border-b">
                                      <td
                                        colSpan={7}
                                        className="px-3 py-3"
                                      >
                                        <div className="text-[11px]">
                                          <p className="font-semibold mb-2">
                                            Acciones, meses y derivaciones {" "}
                                            {s.centro}
                                          </p>
                                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-3">
                                            {acciones.map((acc) => {
                                              const ventasNum =
                                                Number(
                                                  acc.ventasImporte || 0
                                                ) || 0;
                                              const objetivoNum =
                                                Number(
                                                  acc.objetivoImporte || 0
                                                ) || 0;
                                              const pctAcc =
                                                objetivoNum > 0
                                                  ? (ventasNum /
                                                      objetivoNum) *
                                                    100
                                                  : null;
                                              const resClass =
                                                pctAcc === null
                                                  ? "bg-gray-100 text-gray-700"
                                                  : pctAcc >= 100
                                                  ? "bg-green-100 text-green-800"
                                                  : "bg-red-100 text-red-700";

                                              return (
                                                <div
                                                  key={acc.id}
                                                  className="border rounded-xl p-2 bg-white flex flex-col gap-2"
                                                >
                                                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                                    <div>
                                                      <p className="text-[10px] mb-0.5">
                                                        Acci贸n
                                                      </p>
                                                      <select
                                                        className="w-full border rounded px-2 py-1"
                                                        value={acc.tipo}
                                                        onChange={(e) =>
                                                          updateExclusiveAction(
                                                            s.id,
                                                            acc.id,
                                                            "tipo",
                                                            e.target.value
                                                          )
                                                        }
                                                      >
                                                        <option value="">
                                                          Selecciona...
                                                        </option>
                                                        {ACTION_TYPES.map(
                                                          (t) => (
                                                            <option
                                                              key={t}
                                                              value={t}
                                                            >
                                                              {t}
                                                            </option>
                                                          )
                                                        )}
                                                      </select>
                                                    </div>
                                                    <div>
                                                      <p className="text-[10px] mb-0.5">
                                                        Fecha acci贸n
                                                      </p>
                                                      <input
                                                        type="date"
                                                        className="w-full border rounded px-2 py-1"
                                                        value={
                                                          acc.fecha || ""
                                                        }
                                                        onChange={(e) =>
                                                          updateExclusiveAction(
                                                            s.id,
                                                            acc.id,
                                                            "fecha",
                                                            e.target.value
                                                          )
                                                        }
                                                      />
                                                    </div>
                                                  </div>

                                                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                                    <div>
                                                      <p className="text-[10px] mb-0.5">
                                                        Derivaciones
                                                      </p>
                                                      <input
                                                        type="number"
                                                        min={0}
                                                        className="w-full border rounded px-2 py-1"
                                                        value={
                                                          acc.derivaciones ||
                                                          ""
                                                        }
                                                        onChange={(e) =>
                                                          updateExclusiveAction(
                                                            s.id,
                                                            acc.id,
                                                            "derivaciones",
                                                            e.target.value
                                                          )
                                                        }
                                                      />
                                                    </div>

                                                    <div>
                                                      <p className="text-[10px] mb-0.5">
                                                        Ventas mensuales
                                                      </p>
                                                      <div className="flex gap-1">
                                                        <select
                                                          className="border rounded px-1 py-1 text-[10px] flex-1"
                                                          value={
                                                            acc.ventasMes || ""
                                                          }
                                                          onChange={(e) =>
                                                            updateExclusiveAction(
                                                              s.id,
                                                              acc.id,
                                                              "ventasMes",
                                                              e.target.value
                                                            )
                                                          }
                                                        >
                                                          <option value="">
                                                            Mes
                                                          </option>
                                                          {EXCLUSIVE_MONTHS.map(
                                                            (m) => (
                                                              <option
                                                                key={m.key}
                                                                value={m.key}
                                                              >
                                                                {m.label}
                                                              </option>
                                                            )
                                                          )}
                                                        </select>
                                                        <input
                                                          type="number"
                                                          min={0}
                                                          className="border rounded px-1 py-1 w-24 text-right"
                                                          value={
                                                            acc.ventasImporte ||
                                                            ""
                                                          }
                                                          onChange={(e) =>
                                                            updateExclusiveAction(
                                                              s.id,
                                                              acc.id,
                                                              "ventasImporte",
                                                              e.target.value
                                                            )
                                                          }
                                                        />
                                                      </div>
                                                    </div>

                                                    <div>
                                                      <p className="text-[10px] mb-0.5">
                                                        Objetivo mensual
                                                      </p>
                                                      <div className="flex gap-1">
                                                        <select
                                                          className="border rounded px-1 py-1 text-[10px] flex-1"
                                                          value={
                                                            acc.objetivoMes ||
                                                            ""
                                                          }
                                                          onChange={(e) =>
                                                            updateExclusiveAction(
                                                              s.id,
                                                              acc.id,
                                                              "objetivoMes",
                                                              e.target.value
                                                            )
                                                          }
                                                        >
                                                          <option value="">
                                                            Mes
                                                          </option>
                                                          {EXCLUSIVE_MONTHS.map(
                                                            (m) => (
                                                              <option
                                                                key={m.key}
                                                                value={m.key}
                                                              >
                                                                {m.label}
                                                              </option>
                                                            )
                                                          )}
                                                        </select>
                                                        <input
                                                          type="number"
                                                          min={0}
                                                          className="border rounded px-1 py-1 w-24 text-right"
                                                          value={
                                                            acc.objetivoImporte ||
                                                            ""
                                                          }
                                                          onChange={(e) =>
                                                            updateExclusiveAction(
                                                              s.id,
                                                              acc.id,
                                                              "objetivoImporte",
                                                              e.target.value
                                                            )
                                                          }
                                                        />
                                                      </div>
                                                    </div>
                                                  </div>

                                                  <div className="flex items-center justify-between mt-1">
                                                    <span
                                                      className={
                                                        "inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] " +
                                                        resClass
                                                      }
                                                    >
                                                      <span className="w-2 h-2 rounded-full bg-current/70" />
                                                      <span>
                                                        Resultado % mes:{" "}
                                                        {pctAcc === null
                                                          ? "-"
                                                          : `${pctAcc.toFixed(
                                                              0
                                                            )}%`}
                                                      </span>
                                                    </span>
                                                    <button
                                                      className="text-[10px] px-2 py-0.5 rounded-full border border-red-300 text-red-600 hover:bg-red-50"
                                                      onClick={() =>
                                                        removeExclusiveAction(
                                                          s.id,
                                                          acc.id
                                                        )
                                                      }
                                                    >
                                                      Eliminar
                                                    </button>
                                                  </div>
                                                </div>
                                              );
                                            })}
                                          </div>

                                          <button
                                            className="text-[11px] px-3 py-1 rounded-full bg-amber-500 text-white font-semibold mr-2"
                                            onClick={() =>
                                              addExclusiveAction(s.id)
                                            }
                                          >
                                            A帽adir acci贸n (+)
                                          </button>
                                          <button
                                            className="text-[11px] px-3 py-1 rounded-full bg-amber-700 text-white font-semibold"
                                            onClick={() =>
                                              setExpandedExclusiveId(null)
                                            }
                                          >
                                            Cerrar acciones
                                          </button>
                                        </div>
                                      </td>
                                    </tr>
                                  )}
                                </React.Fragment>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </>
                  )}
                </section>

                {/* AUDIOLOGA AVANZADA REMOTO (AAR) */}
                <section className="mt-10 bg-white p-6 rounded-2xl shadow mb-10">
                  <h3 className="font-bold text-lg mb-3">
                    Audiolog铆a avanzada remoto (AAR)
                  </h3>
                  {aarCenters.length === 0 ? (
                    <p className="text-xs text-gray-500">
                      A煤n no hay centros marcados como AAR o en formaci贸n.
                    </p>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="w-full text-[11px] border-collapse">
                        <thead>
                          <tr className="bg-sky-50 border-b">
                            <th className="text-left px-2 py-2">Centro</th>
                            <th className="text-left px-2 py-2">Provincia</th>
                            <th className="text-left px-2 py-2">Delegado</th>
                            <th className="text-left px-2 py-2">
                              Estado AAR
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          {aarCenters.map((s) => {
                            const estado = deriveCentroAAR(s);
                            const colorEstado =
                              estado === "S铆"
                                ? "bg-green-100 text-green-800"
                                : estado === "En formaci贸n"
                                ? "bg-amber-100 text-amber-800"
                                : "bg-red-100 text-red-700";
                            return (
                              <tr key={s.id} className="border-b">
                                <td className="px-2 py-1">
                                  {s.centro || "-"}
                                </td>
                                <td className="px-2 py-1">
                                  <span
                                    className="inline-block px-2 py-0.5 rounded-full"
                                    style={delegadoColor(s.centroRegional)}
                                  >
                                    {s.provincia || "-"}
                                  </span>
                                </td>
                                <td className="px-2 py-1">
                                  <span
                                    className="inline-block px-2 py-0.5 rounded-full"
                                    style={delegadoColor(s.centroRegional)}
                                  >
                                    {s.centroRegional || "Sin delegado"}
                                  </span>
                                </td>
                                <td className="px-2 py-1">
                                  <span
                                    className={
                                      "inline-block px-2 py-0.5 rounded-full " +
                                      colorEstado
                                    }
                                  >
                                    {estado || "-"}
                                  </span>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                </section>
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
