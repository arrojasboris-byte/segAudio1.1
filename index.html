<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Seguimiento de procesos de Audio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect } = React;

      // ============================================================
      // 1. CHECKLIST (texto descriptivo ‚Äì ya no se muestra como mapa)
      // ============================================================

      const CHECKLIST = [
        {
          etapa: "HOLA",
          items: [
            "Espacio audio limpio, ordenado",
            "Esp√©culos, olivas y cascos desinfectados",
            "Acogida al cliente con una sonrisa, amable y cercana",
            "Llamar al paciente por su nombre",
            "Acompa√±ar al paciente al gabinete para la revisi√≥n auditiva",
            "Confirmar motivo de visita",
          ],
        },
        {
          etapa: "SOY √öNICO",
          items: [
            "Abrir ficha y rellenar RGPD completa (incluidos checks comerciales)",
            "Realizar anamnesis HACE (H√°bitos, Antecedentes, Cl√≠nica, Expectativas)",
            "Anotar al menos 2 expectativas/necesidades concretas",
            "Recoger entorno sonoro y situaciones clave para el paciente",
          ],
        },
        {
          etapa: "MI AUDICI√ìN",
          items: [
            "Explicar brevemente cada prueba y confirmar comprensi√≥n",
            "Evaluar ambos o√≠dos con videotoscopia y explicar procedimiento",
            "Realizar timpanometr√≠a y explicar procedimiento",
            "Realizar v√≠a a√©rea y v√≠a √≥sea explicando cada paso",
            "Mantener TV encendida para comunicar audio y mostrar resultados",
          ],
        },
        {
          etapa: "MI SOLUCI√ìN",
          items: [
            "Resumir claramente los resultados y su impacto",
            "Usar gr√°ficas para apoyar la explicaci√≥n (severidad, √°rea audible, fonemas)",
            "Vincular resultados con s√≠ntomas y quejas de la anamnesis",
            "Hacer visible la p√©rdida auditiva con preguntas de implicaci√≥n",
            "Simular sonidos para mostrar la diferencia con/ sin ayuda",
          ],
        },
        {
          etapa: "PRUEBO",
          items: [
            "Explicar la prueba de capacidad de adaptaci√≥n como prueba de salud",
            "Escoger aud√≠fono seg√∫n perfil en gama adecuada (Diamante)",
            "Realizar programaci√≥n inicial y ajustes seg√∫n perfil",
            "Explicar funcionamiento y mantenimiento para llevarse aud√≠fonos a casa",
            "Entregar documentaci√≥n (contrato, presupuesto, pasaporte)",
          ],
        },
        {
          etapa: "ME COMPROMETO",
          items: [
            "Trabajar resoluci√≥n de objeciones con lenguaje positivo",
            "Explicar facilidades de pago (Infinity / NextYear)",
            "Detallar pack Serenidad y Serenidad + (compromisos)",
            "Explicar en detalle pruebas HIT y su utilidad",
            "Recomendar accesorios de conectividad y productos de higiene",
          ],
        },
        {
          etapa: "ME CONVIERTO EN FAN",
          items: [
            "Explicar llamadas de seguimiento y agenda futura",
            "Reforzar logros y mejoras conseguidas en cada visita",
            "Aplicar t√©cnicas de Neuroventas en el seguimiento",
          ],
        },
        {
          etapa: "SEGUIMIENTO Y AGENDA",
          items: [
            "Registrar prueba en el sistema (Gio)",
            "Llamar al d√≠a siguiente de la prueba para seguimiento",
            "Agendar visita en 4 d√≠as para revisi√≥n",
          ],
        },
        {
          etapa: "COMUNICACI√ìN DEL CENTRO",
          items: [
            "Comunicaci√≥n del centro adecuada a su perfil",
            "Revisi√≥n de comunicaci√≥n en RRSS",
            "Uniformidad adecuada",
            "Contacto con locales vecinos y colaboraciones",
            "Escaparate atractivo con novedad de producto",
          ],
        },
        {
          etapa: "AYUDAS Y ACUERDOS",
          items: [
            "Conocer y activar acuerdos con FIAPAS y ONCE",
            "Revisar convenios locales (anotar detalle en observaciones)",
            "Conocer ayudas de comunidad aut√≥noma",
            "Conocer ayudas generales +65 a√±os y hasta 26 a√±os",
          ],
        },
        {
          etapa: "INCENTIVOS",
          items: ["Incentivos por derivaci√≥n", "Incentivos por AAR"],
        },
        {
          etapa: "FORMACI√ìN",
          items: [
            "Onboarding Academy realizado",
            "Formaciones obligatorias de centros exclusivos cumplimentadas",
            "Formaciones obligatorias de centros audio realizadas",
          ],
        },
      ];

      // ============================================================
      // 2. UTILIDADES GENERALES
      // ============================================================

      function createEmptyVisits() {
        return [1, 2, 3, 4].map((id) => ({
          id,
          fecha: "",
          responsable: "",
          excelName: "",
          hit: "",
          checklist: null, // % global F90
          centroAAR: "",
          points: {}, // resultados punto a punto (clave = n¬∫ proceso, valor 0/1)
        }));
      }

      function normalizarCentro(nombre) {
        return (nombre || "").trim().toUpperCase();
      }

      function normalizarDelegado(nombre) {
        const trimmed = (nombre || "").trim();
        if (!trimmed) return "";
        return trimmed
          .toLowerCase()
          .split(/\s+/)
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
          .join(" ");
      }

      function normalizeBasic(str) {
        return (str || "")
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toUpperCase()
          .trim();
      }

      const CENTER_TO_PROVINCE = {};
      const CITY_TO_PROVINCE = {
        NARON: "A CORU√ëA (GALICIA)",
        "NAR√ìN": "A CORU√ëA (GALICIA)",
        ONDARA: "ALICANTE (COMUNITAT VALENCIANA)",
      };

      function inferProvincia(centro, provinciaExcel) {
        if (provinciaExcel && provinciaExcel.trim() !== "") {
          return provinciaExcel.trim().toUpperCase();
        }
        const centroNorm = normalizarCentro(centro);
        if (CENTER_TO_PROVINCE[centroNorm]) {
          return CENTER_TO_PROVINCE[centroNorm];
        }
        const tokens = centroNorm
          .split(/[,\-()]/)
          .map((t) => t.trim())
          .filter(Boolean);
        for (let i = tokens.length - 1; i >= 0; i--) {
          const token = tokens[i];
          if (CITY_TO_PROVINCE[token]) {
            return CITY_TO_PROVINCE[token];
          }
        }
        return "";
      }

      function parseFecha(fecha) {
        const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
        const match = (fecha || "").match(regex);
        if (!match) return null;
        const day = Number(match[1]);
        const month = Number(match[2]);
        const year = Number(match[3]);
        const d = new Date(year, month - 1, day);
        if (
          d.getFullYear() !== year ||
          d.getMonth() !== month - 1 ||
          d.getDate() !== day
        ) {
          return null;
        }
        return d;
      }

      function isValidFecha(fecha) {
        if (!fecha) return true;
        return parseFecha(fecha) !== null;
      }

      function media(valores) {
        const nums = (valores || []).filter(
          (v) => typeof v === "number" && !isNaN(v)
        );
        if (nums.length === 0) return null;
        const total = nums.reduce((sum, v) => sum + v, 0);
        return total / nums.length;
      }

      function porcentajeSi(valores) {
        const valid = (valores || []).filter(
          (v) => v === "S√≠" || v === "No"
        );
        if (valid.length === 0) return null;
        const countSi = valid.filter((v) => v === "S√≠").length;
        return (countSi / valid.length) * 100;
      }

      function donutStyle3D(percent) {
        const safe =
          typeof percent === "number" && !isNaN(percent) && percent > 0
            ? Math.min(percent, 100)
            : 0;
        const color =
          percent !== null && safe >= 85 ? "#16a34a" : "#dc2626";
        return {
          background: `conic-gradient(${color} ${safe * 3.6}deg, #e5e7eb 0deg)`,
          boxShadow: "0 14px 30px rgba(15,23,42,0.35)",
        };
      }

      function delegadoColor(delegado) {
        if (!delegado) return {};
        let hash = 0;
        const texto = delegado.trim().toUpperCase();
        for (let i = 0; i < texto.length; i++) {
          hash = (hash * 31 + texto.charCodeAt(i)) | 0;
        }
        const hue = (Math.abs(hash) % 360 + 180) % 360;
        return {
          backgroundColor: `hsl(${hue}, 75%, 90%)`,
          color: `hsl(${hue}, 35%, 28%)`,
        };
      }

      function getUniqueSorted(values) {
        const set = new Set(
          values
            .map((v) => (v || "").trim())
            .filter((v) => v.length > 0)
        );
        return Array.from(set).sort((a, b) =>
          a.localeCompare(b, "es", { sensitivity: "base" })
        );
      }

      function aplicaHitTexto(visitas) {
        const hits = (visitas || []).filter(
          (v) => v.hit === "S√≠" || v.hit === "No"
        );
        if (hits.length === 0) return null;
        const anyYes = hits.some((v) => v.hit === "S√≠");
        return anyYes ? "S√≠" : "No";
      }

      function formatFechaHora(iso) {
        if (!iso) return "Sin guardado";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "Sin guardado";
        return d.toLocaleString("es-ES");
      }

      function deriveRespAudio(store) {
        if (store.responsableAudio && store.responsableAudio.trim()) {
          return store.responsableAudio;
        }
        const visitas = store.visitas || [];
        const copia = [...visitas].reverse();
        const visitaConResp = copia.find((v) => v.responsable);
        return visitaConResp ? visitaConResp.responsable : "";
      }

      function deriveCentroAAR(store) {
        if (store.centroAAR === "S√≠" || store.centroAAR === "No") {
          return store.centroAAR;
        }
        const visitas = store.visitas || [];
        const valores = visitas
          .map((v) => v.centroAAR)
          .filter((v) => v === "S√≠" || v === "No");
        if (valores.length === 0) return "";
        if (valores.includes("S√≠")) return "S√≠";
        return "No";
      }

      // ============================================================
      // 3. CENTROS EXCLUSIVOS ‚Äì configuraci√≥n
      // ============================================================

      const EXCLUSIVE_CENTER_NAMES = [
        "PAMPLONA C. EXCLUSIVO",
        "CC LOS VALLES",
        "SANTIAGO DE COMPOSTELA RUA DA ROSA",
        "CC PLAZA DE LA ESTACI√ìN",
        "REINA DE MERCEDES",
        "SANTANDER CC PE√ëACASTILLO",
        "TORRELAVEGA CARREFOUR CC",
        "ZARAGOZA CALLE DELICIAS",
      ].map(normalizarCentro);

      const EXCLUSIVE_CENTER_SET = new Set(
        EXCLUSIVE_CENTER_NAMES.map(normalizeBasic)
      );

      const EXCLUSIVE_MONTHS = [
        { key: "2025-08", label: "Ago 2025" },
        { key: "2025-09", label: "Sep 2025" },
        { key: "2025-10", label: "Oct 2025" },
        { key: "2025-11", label: "Nov 2025" },
        { key: "2025-12", label: "Dic 2025" },
        { key: "2026-01", label: "Ene 2026" },
        { key: "2026-02", label: "Feb 2026" },
        { key: "2026-03", label: "Mar 2026" },
        { key: "2026-04", label: "Abr 2026" },
        { key: "2026-05", label: "May 2026" },
        { key: "2026-06", label: "Jun 2026" },
        { key: "2026-07", label: "Jul 2026" },
      ];

      function defaultExclusiveData() {
        return {
          ventas: {},
          objetivos: {},
          acciones: [],
        };
      }

      // ============================================================
      // 4. BARRAS 3D POR PROCESO + TABLA EXCEL
      // ============================================================

      function ChecklistBarChart3D({
        title,
        stats,
        showTable,
        onToggleTable,
      }) {
        const totalProcesos = stats.length;
        const maxPercent = stats.length
          ? Math.max(
              100,
              ...stats.map((s) =>
                typeof s.percent === "number" ? s.percent : 0
              )
            )
          : 100;

        return (
          <div className="bg-gray-50 p-4 rounded-2xl border flex flex-col h-full">
            <div className="flex items-center justify-between mb-2">
              <h4 className="font-semibold text-xs md:text-sm">
                {title}
              </h4>
              <button
                className="flex items-center gap-1 text-[10px] px-2 py-1 rounded-full border border-sky-300 text-sky-700 hover:bg-sky-50 hover:shadow cursor-pointer"
                onClick={onToggleTable}
                title="Ver datos en formato tabla tipo Excel"
              >
                üìä <span>{showTable ? "Ocultar tabla" : "Ver tabla"}</span>
              </button>
            </div>

            {stats.length === 0 ? (
              <p className="text-[10px] text-gray-500">
                A√∫n no hay datos por proceso. Adjunta alg√∫n checklist
                (con 0/1 en la columna F) para ver la aplicaci√≥n del
                checklist por proceso.
              </p>
            ) : (
              <>
                {/* Gr√°fico de barras 3D */}
                <div className="mt-2 relative h-48">
                  {/* Eje Y */}
                  <div className="absolute left-0 top-1 bottom-6 w-8 flex flex-col justify-between text-[9px] text-gray-400">
                    <span>100%</span>
                    <span>50%</span>
                    <span>0%</span>
                  </div>

                  {/* Barras */}
                  <div className="ml-8 h-full overflow-x-auto">
                    <div className="h-full flex items-end gap-1 border-l border-b pl-1 pr-3">
                      {stats.map((s) => {
                        const h =
                          maxPercent > 0
                            ? Math.max(
                                4,
                                (s.percent / maxPercent) * 90
                              )
                            : 0;
                        return (
                          <div
                            key={s.point}
                            className="group flex flex-col items-center justify-end min-w-[18px]"
                          >
                            <div className="relative w-4 flex items-end h-full">
                              <div
                                className="w-full rounded-t-md border border-sky-500 bg-gradient-to-tr from-sky-200 via-sky-400 to-sky-700 shadow-[3px_-3px_6px_rgba(15,23,42,0.28)] transition-transform group-hover:-translate-y-1"
                                style={{ height: `${h}%` }}
                              >
                                {/* Tooltip */}
                                <div className="absolute -top-6 left-1/2 -translate-x-1/2 hidden group-hover:flex flex-col items-center text-[9px] bg-white px-1.5 py-0.5 rounded shadow-lg border border-gray-200">
                                  <span className="font-semibold">
                                    {s.percent.toFixed(0)}%
                                  </span>
                                  <span className="text-[8px] text-gray-500">
                                    {s.applied} / {s.total} aplica
                                  </span>
                                </div>
                              </div>
                            </div>
                            <span className="mt-1 text-[8px] text-gray-500">
                              {s.point}
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>

                <p className="mt-1 text-[10px] text-gray-500">
                  Procesos con datos:{" "}
                  <span className="font-semibold">
                    {totalProcesos}
                  </span>
                  . Pasa el rat√≥n por encima de cada barra para ver el
                  % y el n¬∫ de aplicaciones.
                </p>
              </>
            )}

            {/* Tabla tipo Excel */}
            {showTable && stats.length > 0 && (
              <div className="mt-3 bg-white border rounded-xl p-2 text-[10px]">
                <div className="flex items-center justify-between mb-1">
                  <p className="font-semibold">
                    Tabla de procesos (para consulta / impresi√≥n)
                  </p>
                  <button
                    className="px-2 py-1 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-50 cursor-pointer"
                    onClick={() => {
                      if (typeof window !== "undefined") {
                        window.print();
                      }
                    }}
                  >
                    üñ® Imprimir
                  </button>
                </div>
                <div className="overflow-x-auto max-h-56">
                  <table className="w-full text-[10px] border-collapse">
                    <thead>
                      <tr className="bg-gray-50 border-b">
                        <th className="text-left px-2 py-1">
                          N¬∫ proceso
                        </th>
                        <th className="text-right px-2 py-1">
                          % aplicaci√≥n
                        </th>
                        <th className="text-right px-2 py-1">
                          Aplicaciones / total
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {stats.map((s) => (
                        <tr key={s.point} className="border-b">
                          <td className="px-2 py-1">{s.point}</td>
                          <td className="px-2 py-1 text-right">
                            {s.percent.toFixed(1)}%
                          </td>
                          <td className="px-2 py-1 text-right">
                            {s.applied} / {s.total}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        );
      }

      // ============================================================
      // 5. DONUT KPI 3D
      // ============================================================

      function KpiDonut3D({ label, percent }) {
        return (
          <div className="flex flex-col items-center justify-center text-center">
            <p className="mb-3 text-xs font-semibold">{label}</p>
            <div className="relative w-28 h-28 md:w-32 md:h-32">
              <div
                className="w-full h-full rounded-full flex items-center justify-center"
                style={donutStyle3D(percent)}
              >
                <div className="w-20 h-20 md:w-24 md:h-24 rounded-full bg-gradient-to-br from-white via-slate-50 to-slate-200 flex items-center justify-center shadow-inner">
                  <span className="text-sm md:text-base font-bold text-slate-800">
                    {percent !== null && !isNaN(percent)
                      ? `${percent.toFixed(0)}%`
                      : "--"}
                  </span>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ============================================================
      // 6. COMPONENTE PRINCIPAL
      // ============================================================

      function App() {
        const [pin, setPin] = useState("");
        const [authorized, setAuthorized] = useState(false);

        // Filtros listado centros
        const [search, setSearch] = useState("");
        const [filterCodigo, setFilterCodigo] = useState("");
        const [filterPropietario, setFilterPropietario] = useState("");
        const [filterCentro, setFilterCentro] = useState("");
        const [filterProvincia, setFilterProvincia] = useState("");
        const [filterDelegado, setFilterDelegado] = useState("");
        const [filterResponsableAudio, setFilterResponsableAudio] =
          useState("");
        const [filterCentroAAR, setFilterCentroAAR] = useState("");
        const [filterCorreo, setFilterCorreo] = useState("");

        const [storesInput, setStoresInput] = useState("");
        const [stores, setStores] = useState([]);
        const [expandedStoreId, setExpandedStoreId] = useState(null);
        const [showCarga, setShowCarga] = useState(false);
        const [lastSavedAt, setLastSavedAt] = useState(null);

        // Centros exclusivos
        const [expandedExclusiveId, setExpandedExclusiveId] =
          useState(null);
        const [selectedSalesMonth, setSelectedSalesMonth] = useState(
          EXCLUSIVE_MONTHS[0].key
        );
        const [selectedTargetMonth, setSelectedTargetMonth] = useState(
          EXCLUSIVE_MONTHS[0].key
        );

        // Tablas Excel de gr√°ficos
        const [showTableAAO, setShowTableAAO] = useState(false);
        const [showTableExclusive, setShowTableExclusive] =
          useState(false);

        // Cargar de "nube" (localStorage)
        useEffect(() => {
          try {
            const raw = localStorage.getItem("seguimientoAudioV1");
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed.stores) {
              const normalizedStores = parsed.stores.map((s, idx) => {
                const centroNorm = normalizarCentro(s.centro || "");
                const isExclusive = EXCLUSIVE_CENTER_SET.has(
                  normalizeBasic(centroNorm)
                );
                return {
                  ...s,
                  id: idx + 1,
                  centroRegional: normalizarDelegado(s.centroRegional || ""),
                  visitas: (s.visitas || []).map((v, i) => ({
                    id: v.id || i + 1,
                    fecha: v.fecha || "",
                    responsable: v.responsable || "",
                    excelName: v.excelName || "",
                    hit: v.hit || "",
                    checklist:
                      typeof v.checklist === "number" ? v.checklist : null,
                    centroAAR: v.centroAAR || "",
                    points: v.points || {},
                  })),
                  isExclusive,
                  exclusiveData: isExclusive
                    ? {
                        ventas:
                          (s.exclusiveData && s.exclusiveData.ventas) || {},
                        objetivos:
                          (s.exclusiveData && s.exclusiveData.objetivos) ||
                          {},
                        acciones:
                          (s.exclusiveData && s.exclusiveData.acciones) ||
                          [],
                      }
                    : undefined,
                };
              });
              setStores(normalizedStores);
            }
            if (parsed.lastSavedAt) setLastSavedAt(parsed.lastSavedAt);
          } catch (e) {
            console.error("Error al cargar de la nube/localStorage", e);
          }
        }, []);

        function handlePin() {
          if (pin.trim().toUpperCase() === "AR4321") setAuthorized(true);
        }

        // ---------------------- Carga listado de tiendas ----------------------

        function handleApplyStores() {
          if (!storesInput.trim()) return;
          let lines = storesInput
            .split("\n")
            .map((line) => line.trim())
            .filter(Boolean);

          if (
            lines.length > 0 &&
            lines[0].toUpperCase().includes("CODIGO") &&
            lines[0].toUpperCase().includes("PROPIETARIO")
          ) {
            lines = lines.slice(1);
          }

          const newStores = lines.map((raw, index) => {
            const parts = raw.split("\t");
            const [
              codigo = "",
              propietario = "",
              centro = "",
              provincia = "",
              correo = "",
              centroRegional = "",
            ] = parts;
            const provinciaInferida = inferProvincia(centro, provincia);
            const delegadoNormalizado = normalizarDelegado(centroRegional);
            const centroNorm = normalizarCentro(centro);
            const isExclusive = EXCLUSIVE_CENTER_SET.has(
              normalizeBasic(centroNorm)
            );
            return {
              id: index + 1,
              raw,
              codigo,
              propietario,
              centro,
              provincia: provinciaInferida,
              correo,
              centroRegional: delegadoNormalizado,
              region: "",
              responsableAudio: "",
              centroAAR: "",
              visitas: createEmptyVisits(),
              isExclusive,
              exclusiveData: isExclusive ? defaultExclusiveData() : undefined,
            };
          });

          setStores(newStores);
          setExpandedStoreId(null);
        }

        function updateStoreField(id, field, value) {
          setStores((prev) =>
            prev.map((store) =>
              store.id === id ? { ...store, [field]: value } : store
            )
          );
        }

        function updateVisitField(storeId, visitId, field, value) {
          setStores((prev) =>
            prev.map((store) => {
              if (store.id !== storeId) return store;
              return {
                ...store,
                visitas: store.visitas.map((visit) =>
                  visit.id === visitId ? { ...visit, [field]: value } : visit
                ),
              };
            })
          );
        }

        // ------- LECTURA EXCEL Checklist (F90 + puntos por proceso) -------

        function handleChecklistFileChange(storeId, visitId, event) {
          const file = event.target.files && event.target.files[0];
          if (!file) return;

          updateVisitField(storeId, visitId, "excelName", file.name);

          const reader = new FileReader();
          const isExcel =
            file.name.toLowerCase().endsWith(".xlsx") ||
            file.name.toLowerCase().endsWith(".xls");

          reader.onload = (ev) => {
            try {
              const data = ev.target.result;
              let checklistFromF90Set = false;

              if (isExcel && window.XLSX) {
                const wb = XLSX.read(data, { type: "array" });

                // 1) Buscar hoja para F90
                let sheetName = wb.SheetNames[0];
                if (wb.SheetNames.includes("PROCESOS BASICOS")) {
                  sheetName = "PROCESOS BASICOS";
                }
                const sheet = wb.Sheets[sheetName];

                // F90 => % checklist
                let checklistF90 = null;
                const cell = sheet["F90"];
                if (cell && cell.v != null) {
                  let rawVal = cell.v;
                  if (typeof rawVal === "number") {
                    let v = rawVal;
                    if (v <= 1) v = v * 100;
                    checklistF90 = v;
                  } else if (typeof rawVal === "string") {
                    const m = rawVal
                      .replace(",", ".")
                      .match(/(\d{1,3}(?:\.\d+)?)/);
                    if (m) {
                      let v = parseFloat(m[1]);
                      if (v <= 1) v = v * 100;
                      checklistF90 = v;
                    }
                  }
                }

                if (checklistF90 !== null && !isNaN(checklistF90)) {
                  updateVisitField(storeId, visitId, "checklist", checklistF90);
                  checklistFromF90Set = true;
                }

                // 2) Buscar hoja con procesos (columna F con 0/1)
                let sheetProcName = null;
                if (wb.SheetNames.includes("PROCESOS BASICOS")) {
                  sheetProcName = "PROCESOS BASICOS";
                } else {
                  const found = wb.SheetNames.find((n) =>
                    n.toUpperCase().includes("CHECKLIST")
                  );
                  if (found) sheetProcName = found;
                }

                if (sheetProcName) {
                  const sProc = wb.Sheets[sheetProcName];
                  const points = {};
                  for (let row = 8; row <= 120; row++) {
                    const labelCell = sProc["B" + row];
                    if (!labelCell || labelCell.v == null) continue;
                    const valCell = sProc["F" + row];
                    if (!valCell || valCell.v == null) continue;
                    const raw = String(valCell.v).trim().toUpperCase();
                    let value = null;
                    if (raw === "1" || raw === "SI" || raw === "S√ç" || raw === "X") {
                      value = 1;
                    } else if (raw === "0" || raw === "NO") {
                      value = 0;
                    }
                    if (value !== null) {
                      const pointIndex = row - 7; // 8->1, 9->2...
                      points[pointIndex] = value;
                    }
                  }
                  if (Object.keys(points).length > 0) {
                    updateVisitField(storeId, visitId, "points", points);
                  }
                }

                // 3) Buscar HIT como apoyo
                const csv = XLSX.utils.sheet_to_csv(sheet);
                parseFromText(csv, checklistFromF90Set);
              } else {
                const text =
                  typeof data === "string"
                    ? data
                    : new TextDecoder("utf-8").decode(data);
                parseFromText(text, false);
              }
            } catch (e) {
              console.error("Error leyendo Excel de checklist", e);
            }
          };

          if (isExcel) {
            reader.readAsArrayBuffer(file);
          } else {
            reader.readAsText(file);
          }

          function parseFromText(text, checklistAlreadySet) {
            if (!text) return;

            // HIT s√≠ / no
            const reHit = /hit[^a-zA-Z0-9]{0,15}(s[i√≠]|no)/i;
            const mHit = text.match(reHit);
            if (mHit) {
              const val = mHit[1].toLowerCase().startsWith("s")
                ? "S√≠"
                : "No";
              updateVisitField(storeId, visitId, "hit", val);
            }

            if (!checklistAlreadySet) {
              const reCap =
                /capacitaci[o√≥]n[^0-9%]{0,80}(\d{1,3})\s*%/i;
              const mCap = text.match(reCap);
              if (mCap) {
                const n = Number(mCap[1]);
                if (!isNaN(n)) {
                  updateVisitField(storeId, visitId, "checklist", n);
                }
              }
            }
          }
        }

        // ---------------------- Guardar / cargar nube ----------------------

        function saveToCloud() {
          try {
            const payload = {
              stores,
              lastSavedAt: new Date().toISOString(),
            };
            localStorage.setItem(
              "seguimientoAudioV1",
              JSON.stringify(payload)
            );
            setLastSavedAt(payload.lastSavedAt);
          } catch (e) {
            console.error("Error al guardar en nube/localStorage", e);
          }
        }

        function loadFromCloud() {
          try {
            const raw = localStorage.getItem("seguimientoAudioV1");
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed.stores) {
              const normalizedStores = parsed.stores.map((s, idx) => {
                const centroNorm = normalizarCentro(s.centro || "");
                const isExclusive = EXCLUSIVE_CENTER_SET.has(
                  normalizeBasic(centroNorm)
                );
                return {
                  ...s,
                  id: idx + 1,
                  centroRegional: normalizarDelegado(s.centroRegional || ""),
                  visitas: (s.visitas || []).map((v, i) => ({
                    id: v.id || i + 1,
                    fecha: v.fecha || "",
                    responsable: v.responsable || "",
                    excelName: v.excelName || "",
                    hit: v.hit || "",
                    checklist:
                      typeof v.checklist === "number" ? v.checklist : null,
                    centroAAR: v.centroAAR || "",
                    points: v.points || {},
                  })),
                  isExclusive,
                  exclusiveData: isExclusive
                    ? {
                        ventas:
                          (s.exclusiveData && s.exclusiveData.ventas) || {},
                        objetivos:
                          (s.exclusiveData && s.exclusiveData.objetivos) ||
                          {},
                        acciones:
                          (s.exclusiveData && s.exclusiveData.acciones) ||
                          [],
                      }
                    : undefined,
                };
              });
              setStores(normalizedStores);
              setExpandedStoreId(null);
            }
            if (parsed.lastSavedAt) setLastSavedAt(parsed.lastSavedAt);
          } catch (e) {
            console.error("Error al leer de nube/localStorage", e);
          }
        }

        // ---------------------- FILTRADO LISTADO TIENDAS ----------------------

        const filteredStores = stores.filter((store) => {
          const respAudio = deriveRespAudio(store);
          const centroAARValor = deriveCentroAAR(store);
          const textoGlobal = (
            store.codigo +
            " " +
            store.propietario +
            " " +
            store.centro +
            " " +
            store.provincia +
            " " +
            store.centroRegional +
            " " +
            store.correo +
            " " +
            respAudio +
            " " +
            centroAARValor
          )
            .toLowerCase()
            .trim();

          if (search && !textoGlobal.includes(search.toLowerCase()))
            return false;

          if (
            filterCodigo &&
            store.codigo.toLowerCase() !== filterCodigo.toLowerCase()
          )
            return false;

          if (
            filterPropietario &&
            store.propietario.toLowerCase() !==
              filterPropietario.toLowerCase()
          )
            return false;

          if (
            filterCentro &&
            store.centro.toLowerCase() !== filterCentro.toLowerCase()
          )
            return false;

          if (
            filterCorreo &&
            store.correo.toLowerCase() !== filterCorreo.toLowerCase()
          )
            return false;

          if (
            filterProvincia &&
            store.provincia.toLowerCase() !== filterProvincia.toLowerCase()
          )
            return false;

          if (
            filterDelegado &&
            store.centroRegional.toLowerCase() !==
              filterDelegado.toLowerCase()
          )
            return false;

          if (
            filterResponsableAudio &&
            respAudio.toLowerCase() !==
              filterResponsableAudio.toLowerCase()
          )
            return false;

          if (
            filterCentroAAR &&
            centroAARValor.toLowerCase() !== filterCentroAAR.toLowerCase()
          )
            return false;

          return true;
        });

        const sortedFilteredStores = [...filteredStores].sort((a, b) => {
          const da = (a.centroRegional || "").toLowerCase();
          const db = (b.centroRegional || "").toLowerCase();
          const cmpD = da.localeCompare(db, "es", { sensitivity: "base" });
          if (cmpD !== 0) return cmpD;
          const ca = (a.centro || "").toLowerCase();
          const cb = (b.centro || "").toLowerCase();
          return ca.localeCompare(cb, "es", { sensitivity: "base" });
        });

        const opcionesCodigo = getUniqueSorted(stores.map((s) => s.codigo));
        const opcionesPropietario = getUniqueSorted(
          stores.map((s) => s.propietario)
        );
        const opcionesCentro = getUniqueSorted(stores.map((s) => s.centro));
        const opcionesProvincia = getUniqueSorted(
          stores.map((s) => s.provincia)
        );
        const opcionesCorreo = getUniqueSorted(stores.map((s) => s.correo));
        const opcionesDelegado = getUniqueSorted(
          stores.map((s) => s.centroRegional)
        );
        const opcionesRespAudio = getUniqueSorted(
          stores.map((s) => deriveRespAudio(s))
        );

        // ---------------------- M√âTRICAS GLOBALES PARA CUADRO DE MANDO ----------------------

        const allVisits = stores.flatMap((s) => s.visitas || []);
        const algunFechaInvalida = allVisits.some(
          (v) => v.fecha && !isValidFecha(v.fecha)
        );

        const visitsWithExcel = allVisits.filter(
          (v) => v.excelName && v.excelName !== ""
        );

        const visitsAAOWithExcel = stores
          .filter((s) => !s.isExclusive)
          .flatMap((s) => s.visitas || [])
          .filter((v) => v.excelName && v.excelName !== "");

        const visitsExclusiveWithExcel = stores
          .filter((s) => s.isExclusive)
          .flatMap((s) => s.visitas || [])
          .filter((v) => v.excelName && v.excelName !== "");

        const checklistMediaAAO = media(
          visitsAAOWithExcel.map((v) => v.checklist)
        );
        const checklistMediaExclusive = media(
          visitsExclusiveWithExcel.map((v) => v.checklist)
        );

        const hitAplicacionGlobal = porcentajeSi(
          visitsWithExcel.map((v) => v.hit)
        );

        const totalCentros = stores.length;
        const centrosAARSi = stores.filter(
          (s) => deriveCentroAAR(s) === "S√≠"
        ).length;
        const pctCentrosAAR =
          totalCentros > 0 ? (centrosAARSi / totalCentros) * 100 : null;

        function computePointStats(isExclusive) {
          const map = new Map(); // point -> {applied, total}
          stores.forEach((store) => {
            if (!!store.isExclusive !== isExclusive) return;
            (store.visitas || []).forEach((v) => {
              if (!v.points) return;
              Object.entries(v.points).forEach(([key, val]) => {
                if (val !== 0 && val !== 1) return;
                const point = Number(key);
                const prev = map.get(point) || { applied: 0, total: 0 };
                prev.total += 1;
                if (val === 1) prev.applied += 1;
                map.set(point, prev);
              });
            });
          });

          return Array.from(map.entries())
            .map(([point, agg]) => ({
              point,
              applied: agg.applied,
              total: agg.total,
              percent:
                agg.total > 0 ? (agg.applied / agg.total) * 100 : 0,
            }))
            .sort((a, b) => a.point - b.point);
        }

        const pointStatsAAO = computePointStats(false);
        const pointStatsExclusive = computePointStats(true);

        const totalTiendas = stores.length;
        const tiendasConVisita = stores.filter((s) =>
          (s.visitas || []).some((v) => v.excelName && v.excelName !== "")
        ).length;
        const totalVisitas = visitsWithExcel.length;
        const porcentajeTiendasVisitadas =
          totalTiendas > 0
            ? (tiendasConVisita / totalTiendas) * 100
            : 0;

        // ---------------------- CENTROS EXCLUSIVOS: m√©tricas anuales ----------------------

        const exclusiveStores = stores.filter((s) => s.isExclusive);

        function getExclusiveTotals(store) {
          const data = store.exclusiveData || defaultExclusiveData();
          let ventasTotal = 0;
          let objetivosTotal = 0;
          EXCLUSIVE_MONTHS.forEach((m) => {
            ventasTotal += Number(data.ventas[m.key] || 0);
            objetivosTotal += Number(data.objetivos[m.key] || 0);
          });
          const pct =
            objetivosTotal > 0
              ? (ventasTotal / objetivosTotal) * 100
              : null;
          return { ventasTotal, objetivosTotal, pct };
        }

        let ventasAcumuladas = 0;
        let objetivosAcumulados = 0;
        exclusiveStores.forEach((s) => {
          const t = getExclusiveTotals(s);
          ventasAcumuladas += t.ventasTotal;
          objetivosAcumulados += t.objetivosTotal;
        });
        const pctAcumulado =
          objetivosAcumulados > 0
            ? (ventasAcumuladas / objetivosAcumulados) * 100
            : null;

        function resultColorClass(pct) {
          if (pct === null) return "bg-gray-200 text-gray-700";
          if (pct >= 100) return "bg-green-100 text-green-800";
          return "bg-red-100 text-red-700";
        }

        function updateExclusiveMonthValue(storeId, field, monthKey, value) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const existing = s.exclusiveData || defaultExclusiveData();
              return {
                ...s,
                exclusiveData: {
                  ...existing,
                  [field]: {
                    ...existing[field],
                    [monthKey]: value,
                  },
                },
              };
            })
          );
        }

        const ACTION_TYPES = [
          "Stand",
          "Mailing",
          "Cashback",
          "Azafata calle",
          "Ruleta",
          "Acci√≥n colectivo",
          "Call center",
          "Acci√≥n derivaci√≥n tienda",
          "Derivaci√≥n colectivo",
        ];

        function addExclusiveAction(storeId) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const data = s.exclusiveData || defaultExclusiveData();
              const nextId =
                data.acciones && data.acciones.length
                  ? Math.max(...data.acciones.map((a) => a.id || 0)) + 1
                  : 1;
              const nueva = {
                id: nextId,
                tipo: "",
                fecha: "",
                derivaciones: "",
              };
              return {
                ...s,
                exclusiveData: {
                  ...data,
                  acciones: [...data.acciones, nueva],
                },
              };
            })
          );
        }

        function updateExclusiveAction(storeId, actionId, field, value) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const data = s.exclusiveData || defaultExclusiveData();
              return {
                ...s,
                exclusiveData: {
                  ...data,
                  acciones: data.acciones.map((a) =>
                    a.id === actionId ? { ...a, [field]: value } : a
                  ),
                },
              };
            })
          );
        }

        function removeExclusiveAction(storeId, actionId) {
          setStores((prev) =>
            prev.map((s) => {
              if (s.id !== storeId) return s;
              const data = s.exclusiveData || defaultExclusiveData();
              return {
                ...s,
                exclusiveData: {
                  ...data,
                  acciones: data.acciones.filter((a) => a.id !== actionId),
                },
              };
            })
          );
        }

        // -------- utilidades Cuadro de mando (PDF / imprimir) --------
        function printDashboard() {
          if (typeof window !== "undefined") {
            window.print(); // el usuario puede elegir impresora o "Guardar como PDF"
          }
        }

        // ============================================================
        // RENDER
        // ============================================================

        return (
          <div className="min-h-screen bg-gray-100 font-sans">
            {!authorized ? (
              <div className="flex items-center justify-center h-screen">
                <div className="bg-white p-10 rounded-2xl shadow-xl w-80">
                  <h2 className="text-xl font-bold text-center mb-4">
                    Acceso Plataforma
                  </h2>
                  <input
                    type="password"
                    className="w-full p-2 border rounded mb-4"
                    placeholder="Introduce PIN"
                    value={pin}
                    onChange={(e) => setPin(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === "Enter") handlePin();
                    }}
                  />
                  <button
                    onClick={handlePin}
                    className="w-full bg-blue-600 text-white py-2 rounded-xl shadow"
                  >
                    Entrar
                  </button>
                </div>
              </div>
            ) : (
              <div className="p-6">
                {/* HEADER PRINCIPAL */}
                <header className="bg-red-600 text-white p-5 rounded-2xl shadow flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="text-3xl">üéß</span>
                    <h1 className="text-2xl font-bold">
                      Seguimiento de procesos de Audio
                    </h1>
                  </div>
                  <div className="flex flex-col items-end gap-1">
                    <div className="flex gap-2">
                      <button
                        onClick={saveToCloud}
                        className="bg-white text-red-600 px-3 py-1 rounded-xl shadow text-xs font-semibold"
                      >
                        Guardar en nube
                      </button>
                      <button
                        onClick={loadFromCloud}
                        className="bg-red-500 text-white px-3 py-1 rounded-xl shadow text-xs font-semibold border border-white/40"
                      >
                        Actualizar desde nube
                      </button>
                    </div>
                    <p className="text-[10px] text-white/80">
                      √öltima actualizaci√≥n:{" "}
                      <span className="font-semibold">
                        {formatFechaHora(lastSavedAt)}
                      </span>
                    </p>
                  </div>
                </header>

                {/* =================== PANEL 1: DEPARTAMENTO + CUADRO DE MANDO =================== */}
                <section className="mt-6 space-y-6">
                  {/* Fald√≥n rojo Departamento Audiolog√≠a */}
                  <div className="bg-red-600 text-white p-5 rounded-2xl shadow flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div>
                      <p className="text-xs tracking-[0.12em] uppercase opacity-90">
                        Departamento
                      </p>
                      <h2 className="text-xl md:text-2xl font-bold">
                        AUDIOLOG√çA
                      </h2>
                    </div>
                    <div className="text-[11px] md:text-xs">
                      <p>
                        <span className="font-semibold">
                          Director:
                        </span>{" "}
                        David L√≥pez
                      </p>
                      <p>
                        <span className="font-semibold">
                          Responsable t√©cnica:
                        </span>{" "}
                        Ariannys Rojas
                      </p>
                      <p>
                        <span className="font-semibold">
                          Delegada de procesos:
                        </span>{" "}
                        Sonia
                      </p>
                    </div>
                  </div>

                  {/* Cuadro de mando */}
                  <div className="bg-white p-5 rounded-2xl shadow space-y-6">
                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3 border-b pb-3">
                      <div>
                        <h3 className="font-bold text-sm md:text-base">
                          Cuadro de mando
                        </h3>
                        <p className="text-[11px] text-gray-500">
                          Visi√≥n global de la aplicaci√≥n de procesos y
                          estado de la red de centros de audio.
                        </p>
                      </div>
                      <div className="flex flex-wrap gap-2 justify-end">
                        <button
                          className="text-[10px] px-3 py-1 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-50 cursor-pointer"
                          onClick={saveToCloud}
                        >
                          üíæ Guardar local
                        </button>
                        <button
                          className="text-[10px] px-3 py-1 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-50 cursor-pointer"
                          onClick={printDashboard}
                        >
                          üìÑ PDF
                        </button>
                        <button
                          className="text-[10px] px-3 py-1 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-50 cursor-pointer"
                          onClick={printDashboard}
                        >
                          üñ® Imprimir
                        </button>
                      </div>
                    </div>

                    {/* 1 y 2. Gr√°ficas de procesos */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      <ChecklistBarChart3D
                        title="1. % aplicaci√≥n de procesos ‚Äì Centros AAO"
                        stats={pointStatsAAO}
                        showTable={showTableAAO}
                        onToggleTable={() =>
                          setShowTableAAO((prev) => !prev)
                        }
                      />
                      <ChecklistBarChart3D
                        title="2. % aplicaci√≥n de procesos ‚Äì Centros exclusivos"
                        stats={pointStatsExclusive}
                        showTable={showTableExclusive}
                        onToggleTable={() =>
                          setShowTableExclusive((prev) => !prev)
                        }
                      />
                    </div>

                    {/* Donuts 3D */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                      <KpiDonut3D
                        label="Checklist medio centros AAO"
                        percent={checklistMediaAAO}
                      />
                      <KpiDonut3D
                        label="Checklist medio centros exclusivos"
                        percent={checklistMediaExclusive}
                      />
                      <KpiDonut3D
                        label="Aplicaci√≥n HIT (visitas)"
                        percent={hitAplicacionGlobal}
                      />
                      <KpiDonut3D
                        label="% centros AAR activos"
                        percent={pctCentrosAAR}
                      />
                    </div>

                    {/* Texto KPIs */}
                    <div className="mt-1 text-[11px] text-gray-600 flex flex-wrap gap-3">
                      <span>
                        Centros totales:{" "}
                        <strong>{totalTiendas}</strong>
                      </span>
                      <span>
                        Centros con al menos 1 checklist:{" "}
                        <strong>
                          {tiendasConVisita} (
                          {porcentajeTiendasVisitadas.toFixed(0)}%)
                        </strong>
                      </span>
                      <span>
                        Total visitas con Excel:{" "}
                        <strong>{totalVisitas}</strong>
                      </span>
                    </div>

                    {algunFechaInvalida && (
                      <p className="text-[11px] text-red-500">
                        Hay fechas con formato incorrecto. Usa siempre
                        el formato <strong>dd/mm/aaaa</strong>.
                      </p>
                    )}
                  </div>
                </section>

                {/* =================== LISTADO DE CENTROS =================== */}
                <!-- (RESTO DEL C√ìDIGO: LISTADO DE CENTROS Y CENTROS EXCLUSIVOS
                     SE MANTIENE EXACTAMENTE IGUAL QUE EN TU SCRIPT ANTERIOR) -->
                <!-- ... AQU√ç PEGAR√çAS SIN CAMBIOS TODO EL BLOQUE DE LISTADO DE CENTROS
                     Y EL BLOQUE DE CENTROS EXCLUSIVOS TAL Y COMO YA LOS TEN√çAS ... -->

              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
