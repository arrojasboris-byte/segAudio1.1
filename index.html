<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control Center Audio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-body: radial-gradient(circle at top left, #111827, #020617 55%);
      --bg-card: #020617;
      --bg-card-soft: #0b1120;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --accent-red: #ff2440;
      --accent-blue: #38bdf8;
      --accent-green: #22c55e;
      --accent-orange: #f97316;
      --accent-yellow: #eab308;
      --radius-lg: 14px;
    }

    body.light {
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --bg-card-soft: #e5e7eb;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --border-soft: #d1d5db;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      background: var(--bg-body);
      color: var(--text-main);
      display: flex;
    }

    /* SIDEBAR, siempre oscura */
    .sidebar {
      width: 250px;
      background: #020617;
      border-right: 1px solid #020617;
      padding: 18px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      color: #e5e7eb;
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, var(--accent-red));
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: #9ca3af;
    }

    .section-title {
      font-size: .75rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .12em;
      margin-bottom: 8px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .88rem;
      color: #9ca3af;
      cursor: pointer;
      transition: all .18s ease;
    }

    .nav-item span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
    }

    .nav-item.active {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      color: #111827;
      font-weight: 600;
    }

    .nav-item.active span.icon {
      background: rgba(15,23,42,.2);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: #9ca3af;
    }

    /* MAIN */
    .main {
      flex: 1;
      padding: 10px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 100vh;
      overflow: hidden;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .search-wrapper {
      position: relative;
      flex: 1;
      max-width: 620px;
    }

    .search-input {
      width: 100%;
      background: var(--bg-card);
      border-radius: 999px;
      padding: 8px 12px 8px 30px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      font-size: .86rem;
      outline: none;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-wrapper .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: .8rem;
      color: var(--text-muted);
    }

    .toolbar-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-card);
      color: var(--text-main);
      white-space: nowrap;
      box-shadow: none;
    }

    .btn-cta-red {
      background: linear-gradient(90deg, #ff2440, #fb7185);
      border-color: transparent;
      color: #111827;
      font-weight: 600;
    }

    .btn-cta-blue {
      background: linear-gradient(90deg, #38bdf8, #0ea5e9);
      border-color: transparent;
      color: #0f172a;
      font-weight: 600;
    }

    .btn-cta-green {
      background: linear-gradient(90deg, #22c55e, #16a34a);
      border-color: transparent;
      color: #052e16;
      font-weight: 600;
    }

    .btn-ghost {
      background: transparent;
    }

    .btn span.icon {
      font-size: .85rem;
    }

    /* VISTAS */
    .view {
      flex: 1;
      display: none;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }
    .view.active { display:flex; }

    /* Dashboard con scroll propio para evitar desbordes */
    #view-dashboard {
      overflow: auto;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 10px;
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .section-title-main {
      font-size: .95rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    /* DASHBOARD */
    .dashboard-top {
      display:grid;
      grid-template-columns: repeat(4,minmax(0,1fr));
      gap:8px;
    }

    .kpi-card {
      padding:6px 8px;
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      border:1px solid var(--border-soft);
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .kpi-label {font-size:.75rem;color:var(--text-muted);}
    .kpi-value {font-size:1.1rem;font-weight:700;}
    .kpi-sub {font-size:.7rem;color:var(--text-muted);}

    .dashboard-bottom {
      display:grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap:8px;
      min-height:0;
    }

    .chart-container {
      position:relative;
      width:100%;
      height:150px; /* m√°s compacto para que todo quepa */
    }

    /* CENTROS */
    .view-row {
      display:grid;
      grid-template-columns: minmax(0,1.15fr) minmax(0,1.4fr) minmax(0,1.1fr);
      gap:8px;
      min-height:220px;
    }

    .delegados-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }

    .badge-count {
      font-size:.7rem;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:var(--bg-card-soft);
      color:var(--text-muted);
    }

    .delegados-list {
      display:flex;
      flex-direction:column;
      gap:4px;
      overflow-y:auto;
      max-height:210px;
      padding-right:2px;
    }

    .delegado-row {
      border-radius:10px;
      padding:4px 8px 4px 6px;
      background:var(--bg-card-soft);
      display:flex;
      flex-direction:column;
      gap:3px;
      cursor:pointer;
      border:1px solid transparent;
    }
    .delegado-row.active {border-color:var(--accent-blue);}

    .delegado-main {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.78rem;
    }

    .delegado-name {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .delegado-dot {
      width:8px;
      height:8px;
      border-radius:999px;
    }
    .delegado-centros {font-size:.7rem;color:var(--text-muted);}

    .delegado-bar {
      height:3px;
      border-radius:999px;
      background:rgba(148,163,184,.4);
      overflow:hidden;
    }
    .delegado-bar-inner {
      height:100%;
      width:100%;
    }

    .delegados-actions {
      display:flex;
      gap:6px;
      margin-top:6px;
    }

    /* CALENDARIO */
    .calendar-card {align-items:stretch;}
    .calendar-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .calendar-title {
      font-size:1.05rem;
      font-weight:700;
    }
    .calendar-nav {display:flex;gap:6px;}
    .calendar-nav-btn {
      width:26px;height:26px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:transparent;
      color:var(--text-main);
      font-size:.8rem;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .calendar-weekdays {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      font-size:.72rem;
      color:var(--text-muted);
      margin-bottom:4px;
      text-align:center;
    }
    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:5px;
      grid-auto-rows:58px;
    }
    .calendar-day {
      border-radius:14px;
      border:1px solid var(--border-soft);
      padding:4px 5px;
      font-size:.78rem;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      cursor:pointer;
    }
    .calendar-day.empty {
      background:transparent;
      border-style:dashed;
      cursor:default;
    }
    .calendar-day-number {align-self:flex-start;}
    .calendar-day-badge {
      display:flex;
      align-items:center;
      gap:4px;
      font-size:.7rem;
    }
    .calendar-dot {
      width:6px;height:6px;border-radius:999px;background:var(--accent-yellow);
    }
    .calendar-resp {font-weight:600;}

    /* VISITAS */
    .visitas-list {
      display:flex;
      flex-direction:column;
      gap:4px;
      overflow-y:auto;
      max-height:210px;
      padding-right:2px;
    }
    .visita-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      border-radius:10px;
      padding:4px 6px;
      background:var(--bg-card-soft);
      font-size:.75rem;
    }
    .visita-main {display:flex;flex-direction:column;gap:2px;min-width:0;}
    .visita-top {display:flex;gap:6px;align-items:center;white-space:nowrap;}
    .visita-centro {
      font-weight:500;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:220px;
    }
    .visita-meta {display:flex;gap:6px;color:var(--text-muted);font-size:.7rem;flex-wrap:wrap;}
    .visita-actions {display:flex;gap:4px;flex-wrap:nowrap;}

    .chip {
      border-radius:999px;
      padding:2px 6px;
      font-size:.7rem;
      border:1px solid var(--border-soft);
      background:#0b1120;
      white-space:nowrap;
    }
    .chip-pendiente {background:rgba(234,179,8,.14);border-color:rgba(234,179,8,.7);color:#eab308;}
    .chip-sininforme {background:rgba(148,163,184,.18);border-color:rgba(148,163,184,.7);color:var(--text-muted);}
    .chip-estado-proceso {background:rgba(34,197,94,.2);border-color:rgba(34,197,94,.8);color:#16a34a;}
    .chip-estado-finalizado {background:rgba(22,163,74,1);border-color:rgba(22,163,74,1);color:#ecfdf3;}
    .chip-estado-anulada {background:rgba(248,113,113,.25);border-color:rgba(248,113,113,.9);color:#fecaca;}

    .btn-mini {border-radius:999px;padding:2px 6px;font-size:.7rem;border-width:1px;}

    /* TABLA CENTROS */
    .table-wrapper {
      flex:1;
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      border:1px solid var(--border-soft);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .table-header {
      padding:8px 10px 6px;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
    }
    .table-header h3 {font-size:.9rem;}
    .table-header span {font-size:.72rem;color:var(--text-muted);}
    .table-scroll {flex:1;overflow:auto;border-top:1px solid var(--border-soft);}
    table {width:100%;border-collapse:collapse;font-size:.78rem;}
    thead {position:sticky;top:0;background:var(--bg-card);z-index:2;}
    th,td {padding:6px 8px;border-bottom:1px solid #0b1120;text-align:left;white-space:nowrap;}
    th {font-weight:600;font-size:.75rem;color:var(--text-muted);}
    tbody tr:nth-child(even){background:#020617;}
    body.light tbody tr:nth-child(even){background:#f3f4f6;}
    tbody tr:hover{background:rgba(15,23,42,0.9);}
    body.light tbody tr:hover{background:#e5e7eb;}

    .tag {
      border-radius:999px;
      padding:2px 6px;
      font-size:.7rem;
      border:1px solid var(--border-soft);
      background:#0b1120;
      white-space:nowrap;
    }
    .tag.exclusivo {background:rgba(22,163,74,0.15);color:var(--accent-green);border-color:rgba(22,163,74,0.7);}
    .tag.corner {background:rgba(37,99,235,0.15);color:var(--accent-blue);border-color:rgba(37,99,235,0.7);}
    .tag-aar {background:rgba(148,163,184,0.15);border-color:rgba(148,163,184,0.7);color:var(--text-muted);}
    .tag-aar.si {background:rgba(34,197,94,0.15);border-color:rgba(34,197,94,0.7);color:var(--accent-green);}
    .tag-aar.formacion {background:rgba(234,179,8,0.15);border-color:rgba(234,179,8,0.7);color:#eab308;}

    .btn-link {border:none;background:transparent;color:var(--accent-blue);cursor:pointer;font-size:.74rem;text-decoration:underline;}

    .table-footer {padding:4px 10px 6px;font-size:.72rem;color:var(--text-muted);text-align:right;}

    /* MODALES */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal {
      background:var(--bg-card);
      border-radius:14px;
      padding:14px;
      width:440px;
      max-width:95%;
      border:1px solid var(--border-soft);
    }
    .modal-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .modal-header h3 {font-size:.95rem;}
    .modal-close {cursor:pointer;font-size:1rem;color:var(--text-muted);}
    .modal-body {display:flex;flex-direction:column;gap:8px;font-size:.78rem;}
    .modal-field {display:flex;flex-direction:column;gap:2px;}
    .modal-field label {font-size:.74rem;color:var(--text-muted);}
    .modal-field input,
    .modal-field select,
    .modal-field textarea {
      padding:5px 7px;
      border-radius:8px;
      border:1px solid var(--border-soft);
      background:var(--bg-card-soft);
      color:var(--text-main);
      font-size:.78rem;
      outline:none;
    }
    .modal-footer {display:flex;justify-content:flex-end;gap:8px;margin-top:10px;}

    /* INFORME VISITA */
    .informe-top {
      display:grid;
      grid-template-columns:minmax(0,1.4fr) minmax(0,1.6fr);
      gap:8px;
      margin-bottom:8px;
    }
    .info-table {width:100%;border-collapse:collapse;font-size:.78rem;}
    .info-table td {padding:4px 6px;border-bottom:1px solid var(--border-soft);}
    .info-label {color:var(--text-muted);width:32%;white-space:nowrap;}

    .small-input-row {display:flex;gap:6px;margin-top:6px;align-items:center;flex-wrap:wrap;}
    .small-input-row .modal-field {flex:1;}

    .informe-layout {
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.9fr);
      gap:8px;
      min-height:0;
    }

    .checklist-column {
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.78rem;
      max-height:260px;
      overflow-y:auto;
      padding-right:4px;
    }
    .check-item {display:flex;align-items:center;gap:6px;}
    .check-item input{width:14px;height:14px;}

    .chart-column {
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:0;
    }
    .chart-card {flex:1;min-height:120px;}

    .imagenes-row {display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;}
    .imagen-slot {align-items:center;justify-content:center;gap:6px;text-align:center;font-size:.78rem;}
    .imagen-slot input{font-size:.7rem;}

    .triple-observaciones {display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:8px;}
    .observ-card textarea{min-height:80px;resize:vertical;}

    .informe-footer-actions {margin-top:6px;display:flex;justify-content:flex-end;}

    .informe-header-actions {display:flex;gap:6px;align-items:center;}

    @media (max-width:1100px){
      .dashboard-top {grid-template-columns:repeat(2,minmax(0,1fr));}
      .dashboard-bottom {grid-template-columns:1fr;}
      .view-row {grid-template-columns:1.3fr 1.3fr;grid-auto-rows:auto;grid-template-rows:auto auto;}
      .view-row> :last-child {grid-column:1 / -1;}
      .informe-top {grid-template-columns:1fr;}
      .informe-layout {grid-template-columns:1fr;}
      .imagenes-row,.triple-observaciones{grid-template-columns:1fr;}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-badge"></div>
      <div class="logo-text">
        <span class="logo-title">Control Center Audio</span>
        <span class="logo-subtitle">Gesti√≥n de centros y delegados</span>
      </div>
    </div>

    <div>
      <div class="section-title">Secciones</div>
      <nav class="nav-list">
        <div class="nav-item active" data-view-target="view-dashboard">
          <span class="icon">üè†</span> Dashboard
        </div>
        <div class="nav-item" data-view-target="view-centros">
          <span class="icon">üè¢</span> Centros
        </div>
        <div class="nav-item" data-view-target="view-informe">
          <span class="icon">üìã</span> Informe de la visita
        </div>
        <div class="nav-item">
          <span class="icon">üõ†</span> Servicios
        </div>
        <div class="nav-item">
          <span class="icon">üí≥</span> Ventas
        </div>
        <div class="nav-item">
          <span class="icon">üìä</span> Proyectos
        </div>
      </nav>
    </div>

    <div class="sidebar-footer">
      Versi√≥n demo ¬∑ Datos ficticios
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="search-wrapper">
        <span class="search-icon">üîç</span>
        <input id="buscadorGlobal" class="search-input" placeholder="Buscar por centro, propietario o delegado..." />
      </div>
      <div class="toolbar-buttons">
        <button class="btn" id="themeToggle">
          <span class="icon">üåì</span> Oscuro / Claro
        </button>
        <button class="btn btn-ghost" id="btnGuardarVista">
          <span class="icon">üíæ</span> Guardar vista
        </button>
        <button class="btn btn-cta-blue" id="btnExportHtml">
          <span class="icon">‚¨áÔ∏è</span> Exportar HTML
        </button>
        <button class="btn btn-ghost" id="btnImprimir">
          <span class="icon">üñ®</span> Imprimir
        </button>
        <button class="btn btn-cta-red">
          <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
        </button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section class="view active" id="view-dashboard">
      <section class="dashboard-top">
        <article class="kpi-card">
          <div class="kpi-label">Total centros</div>
          <div class="kpi-value" id="kpiTotalCentros">0</div>
          <div class="kpi-sub">Centros activos</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-label">Exclusivos</div>
          <div class="kpi-value" id="kpiExclusivo">0</div>
          <div class="kpi-sub">Centros exclusivos</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-label">Corner</div>
          <div class="kpi-value" id="kpiCorner">0</div>
          <div class="kpi-sub">Centros corner</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-label">Visitas mes</div>
          <div class="kpi-value" id="kpiVisitasMes">0</div>
          <div class="kpi-sub">Agendadas este mes</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-label">Pendientes</div>
          <div class="kpi-value" id="kpiVisitasPend">0</div>
          <div class="kpi-sub">Sin realizar</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-label">Cobertura AAR</div>
          <div class="kpi-value" id="kpiAAR">0%</div>
          <div class="kpi-sub" id="kpiAARDetalle"></div>
        </article>
        <article class="kpi-card">
          <div class="kpi-label">Checklist formaciones</div>
          <div class="kpi-value" id="kpiChecklist">0%</div>
          <div class="kpi-sub">Centros con checklist adjunto</div>
        </article>
      </section>

      <section class="dashboard-bottom">
        <article class="card">
          <span class="section-title-main" style="margin-bottom:4px;">KPIs globales</span>
          <div class="chart-container"><canvas id="chartDashRadar"></canvas></div>
        </article>
        <article class="card">
          <span class="section-title-main" style="margin-bottom:4px;">Estado de visitas</span>
          <div class="chart-container"><canvas id="chartDashEstados"></canvas></div>
        </article>
        <article class="card">
          <span class="section-title-main" style="margin-bottom:4px;">Centros AAR</span>
          <div class="chart-container"><canvas id="chartDashAAR"></canvas></div>
        </article>
        <article class="card">
          <span class="section-title-main" style="margin-bottom:4px;">Ranking de delegados</span>
          <div class="chart-container"><canvas id="chartDashRanking"></canvas></div>
        </article>
      </section>
    </section>

    <!-- CENTROS -->
    <section class="view" id="view-centros">
      <section class="view-row">
        <!-- Delegados -->
        <article class="card">
          <div class="delegados-header">
            <span class="section-title-main">Centros y delegados</span>
            <span class="badge-count" id="delegadosCount"></span>
          </div>
          <div id="delegadosList" class="delegados-list"></div>
          <div class="delegados-actions">
            <button class="btn btn-cta-red" id="btnAddCentro">
              <span class="icon">‚ûï</span> A√±adir centro
            </button>
            <button class="btn" id="btnAdjuntarExcel">
              <span class="icon">üì§</span> Adjuntar centros (Excel)
            </button>
            <input type="file" id="inputExcel" accept=".xlsx,.xls" style="display:none" />
          </div>
        </article>

        <!-- Calendario -->
        <article class="card calendar-card">
          <div class="calendar-header">
            <div class="calendar-nav">
              <button class="calendar-nav-btn" id="calPrev">&lt;</button>
            </div>
            <div class="calendar-title" id="calendarTitle">Diciembre 2025</div>
            <div class="calendar-nav">
              <button class="calendar-nav-btn" id="calNext">&gt;</button>
            </div>
          </div>
          <div class="calendar-weekdays">
            <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
        </article>

        <!-- Visitas -->
        <article class="card">
          <div class="delegados-header">
            <span class="section-title-main">Visitas agendadas</span>
            <div class="informe-header-actions">
              <button class="btn btn-mini" id="btnPrintVisitas">üñ®</button>
              <button class="btn btn-mini" id="btnSaveVisitas">üíæ</button>
            </div>
          </div>
          <div id="visitasList" class="visitas-list"></div>
        </article>
      </section>

      <!-- Tabla centros -->
      <section class="table-wrapper">
        <div class="table-header">
          <div><h3>Listado de centros</h3></div>
          <span id="centrosCounter"></span>
        </div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Propietario</th>
                <th>Centro</th>
                <th>Provincia</th>
                <th>Delegado</th>
                <th>Tipo</th>
                <th>Informes</th>
                <th>Centro AAR</th>
              </tr>
            </thead>
            <tbody id="tablaCentrosBody"></tbody>
          </table>
        </div>
        <div class="table-footer" id="tableFooter"></div>
      </section>
    </section>

    <!-- INFORME VISITA -->
    <section class="view" id="view-informe">
      <div class="delegados-header">
        <span class="section-title-main">Informe de la visita</span>
        <div class="informe-header-actions">
          <button class="btn btn-mini" id="btnPrintInforme">üñ®</button>
          <button class="btn btn-mini" id="btnGuardarInforme">üíæ</button>
        </div>
      </div>

      <section class="informe-top">
        <!-- Info centro -->
        <article class="card">
          <table class="info-table">
            <tbody>
              <tr><td class="info-label">Centro</td><td id="infCentro">-</td></tr>
              <tr><td class="info-label">Provincia</td><td id="infProvincia">-</td></tr>
              <tr><td class="info-label">Delegado</td><td id="infDelegado">-</td></tr>
              <tr><td class="info-label">Tipo</td><td id="infTipo">-</td></tr>
              <tr><td class="info-label">Responsable audio</td><td id="infRespAudio">-</td></tr>
              <tr><td class="info-label">Fecha visita</td><td id="infFecha">-</td></tr>
            </tbody>
          </table>

          <div class="small-input-row">
            <div class="modal-field">
              <label>Audi√≥logo</label>
              <input id="infAudiologo" />
            </div>
            <div class="modal-field">
              <label>Horas de servicio</label>
              <input id="infHoras" type="number" min="0" step="0.5" />
            </div>
          </div>

          <div style="margin-top:6px;">
            <button class="btn btn-cta-green" id="btnAdjuntarChecklist">
              <span class="icon">‚úÖ</span> Adjuntar checklist
            </button>
            <span id="checklistEstado" style="font-size:.75rem; margin-left:6px; color:var(--text-muted);"></span>
          </div>
        </article>

        <!-- Checklist + gr√°ficas -->
        <article class="card">
          <div class="informe-layout">
            <div class="checklist-column">
              <div class="check-item"><input type="checkbox" id="chkFormaciones" /> <label for="chkFormaciones">Formaciones y habilidades</label></div>
              <div class="check-item"><input type="checkbox" id="chkWSA" /> <label for="chkWSA">WSA</label></div>
              <div class="check-item"><input type="checkbox" id="chkStarkey" /> <label for="chkStarkey">Starkey</label></div>
              <div class="check-item"><input type="checkbox" id="chkHVentas" /> <label for="chkHVentas">Habilidades comerciales / Neuroventas</label></div>
              <div class="check-item"><input type="checkbox" id="chkHIT" /> <label for="chkHIT">HIT</label></div>
              <div class="check-item"><input type="checkbox" id="chkTelecare" /> <label for="chkTelecare">Telecare</label></div>
              <div class="check-item"><input type="checkbox" id="chkPIA" /> <label for="chkPIA">PIA</label></div>
              <div class="check-item"><input type="checkbox" id="chkTelehear" /> <label for="chkTelehear">Telehear</label></div>
              <div class="check-item"><input type="checkbox" id="chkFinanciacion" /> <label for="chkFinanciacion">Financiaci√≥n Infinity</label></div>
              <div class="check-item"><input type="checkbox" id="chkSeguro" /> <label for="chkSeguro">Venta de seguro</label></div>
              <div class="check-item"><input type="checkbox" id="chkPrimerosAux" /> <label for="chkPrimerosAux">Primeros auxilios (equipo)</label></div>
              <div class="check-item"><input type="checkbox" id="chkImplPV" /> <label for="chkImplPV">Implementaci√≥n en punto de venta</label></div>
              <div class="check-item"><input type="checkbox" id="chkAudioRT" /> <label for="chkAudioRT">Audiometr√≠a RT</label></div>
              <div class="check-item"><input type="checkbox" id="chkTestLectura" /> <label for="chkTestLectura">Test de lectura audio</label></div>
              <div class="check-item"><input type="checkbox" id="chkScreening" /> <label for="chkScreening">Screening audio</label></div>
              <div class="check-item"><input type="checkbox" id="chkManteleta" /> <label for="chkManteleta">Manteleta audio</label></div>
              <div class="check-item"><input type="checkbox" id="chkEscaparate" /> <label for="chkEscaparate">Escaparate visible audio</label></div>
              <div class="check-item"><input type="checkbox" id="chkSaludPDV" /> <label for="chkSaludPDV">Salud auditiva en PDV</label></div>
              <div class="check-item"><input type="checkbox" id="chkRenove" /> <label for="chkRenove">Elementos Renove</label></div>
              <div class="check-item"><input type="checkbox" id="chkMGM" /> <label for="chkMGM">Elementos MGM</label></div>
              <div class="check-item"><input type="checkbox" id="chkStock" /> <label for="chkStock">Stock</label></div>
              <div class="check-item"><input type="checkbox" id="chkTchin" /> <label for="chkTchin">Tchin Tchin</label></div>
            </div>

            <div class="chart-column">
              <div class="card chart-card">
                <span class="section-title-main" style="margin-bottom:4px;">KPIs del centro</span>
                <div class="chart-container">
                  <canvas id="chartInformeRadar"></canvas>
                </div>
              </div>
              <div class="card chart-card">
                <span class="section-title-main" style="margin-bottom:4px;">Estado de visitas</span>
                <div class="chart-container">
                  <canvas id="chartInformeEstados"></canvas>
                </div>
              </div>
              <div class="card chart-card" id="cardInformeAAR">
                <span class="section-title-main" style="margin-bottom:4px;">AAR / Procesos</span>
                <div class="chart-container">
                  <canvas id="chartInformeDonut"></canvas>
                </div>
              </div>
            </div>
          </div>
        </article>
      </section>

      <section class="card" style="margin-top:6px;">
        <div class="imagenes-row">
          <div class="card imagen-slot">
            <strong>Centro exterior</strong>
            <input type="file" accept="image/*" />
          </div>
          <div class="card imagen-slot">
            <strong>Centro interior</strong>
            <input type="file" accept="image/*" />
          </div>
          <div class="card imagen-slot">
            <strong>Gabinete</strong>
            <input type="file" accept="image/*" />
          </div>
        </div>

        <div class="triple-observaciones">
          <div class="card observ-card">
            <strong style="font-size:.85rem;margin-bottom:4px;">Observaciones</strong>
            <textarea id="infObservaciones"></textarea>
          </div>
          <div class="card observ-card">
            <strong style="font-size:.85rem;margin-bottom:4px;">Recomendaciones</strong>
            <textarea id="infRecomendaciones"></textarea>
          </div>
          <div class="card observ-card">
            <strong style="font-size:.85rem;margin-bottom:4px;">Compromisos</strong>
            <textarea id="infCompromisos"></textarea>
          </div>
        </div>

        <div class="informe-footer-actions">
          <button class="btn btn-cta-green" id="btnGuardarInformeBottom">
            <span class="icon">üíæ</span> Guardar informe
          </button>
        </div>
      </section>
    </section>
  </main>

  <!-- MODALES (centro, visita, informes) -->
  <div class="modal-backdrop" id="modalCentro">
    <div class="modal">
      <div class="modal-header">
        <h3>Nuevo centro</h3>
        <span class="modal-close" data-close="modalCentro">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field"><label>C√≥digo</label><input id="nuevoCodigo" /></div>
        <div class="modal-field"><label>Propietario</label><input id="nuevoPropietario" /></div>
        <div class="modal-field"><label>Centro</label><input id="nuevoCentro" /></div>
        <div class="modal-field"><label>Provincia</label><input id="nuevoProvincia" /></div>
        <div class="modal-field">
          <label>Delegado</label>
          <select id="nuevoDelegado"></select>
        </div>
        <div class="modal-field">
          <label>Tipo</label>
          <select id="nuevoTipo">
            <option value="Corner">Corner</option>
            <option value="Exclusivo">Exclusivo</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalCentro">Cancelar</button>
        <button class="btn btn-cta-red" id="guardarCentro">Guardar centro</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalVisita">
    <div class="modal">
      <div class="modal-header">
        <h3>Agendar visita</h3>
        <span class="modal-close" data-close="modalVisita">‚úï</span>
      </div>
      <div class="modal-body">
        <div class="modal-field"><label>Fecha</label><input id="visFecha" readonly /></div>
        <div class="modal-field">
          <label>Centro</label>
          <select id="visCentro"></select>
        </div>
        <div class="modal-field">
          <label>Responsable de audio</label>
          <select id="visRespAudio">
            <option value="Ariannys Rojas">Ariannys Rojas</option>
            <option value="Sonia Guasque">Sonia Guasque</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" data-close="modalVisita">Cancelar</button>
        <button class="btn btn-cta-green" id="guardarVisita">Guardar visita</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="modalInformesCentro">
    <div class="modal">
      <div class="modal-header">
        <h3>Informes del centro</h3>
        <span class="modal-close" data-close="modalInformesCentro">‚úï</span>
      </div>
      <div class="modal-body" id="informesCentroBody"></div>
      <div class="modal-footer">
        <button class="btn" data-close="modalInformesCentro">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');

    function aplicarTemaDesdeStorage(){
      const saved = localStorage.getItem('cca_theme');
      if(saved==='light') body.classList.add('light');
    }
    aplicarTemaDesdeStorage();

    themeToggle.addEventListener('click',()=>{
      body.classList.toggle('light');
      localStorage.setItem('cca_theme', body.classList.contains('light')?'light':'dark');
    });

    // NAV
    document.querySelectorAll('.nav-item[data-view-target]').forEach(nav=>{
      nav.addEventListener('click',()=>{
        const target=nav.dataset.viewTarget;
        document.querySelectorAll('.nav-item[data-view-target]').forEach(n=>n.classList.remove('active'));
        nav.classList.add('active');
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(target).classList.add('active');
      });
    });

    // Datos
    const delegadosColores = {
      "ENERITZ ARANGUREN":"#22c55e",
      "LAURA PLAZAS":"#2563eb",
      "LAURA RAMOS":"#14b8a6",
      "Daniel Chazo":"#a855f7",
      "Manuel C√°novas":"#f97316",
      "Cecilia P√©rez":"#0ea5e9",
      "Martin SEBASTI√ÅN":"#ef4444",
      "Marisa Carmona":"#eab308",
      "Blanca Fdez. de la Pradilla":"#ec4899",
      "Maribel Amezcua":"#facc15",
      "Sonia Godino":"#22d3ee",
      "Ver√≥nica Alfons√≠n":"#4ade80",
      "Sergio Per√°n":"#fb7185"
    };

    const centros = [];
    const exclusivosNombres = new Set([
      "CC LOS VALLES",
      "FUENLABRADA Calle Leganes",
      "PAMPLONA C. Exclusivo",
      "PAMPLONA Calle Sancho el Mayor",
      "PAMPLONA Carlos III",
      "REINA DE MERCEDES",
      "SANTANDER CC PE√ëACASTILLO",
      "SANTIAGO DE COMPOSTELA RUA DA ROSA",
      "TORRELAVEGA CARREFOUR CC",
      "ZARAGOZA CALLE DELICIAS"
    ]);
    const informesPorCentro = {};
    const aarPorCentro = {};

    let filtroDelegadoActual = null;
    let filtroTextoActual = "";
    let visitas = [];
    let nextVisitaId = 1;
    let visitaEnEdicion = null;

    function tipoCentro(nombreCentro){return exclusivosNombres.has(nombreCentro)?"Exclusivo":"Corner";}
    function getAarEstado(nombreCentro){return aarPorCentro[nombreCentro]||"No";}
    function getInformesCentro(nombreCentro){return informesPorCentro[nombreCentro]||[];}

    // Tabla centros
    const tablaBody = document.getElementById('tablaCentrosBody');
    const centrosCounter = document.getElementById('centrosCounter');
    const tableFooter = document.getElementById('tableFooter');

    function renderTablaCentros(){
      const texto = filtroTextoActual.toLowerCase();
      tablaBody.innerHTML="";
      const filtrados = centros.filter(c=>{
        const cad=(c.centro+" "+c.propietario+" "+c.delegado).toLowerCase();
        const pasaTexto=cad.includes(texto);
        const pasaDelegado=!filtroDelegadoActual || c.delegado.toLowerCase().includes(filtroDelegadoActual.toLowerCase());
        return pasaTexto && pasaDelegado;
      });

      filtrados.forEach(c=>{
        const tr=document.createElement('tr');
        const t=tipoCentro(c.centro);
        const informes=getInformesCentro(c.centro);
        const aarEstado=getAarEstado(c.centro);

        const visitasCentro=visitas.filter(v=>v.centro===c.centro);
        const visitaPendienteInforme = visitasCentro.find(v=>v.estadoInforme!=='finalizado');
        let textoBtn;
        if(visitaPendienteInforme) textoBtn='Informe';
        else if(visitasCentro.length) textoBtn='Ver visitas';
        else textoBtn=informes.length?`Ver (${informes.length})`:"A√±adir informe";

        tr.innerHTML=`
          <td>${c.codigo}</td>
          <td>${c.propietario}</td>
          <td>${c.centro}</td>
          <td>${c.provincia}</td>
          <td>${c.delegado}</td>
          <td><span class="tag ${t==='Exclusivo'?'exclusivo':'corner'}">${t}</span></td>
          <td><button class="btn-link btn-informe-centro" data-centro="${c.centro}">${textoBtn}</button></td>
          <td><span class="tag tag-aar ${aarEstado==='S√≠'?'si':(aarEstado==='En formaci√≥n'?'formacion':'')}">${aarEstado}</span></td>
        `;
        tablaBody.appendChild(tr);
      });

      centrosCounter.textContent=`Centros: ${filtrados.length} / ${centros.length}`;
      tableFooter.textContent=`Centros mostrados: ${filtrados.length}`;
    }

    // Delegados
    const delegadosList=document.getElementById('delegadosList');
    const delegadosCount=document.getElementById('delegadosCount');

    function renderDelegados(){
      delegadosList.innerHTML="";
      const mapa=new Map();
      centros.forEach(c=>{
        if(!mapa.has(c.delegado)) mapa.set(c.delegado,[]);
        mapa.get(c.delegado).push(c);
      });
      delegadosCount.textContent=`${mapa.size} delegados`;
      Array.from(mapa.entries()).sort().forEach(([nombre,lista])=>{
        const color=delegadosColores[nombre]||'#e5e7eb';
        const row=document.createElement('div');
        row.className='delegado-row';
        if(filtroDelegadoActual===nombre) row.classList.add('active');
        row.innerHTML=`
          <div class="delegado-main">
            <div class="delegado-name">
              <span class="delegado-dot" style="background:${color}"></span>
              <span>${nombre}</span>
            </div>
            <span class="delegado-centros">${lista.length} centros</span>
          </div>
          <div class="delegado-bar"><div class="delegado-bar-inner" style="background:${color}"></div></div>
        `;
        row.addEventListener('click',()=>{
          filtroDelegadoActual = (filtroDelegadoActual===nombre)?null:nombre;
          renderDelegados();renderTablaCentros();renderVisitas();actualizarDashboardCharts();
        });
        delegadosList.appendChild(row);
      });
    }

    // Buscador
    document.getElementById('buscadorGlobal').addEventListener('input',e=>{
      filtroTextoActual=e.target.value||"";
      renderTablaCentros();
      renderVisitas();
    });

    // Modales
    function abrirModal(id){document.getElementById(id).style.display='flex';}
    function cerrarModal(id){document.getElementById(id).style.display='none';}
    document.querySelectorAll('[data-close]').forEach(el=>{
      el.addEventListener('click',()=>cerrarModal(el.dataset.close));
    });

    // Nuevo centro
    document.getElementById('btnAddCentro').addEventListener('click',()=>{
      const sel=document.getElementById('nuevoDelegado');
      sel.innerHTML="";
      const nombres=new Set([...Object.keys(delegadosColores),...centros.map(c=>c.delegado)]);
      nombres.forEach(nombre=>{
        const opt=document.createElement('option');
        opt.value=nombre;opt.textContent=nombre;sel.appendChild(opt);
      });
      abrirModal('modalCentro');
    });

    document.getElementById('guardarCentro').addEventListener('click',()=>{
      const nuevo={
        codigo:document.getElementById('nuevoCodigo').value||"NEW",
        propietario:document.getElementById('nuevoPropietario').value||"N/D",
        centro:document.getElementById('nuevoCentro').value||"Centro sin nombre",
        provincia:document.getElementById('nuevoProvincia').value||"N/D",
        delegado:document.getElementById('nuevoDelegado').value||"N/D"
      };
      const tipo=document.getElementById('nuevoTipo').value;
      if(tipo==="Exclusivo") exclusivosNombres.add(nuevo.centro);
      centros.push(nuevo);
      cerrarModal('modalCentro');
      actualizarTodo();
    });

    // Excel centros
    const inputExcel=document.getElementById('inputExcel');
    document.getElementById('btnAdjuntarExcel').addEventListener('click',()=>inputExcel.click());

    inputExcel.addEventListener('change',e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=evt=>{
        const data=new Uint8Array(evt.target.result);
        const workbook=XLSX.read(data,{type:'array'});
        const sheetName=workbook.SheetNames[0];
        const sheet=workbook.Sheets[sheetName];
        const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
        rows.slice(1).forEach(row=>{
          if(!row||row.length<5) return;
          const [codigo,propietario,centro,provincia,delegado]=row;
          if(!centro) return;
          centros.push({
            codigo:(codigo||"").toString().trim(),
            propietario:(propietario||"").toString().trim(),
            centro:(centro||"").toString().trim(),
            provincia:(provincia||"").toString().trim(),
            delegado:(delegado||"").toString().trim()
          });
        });
        actualizarTodo();
      };
      reader.readAsArrayBuffer(file);
    });

    // Calendario
    const calendarTitle=document.getElementById('calendarTitle');
    const calendarGrid=document.getElementById('calendarGrid');
    let currentMonth=new Date().getMonth();
    let currentYear=new Date().getFullYear();

    function nombreMesES(m){
      return["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][m];
    }

    function renderCalendar(){
      calendarTitle.textContent=`${nombreMesES(currentMonth)} ${currentYear}`;
      calendarGrid.innerHTML="";
      const firstDay=new Date(currentYear,currentMonth,1);
      const startingDay=(firstDay.getDay()+6)%7;
      const daysInMonth=new Date(currentYear,currentMonth+1,0).getDate();
      const totalCells=startingDay+daysInMonth;
      const rows=Math.ceil(totalCells/7);
      const cells=rows*7;

      for(let i=0;i<cells;i++){
        const dayNum=i-startingDay+1;
        const div=document.createElement('div');
        div.className='calendar-day';
        if(dayNum<1||dayNum>daysInMonth){
          div.classList.add('empty');
          calendarGrid.appendChild(div);
          continue;
        }
        div.dataset.date=new Date(currentYear,currentMonth,dayNum).toISOString().slice(0,10);
        const numSpan=document.createElement('div');
        numSpan.className='calendar-day-number';
        numSpan.textContent=dayNum;
        div.appendChild(numSpan);

        const content=document.createElement('div');
        content.className='calendar-day-badge';
        const visitasDia=visitas.filter(v=>v.fecha===div.dataset.date);
        if(visitasDia.length){
          const v=visitasDia[0];
          const dot=document.createElement('div');
          dot.className='calendar-dot';
          if(v.estado==='anulada') dot.style.background='#ef4444';
          else if(v.estado==='realizada') dot.style.background='#22c55e';
          else dot.style.background='#eab308';
          const respLetter=v.respAudio && v.respAudio.startsWith('A') ? 'A' : 'S';
          const respSpan=document.createElement('span');
          respSpan.className='calendar-resp';
          respSpan.textContent=respLetter;
          content.appendChild(respSpan);
          content.appendChild(dot);
          div.appendChild(content);
        }

        div.addEventListener('click',()=>{
          document.getElementById('visFecha').value=div.dataset.date;
          const sel=document.getElementById('visCentro');
          sel.innerHTML="";
          centros.forEach(c=>{
            const opt=document.createElement('option');
            opt.value=c.centro;opt.textContent=c.centro;sel.appendChild(opt);
          });
          abrirModal('modalVisita');
        });

        calendarGrid.appendChild(div);
      }
    }
    document.getElementById('calPrev').addEventListener('click',()=>{
      currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--;}renderCalendar();
    });
    document.getElementById('calNext').addEventListener('click',()=>{
      currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++;}renderCalendar();
    });

    // Visitas
    const visitasList=document.getElementById('visitasList');
    document.getElementById('guardarVisita').addEventListener('click',()=>{
      const fecha=document.getElementById('visFecha').value;
      const centro=document.getElementById('visCentro').value;
      const respAudio=document.getElementById('visRespAudio').value;
      const centroObj=centros.find(c=>c.centro===centro)||{};
      const visita={
        id:nextVisitaId++,
        fecha,centro,
        provincia:centroObj.provincia||"",
        delegado:centroObj.delegado||"",
        respAudio,
        estado:'pendiente',
        estadoInforme:'ninguno',
        observaciones:'',
        recomendaciones:'',
        compromisos:''
      };
      visitas.push(visita);
      cerrarModal('modalVisita');
      actualizarTodo();
    });

    function renderVisitas(){
      visitasList.innerHTML="";
      const texto=filtroTextoActual.toLowerCase();
      const filtradas=visitas.filter(v=>{
        const cad=(v.centro+" "+v.delegado+" "+v.respAudio).toLowerCase();
        const pasaTexto=cad.includes(texto);
        const pasaDelegado=!filtroDelegadoActual || (v.delegado||"").toLowerCase().includes(filtroDelegadoActual.toLowerCase());
        return pasaTexto && pasaDelegado;
      }).sort((a,b)=>a.fecha.localeCompare(b.fecha));

      filtradas.forEach(v=>{
        const row=document.createElement('div');
        row.className='visita-row';
        const main=document.createElement('div');
        main.className='visita-main';
        const top=document.createElement('div');
        top.className='visita-top';
        top.innerHTML=`<span>${v.fecha}</span><span class="visita-centro">${v.centro}</span>`;
        const meta=document.createElement('div');
        meta.className='visita-meta';
        meta.innerHTML=`<span>${v.delegado||"-"}</span><span>${v.respAudio}</span>`;
        main.appendChild(top);main.appendChild(meta);
        row.appendChild(main);

        const actions=document.createElement('div');
        actions.className='visita-actions';

        const chipEstado=document.createElement('span');
        chipEstado.className='chip';
        if(v.estado==='pendiente') chipEstado.classList.add('chip-pendiente');
        else if(v.estado==='anulada') chipEstado.classList.add('chip-estado-anulada');
        else chipEstado.classList.add('chip-estado-proceso');
        chipEstado.textContent=v.estado==='pendiente'?'Pendiente':(v.estado==='anulada'?'Anulada':'Realizada');
        actions.appendChild(chipEstado);

        const chipInf=document.createElement('span');
        chipInf.className='chip';
        if(v.estadoInforme==='ninguno') chipInf.classList.add('chip-sininforme');
        else if(v.estadoInforme==='proceso') chipInf.classList.add('chip-estado-proceso');
        else chipInf.classList.add('chip-estado-finalizado');
        chipInf.textContent=v.estadoInforme==='finalizado'?'Informe finalizado':(v.estadoInforme==='proceso'?'Informe en proceso':'Sin informe');
        actions.appendChild(chipInf);

        const btnEstado=document.createElement('button');
        btnEstado.className='btn btn-mini';
        btnEstado.textContent='Estado';
        btnEstado.addEventListener('click',()=>{
          if(v.estado==='pendiente') v.estado='anulada';
          else if(v.estado==='anulada') v.estado='realizada';
          else v.estado='pendiente';
          actualizarTodo();
        });
        actions.appendChild(btnEstado);

        const btnInf=document.createElement('button');
        btnInf.className='btn btn-mini';
        btnInf.textContent='Informe';
        btnInf.addEventListener('click',()=>abrirInformeParaVisita(v));
        actions.appendChild(btnInf);

        row.appendChild(actions);
        visitasList.appendChild(row);
      });
    }

    function abrirInformeParaVisita(v){
      visitaEnEdicion=v;
      v.estadoInforme='proceso';
      document.querySelectorAll('.nav-item[data-view-target]').forEach(n=>n.classList.remove('active'));
      document.querySelector('.nav-item[data-view-target="view-informe"]').classList.add('active');
      document.querySelectorAll('.view').forEach(vw=>vw.classList.remove('active'));
      document.getElementById('view-informe').classList.add('active');

      document.getElementById('infCentro').textContent=v.centro;
      document.getElementById('infProvincia').textContent=v.provincia||"-";
      document.getElementById('infDelegado').textContent=v.delegado||"-";
      const tipo=tipoCentro(v.centro);
      document.getElementById('infTipo').textContent=tipo;
      document.getElementById('infRespAudio').textContent=v.respAudio;
      document.getElementById('infFecha').textContent=v.fecha;
      document.getElementById('infAudiologo').value=v.audiologo||"";
      document.getElementById('infHoras').value=v.horas||"";
      document.getElementById('infObservaciones').value=v.observaciones||"";
      document.getElementById('infRecomendaciones').value=v.recomendaciones||"";
      document.getElementById('infCompromisos').value=v.compromisos||"";
      document.getElementById('checklistEstado').textContent=v.checklistAdjunto?"Checklist adjunto":"";

      const aarEstado=getAarEstado(v.centro);
      document.getElementById('cardInformeAAR').style.display=aarEstado==='No'?'none':'flex';

      actualizarGraficasInforme(v.centro, tipo, aarEstado);
      actualizarDashboardCharts();
    }

    // Informes desde tabla
    document.addEventListener('click',e=>{
      if(e.target.matches('.btn-informe-centro')){
        const centro=e.target.dataset.centro;
        const visitasCentro=visitas.filter(v=>v.centro===centro);
        if(visitasCentro.length){
          abrirInformeParaVisita(visitasCentro[0]);
        }else{
          const cont=document.getElementById('informesCentroBody');
          const informes=getInformesCentro(centro);
          cont.innerHTML="";
          const titulo=document.createElement('p');
          titulo.textContent=centro;
          cont.appendChild(titulo);
          if(!informes.length){
            const p=document.createElement('p');
            p.style.fontSize='.8rem';
            p.textContent="No hay informes guardados para este centro.";
            cont.appendChild(p);
          }else{
            informes.forEach((inf,idx)=>{
              const div=document.createElement('div');
              div.className='modal-field';
              div.innerHTML=`<label>Informe ${idx+1}</label><div>${inf}</div>`;
              cont.appendChild(div);
            });
          }
          abrirModal('modalInformesCentro');
        }
      }
    });

    // Charts
    let chartDashRadar=null, chartDashEstados=null, chartDashAAR=null, chartDashRanking=null;
    let chartInformeRadar=null, chartInformeEstados=null, chartInformeDonut=null;

    function actualizarDashboardCharts(){
      const totalCentros=centros.length;
      const numExclusivo=centros.filter(c=>tipoCentro(c.centro)==='Exclusivo').length;
      const numCorner=totalCentros-numExclusivo;
      const aarSi=centros.filter(c=>getAarEstado(c.centro)==='S√≠').length;
      const aarEnForm=centros.filter(c=>getAarEstado(c.centro)==='En formaci√≥n').length;

      const hoy=new Date();
      const mesActual=hoy.getMonth();
      const visitasMes=visitas.filter(v=>new Date(v.fecha).getMonth()===mesActual).length;
      const visitasPend=visitas.filter(v=>v.estado==='pendiente').length;

      const checklistCentros = visitas.filter(v=>v.checklistAdjunto).map(v=>v.centro);
      const numChecklist = new Set(checklistCentros).size;
      const porcChecklist = totalCentros?Math.round((numChecklist/totalCentros)*100):0;

      const totalAAR=aarSi+aarEnForm;
      const porcAAR=totalCentros?Math.round((totalAAR/totalCentros)*100):0;

      document.getElementById('kpiTotalCentros').textContent=totalCentros;
      document.getElementById('kpiExclusivo').textContent=numExclusivo;
      document.getElementById('kpiCorner').textContent=numCorner;
      document.getElementById('kpiVisitasMes').textContent=visitasMes;
      document.getElementById('kpiVisitasPend').textContent=visitasPend;
      document.getElementById('kpiAAR').textContent=`${porcAAR}%`;
      document.getElementById('kpiAARDetalle').textContent=`${aarSi} S√≠ ¬∑ ${aarEnForm} En formaci√≥n`;
      document.getElementById('kpiChecklist').textContent=`${porcChecklist}%`;

      const ctxR=document.getElementById('chartDashRadar').getContext('2d');
      const ctxE=document.getElementById('chartDashEstados').getContext('2d');
      const ctxA=document.getElementById('chartDashAAR').getContext('2d');
      const ctxRank=document.getElementById('chartDashRanking').getContext('2d');

      if(chartDashRadar) chartDashRadar.destroy();
      if(chartDashEstados) chartDashEstados.destroy();
      if(chartDashAAR) chartDashAAR.destroy();
      if(chartDashRanking) chartDashRanking.destroy();

      const procesos=70 + (numExclusivo%20);
      const convPrueba=60 + (visitas.length%25);
      const convCierre=55 + ((visitas.length-visitasPend)%30);
      const hit=80;
      const ayudas=50 + (numCorner%20);
      const aarScore=porcAAR;
      const formaciones=porcChecklist;

      chartDashRadar=new Chart(ctxR,{
        type:'radar',
        data:{
          labels:['Procesos','Conv. prueba','Conv. cierre','HIT','Ayudas','AAR','Formaciones'],
          datasets:[{data:[procesos,convPrueba,convCierre,hit,ayudas,aarScore,formaciones],borderWidth:2,pointRadius:3}]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{r:{beginAtZero:true,max:100,ticks:{display:false}}}
        }
      });

      const pend=visitasPend;
      const real=visitas.filter(v=>v.estado==='realizada').length;
      const anul=visitas.filter(v=>v.estado==='anulada').length;
      chartDashEstados=new Chart(ctxE,{
        type:'bar',
        data:{
          labels:['Pendientes','Realizadas','Anuladas'],
          datasets:[{data:[pend,real,anul]}]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{y:{beginAtZero:true,precision:0}}
        }
      });

      chartDashAAR=new Chart(ctxA,{
        type:'doughnut',
        data:{
          labels:['AAR','No AAR'],
          datasets:[{data:[totalAAR, Math.max(totalCentros-totalAAR,0)],borderWidth:0}]
        },
        options:{
          plugins:{legend:{position:'bottom',labels:{font:{size:10}}}},
          cutout:'60%'
        }
      });

      const delegadoCounts={};
      centros.forEach(c=>{
        delegadoCounts[c.delegado]=(delegadoCounts[c.delegado]||0)+1;
      });
      const entries=Object.entries(delegadoCounts).sort((a,b)=>b[1]-a[1]).slice(0,7);
      const labelsRank=entries.map(e=>e[0]);
      const dataRank=entries.map(e=>e[1]);

      chartDashRanking=new Chart(ctxRank,{
        type:'bar',
        data:{labels:labelsRank,datasets:[{data:dataRank}]},
        options:{
          indexAxis:'y',
          plugins:{legend:{display:false}},
          scales:{x:{beginAtZero:true,precision:0}}
        }
      });
    }

    function actualizarGraficasInforme(centro,tipo,aarEstado){
      const ctxR=document.getElementById('chartInformeRadar').getContext('2d');
      const ctxE=document.getElementById('chartInformeEstados').getContext('2d');
      const ctxD=document.getElementById('chartInformeDonut').getContext('2d');
      if(chartInformeRadar) chartInformeRadar.destroy();
      if(chartInformeEstados) chartInformeEstados.destroy();
      if(chartInformeDonut) chartInformeDonut.destroy();

      const seed=centro.length;
      const procesos=70+(seed%20);
      const convPrueba=60+(seed%25);
      const convCierre=55+(seed%30);
      const hit=80+(seed%10);
      const ayudas=50+(seed%20);
      const aar=aarEstado==='No'?0:60+(seed%25);
      const formaciones=40+(seed%35);

      chartInformeRadar=new Chart(ctxR,{
        type:'radar',
        data:{
          labels:['Procesos','Conv. prueba','Conv. cierre','HIT','Ayudas','AAR','Formaciones'],
          datasets:[{data:[procesos,convPrueba,convCierre,hit,ayudas,aar,formaciones],borderWidth:2,pointRadius:3}]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{r:{beginAtZero:true,max:100,ticks:{display:false}}}
        }
      });

      const visitasCentro=visitas.filter(v=>v.centro===centro);
      const pend=visitasCentro.filter(v=>v.estado==='pendiente').length;
      const real=visitasCentro.filter(v=>v.estado==='realizada').length;
      const anul=visitasCentro.filter(v=>v.estado==='anulada').length;
      chartInformeEstados=new Chart(ctxE,{
        type:'bar',
        data:{labels:['Pendientes','Realizadas','Anuladas'],datasets:[{data:[pend,real,anul]}]},
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,precision:0}}}
      });

      if(aarEstado!=='No'){
        chartInformeDonut=new Chart(ctxD,{
          type:'doughnut',
          data:{labels:['Aplicado','No aplicado'],datasets:[{data:[aar,100-aar],borderWidth:0}]},
          options:{plugins:{legend:{position:'bottom',labels:{font:{size:10}}}},cutout:'60%'}
        });
      }
    }

    // Checklist e informe
    document.getElementById('btnAdjuntarChecklist').addEventListener('click',()=>{
      if(!visitaEnEdicion) return;
      visitaEnEdicion.checklistAdjunto=true;
      document.getElementById('checklistEstado').textContent="Checklist adjunto";
      actualizarDashboardCharts();
    });

    function guardarInformeVisita(){
      if(!visitaEnEdicion) return;
      visitaEnEdicion.audiologo=document.getElementById('infAudiologo').value;
      visitaEnEdicion.horas=document.getElementById('infHoras').value;
      visitaEnEdicion.observaciones=document.getElementById('infObservaciones').value;
      visitaEnEdicion.recomendaciones=document.getElementById('infRecomendaciones').value;
      visitaEnEdicion.compromisos=document.getElementById('infCompromisos').value;
      visitaEnEdicion.estadoInforme='finalizado';

      if(!informesPorCentro[visitaEnEdicion.centro]) informesPorCentro[visitaEnEdicion.centro]=[];
      informesPorCentro[visitaEnEdicion.centro].push(`Informe ${visitaEnEdicion.fecha}`);

      actualizarTodo();
      alert('Informe guardado (demo).');
    }

    document.getElementById('btnGuardarInforme').addEventListener('click',guardarInformeVisita);
    document.getElementById('btnGuardarInformeBottom').addEventListener('click',guardarInformeVisita);

    // Botones superiores
    document.getElementById('btnGuardarVista').addEventListener('click',()=>alert('Guardado de vista (demo).'));
    document.getElementById('btnExportHtml').addEventListener('click',()=>{
      const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download='control_center_audio.html';a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('btnImprimir').addEventListener('click',()=>window.print());
    document.getElementById('btnPrintVisitas').addEventListener('click',()=>window.print());
    document.getElementById('btnSaveVisitas').addEventListener('click',()=>alert('Visitas guardadas (demo).'));
    document.getElementById('btnPrintInforme').addEventListener('click',()=>window.print());

    // Actualizar todo
    function actualizarTodo(){
      renderDelegados();
      renderTablaCentros();
      renderCalendar();
      renderVisitas();
      actualizarDashboardCharts();
    }

    // DEMO inicial
    (function cargaDemoInicial(){
      const demo=[
        {codigo:"4ABB",propietario:"MAZA Oriol",centro:"PAMPLONA C. Exclusivo",provincia:"NAVARRA",delegado:"Sonia Godino"},
        {codigo:"4AFH",propietario:"MAZA Oriol",centro:"PAMPLONA Calle Sancho el Mayor",provincia:"NAVARRA",delegado:"Sonia Godino"},
        {codigo:"4AWQ",propietario:"MAZA Oriol",centro:"PAMPLONA Carlos III",provincia:"NAVARRA",delegado:"Sonia Godino"},
        {codigo:"4MRM",propietario:"AAO",centro:"REINA DE MERCEDES",provincia:"Madrid",delegado:"Sergio Per√°n"},
        {codigo:"4PEC",propietario:"AAO",centro:"SANTANDER CC PE√ëACASTILLO",provincia:"Santander",delegado:"Sergio Per√°n"},
        {codigo:"4AXF",propietario:"URRUTIA Esteban",centro:"SANTIAGO DE COMPOSTELA RUA DA ROSA",provincia:"A Coru√±a",delegado:"Daniel Chazo"},
        {codigo:"4TOL",propietario:"AAO",centro:"TORRELAVEGA CARREFOUR CC",provincia:"Santander",delegado:"Sergio Per√°n"},
        {codigo:"4ZDE",propietario:"AAO",centro:"ZARAGOZA CALLE DELICIAS",provincia:"ZARAGOZA",delegado:"ENERITZ ARANGUREN"},
        {codigo:"4AKI",propietario:"PIEDRAFITA Rocio",centro:"CC LOS VALLES",provincia:"MADRID",delegado:"Blanca Fdez. de la Pradilla"},
        {codigo:"4MLG",propietario:"AAO",centro:"FUENLABRADA Calle Leganes",provincia:"MADRID",delegado:"Marisa Carmona"}
      ];
      demo.forEach(c=>centros.push(c));
      aarPorCentro["REINA DE MERCEDES"]="S√≠";
      aarPorCentro["PAMPLONA C. Exclusivo"]="En formaci√≥n";

      const hoy=new Date();
      const fechaHoy=hoy.toISOString().slice(0,10);
      visitas.push({
        id:nextVisitaId++,
        fecha:fechaHoy,
        centro:"SANTIAGO DE COMPOSTELA RUA DA ROSA",
        provincia:"A Coru√±a",
        delegado:"Daniel Chazo",
        respAudio:"Ariannys Rojas",
        estado:"pendiente",
        estadoInforme:"ninguno",
        observaciones:"",
        recomendaciones:"",
        compromisos:""
      });

      actualizarTodo();
    })();
  </script>
</body>
</html>
